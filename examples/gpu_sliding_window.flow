// gpu_sliding_window.flow — GPU Sliding Window (65536 elements, W=64)
//
// "65536 elements. 64-element moving average. 2 dispatches. 0 CPU iterations."
//
// Computes both sliding sum and moving average in separate dispatches.
// Each thread sums its own window — simple O(N*W) but fully parallel.
//
// Run: octoflow run examples/gpu_sliding_window.flow --allow-ffi --allow-read

let N = 65536.0
let W = 64.0

let vm_sum = loom_boot(1.0, 2.0, N)
let vm_avg = loom_boot(1.0, 2.0, N)
loom_prefetch("tests/gpu_shaders/39_sliding_sum.spv")
loom_prefetch("tests/gpu_shaders/40_sliding_avg.spv")

// ── Input: [1, 1, 1, ..., 1] — sliding sum = min(W, i+1), avg = 1.0 ──
let mut input = []
let mut i = 0.0
while i < N
  push(input, 1.0)
  i = i + 1.0
end
vm_write_register(vm_sum, 0.0, 0.0, input)
vm_write_register(vm_avg, 0.0, 0.0, input)

// Zero output registers
let mut zeros = []
let mut i = 0.0
while i < N
  push(zeros, 0.0)
  i = i + 1.0
end
vm_write_register(vm_sum, 0.0, 1.0, zeros)
vm_write_register(vm_avg, 0.0, 1.0, zeros)

let n_wgs = int((N + 255.0) / 256.0)
let t0 = time()

// Dispatch sliding sum
loom_dispatch(vm_sum, "tests/gpu_shaders/39_sliding_sum.spv", [N, W], n_wgs)
let prog1 = loom_build(vm_sum)
loom_run(prog1)
loom_free(prog1)

// Dispatch moving average
loom_dispatch(vm_avg, "tests/gpu_shaders/40_sliding_avg.spv", [N, W], n_wgs)
let prog2 = loom_build(vm_avg)
loom_run(prog2)
loom_free(prog2)

let t1 = time()
let total_ms = (t1 - t0) * 1000.0

// ── Verify sliding sum ─────────────────────────────────────────────
let sum_result = loom_read(vm_sum, 0.0, 1.0, N)

let mut sum_pass = 1.0
let s0 = sum_result[0]
let s63 = sum_result[63]
let s64 = sum_result[64]
let slast = sum_result[int(N - 1.0)]

if s0 != 1.0
  print("FAIL: sum[0] = {s0}, expected 1")
  sum_pass = 0.0
end
if s63 != 64.0
  print("FAIL: sum[63] = {s63}, expected 64")
  sum_pass = 0.0
end
if s64 != 64.0
  print("FAIL: sum[64] = {s64}, expected 64")
  sum_pass = 0.0
end
if slast != 64.0
  print("FAIL: sum[65535] = {slast}, expected 64")
  sum_pass = 0.0
end

// ── Verify moving average ──────────────────────────────────────────
let avg_result = loom_read(vm_avg, 0.0, 1.0, N)

let mut avg_pass = 1.0
let a0 = avg_result[0]
let a100 = avg_result[100]
let alast = avg_result[int(N - 1.0)]

if a0 != 1.0
  print("FAIL: avg[0] = {a0}, expected 1")
  avg_pass = 0.0
end
if a100 != 1.0
  print("FAIL: avg[100] = {a100}, expected 1")
  avg_pass = 0.0
end
if alast != 1.0
  print("FAIL: avg[65535] = {alast}, expected 1")
  avg_pass = 0.0
end

// Spot check every 1000
let mut i = 0.0
while i < N
  let got = avg_result[int(i)]
  if got != 1.0
    avg_pass = 0.0
  end
  i = i + 1000.0
end

// ── Report ─────────────────────────────────────────────────────────
print("")
print("OctoFlow GPU Sliding Window")
print("  Elements: {N}")
print("  Window size: {W}")
print("  Workgroups: {n_wgs}")
print("  Dispatches: 2 (sliding_sum + moving_avg)")
print("  CPU iterations: 0")
print("  Total time: {total_ms} ms")
print("")
print("  Sliding sum (all-ones input):")
print("    sum[0] = {s0} (expected 1)")
print("    sum[63] = {s63} (expected 64)")
print("    sum[64] = {s64} (expected 64)")
print("    sum[65535] = {slast} (expected 64)")

print("  Moving average (all-ones input):")
print("    avg[0] = {a0} (expected 1)")
print("    avg[100] = {a100} (expected 1)")
print("    avg[65535] = {alast} (expected 1)")

if sum_pass == 1.0
  if avg_pass == 1.0
    print("  PASS: {N}-element sliding window (W={W}) BIT EXACT")
  else
    print("  FAIL: moving average failed")
  end
else
  print("  FAIL: sliding sum failed")
end

print("")
loom_shutdown(vm_sum)
loom_shutdown(vm_avg)
