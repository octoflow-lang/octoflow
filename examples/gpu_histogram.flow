// gpu_histogram.flow — GPU Histogram (65536 elements, 16 bins)
//
// "65536 elements. 16 bins. 2 dispatches. 0 CPU iterations."
//
// Shared-memory atomic histogram: each workgroup bins locally,
// then atomically accumulates into global output.
//
// Run: octoflow run examples/gpu_histogram.flow --allow-ffi --allow-read

let N = 65536.0
let NBINS = 16.0
let MIN_VAL = 0.0
let BIN_WIDTH = 4096.0

let vm_hist = loom_boot(1.0, 2.0, N)
let vm_conv = loom_boot(1.0, 2.0, NBINS)
loom_prefetch("tests/gpu_shaders/34_histogram.spv")
loom_prefetch("tests/gpu_shaders/35_uint_to_float.spv")

// ── Input: [0, 1, 2, ..., 65535] — each of 16 bins should get 4096 ──
let mut input = []
let mut i = 0.0
while i < N
  push(input, i)
  i = i + 1.0
end
vm_write_register(vm_hist, 0.0, 0.0, input)

// Zero the histogram output register
let mut zeros = []
let mut i = 0.0
while i < N
  push(zeros, 0.0)
  i = i + 1.0
end
vm_write_register(vm_hist, 0.0, 1.0, zeros)

// ── Dispatch histogram ──────────────────────────────────────────────
let n_wgs = int((N + 255.0) / 256.0)
let t0 = time()

loom_dispatch(vm_hist, "tests/gpu_shaders/34_histogram.spv", [N, NBINS, MIN_VAL, BIN_WIDTH], n_wgs)
let prog1 = loom_build(vm_hist)
loom_run(prog1)
loom_free(prog1)

// Read histogram uint results and convert via second VM
let hist_raw = loom_read(vm_hist, 0.0, 1.0, NBINS)
vm_write_register(vm_conv, 0.0, 0.0, hist_raw)

let mut zeros_small = []
let mut i = 0.0
while i < NBINS
  push(zeros_small, 0.0)
  i = i + 1.0
end
vm_write_register(vm_conv, 0.0, 1.0, zeros_small)

loom_dispatch(vm_conv, "tests/gpu_shaders/35_uint_to_float.spv", [NBINS], 1.0)
let prog2 = loom_build(vm_conv)
loom_run(prog2)
loom_free(prog2)

let t1 = time()
let total_ms = (t1 - t0) * 1000.0

// ── Verify ─────────────────────────────────────────────────────────
let result = loom_read(vm_conv, 0.0, 1.0, NBINS)

let mut pass = 1.0
let mut i = 0.0
while i < NBINS
  let got = result[int(i)]
  if got != 4096.0
    print("FAIL: bin {i} = {got}, expected 4096")
    pass = 0.0
  end
  i = i + 1.0
end

// Extract boundary bins for display
let first = result[0]
let mid = result[7]
let last = result[15]

// ── Report ─────────────────────────────────────────────────────────
print("")
print("OctoFlow GPU Histogram")
print("  Elements: {N}")
print("  Bins: {NBINS}")
print("  Bin width: {BIN_WIDTH}")
print("  Workgroups: {n_wgs}")
print("  Dispatches: 2 (histogram + uint_to_float)")
print("  CPU element iterations: 0")
print("  Total time: {total_ms} ms")
print("")
print("  Bin counts (expected: all 4096):")
print("    bin[0]  = {first}")
print("    bin[7]  = {mid}")
print("    bin[15] = {last}")

if pass == 1.0
  print("  PASS: {N}-element histogram BIT EXACT (all {NBINS} bins = 4096)")
else
  print("  FAIL: some bins incorrect")
end

print("")
loom_shutdown(vm_hist)
loom_shutdown(vm_conv)
