// gpu_nbody.flow — GPU N-body Gravitational Simulation
//
// "4096 particles. 100 timesteps. 1 dispatch per step. 0 CPU force calculations."
//
// All-pairs gravitational N-body with shared-memory tiling.
// Each thread computes total force on one particle from all 4096 others.
// Leapfrog integration. Uses pre-compiled 27_nbody.spv kernel.
//
// Run: octoflow run examples/gpu_nbody.flow --allow-ffi --allow-read

let N = 4096.0
let STEPS = 100.0
let DT = 0.0001
let SOFT = 0.1

// Boot Loom VM: 1 instance, 2 registers (input + output), N*4 floats
let vm = loom_boot(1.0, 2.0, N * 4.0)
loom_prefetch("tests/gpu_shaders/27_nbody.spv")

// ── Initialize particles in a disk ───────────────────────────────────
let mut state = []
let mut i = 0.0
while i < N
  let hx = i * 7.0 + 13.0
  let hx2 = hx - floor(hx / 97.0) * 97.0
  let x = (hx2 / 97.0 - 0.5) * 20.0

  let hy = i * 11.0 + 29.0
  let hy2 = hy - floor(hy / 89.0) * 89.0
  let y = (hy2 / 89.0 - 0.5) * 20.0

  let r = sqrt(x * x + y * y + 0.01)
  let vx = y / r * 0.5
  let vy = 0.0 - x / r * 0.5

  push(state, x)
  push(state, y)
  push(state, vx)
  push(state, vy)
  i = i + 1.0
end

// Upload initial state to register 0 (binding 0 = input)
vm_write_register(vm, 0.0, 0.0, state)

// Zero register 1 (binding 1 = output)
let mut zeros = []
let mut i = 0.0
while i < N * 4.0
  push(zeros, 0.0)
  i = i + 1.0
end
vm_write_register(vm, 0.0, 1.0, zeros)

// ── Record initial center of mass ────────────────────────────────────
let mut cx0 = 0.0
let mut cy0 = 0.0
let mut i = 0.0
while i < N
  cx0 = cx0 + state[int(i * 4.0)]
  cy0 = cy0 + state[int(i * 4.0 + 1.0)]
  i = i + 1.0
end
cx0 = cx0 / N
cy0 = cy0 / N

// ── Simulate: 100 steps ──────────────────────────────────────────────
let WGS = N / 256.0
let t0 = time()

let mut step = 0.0
while step < STEPS
  // Dispatch: kernel reads binding 0, writes binding 1
  loom_dispatch(vm, "tests/gpu_shaders/27_nbody.spv", [N, DT, SOFT], WGS)
  let prog = loom_build(vm)
  loom_run(prog)
  loom_free(prog)

  // Swap: read output (register 1), write back to input (register 0)
  let result = loom_read(vm, 0.0, 1.0, N * 4.0)
  vm_write_register(vm, 0.0, 0.0, result)

  step = step + 1.0
end

let t1 = time()
let total_ms = (t1 - t0) * 1000.0

// ── Download final state ─────────────────────────────────────────────
let final_state = loom_read(vm, 0.0, 0.0, N * 4.0)

let mut cx1 = 0.0
let mut cy1 = 0.0
let mut i = 0.0
while i < N
  cx1 = cx1 + final_state[int(i * 4.0)]
  cy1 = cy1 + final_state[int(i * 4.0 + 1.0)]
  i = i + 1.0
end
cx1 = cx1 / N
cy1 = cy1 / N

let com_drift_x = abs(cx1 - cx0)
let com_drift_y = abs(cy1 - cy0)

let p0_x = final_state[0]
let p0_y = final_state[1]
let p100_x = final_state[400]
let p100_y = final_state[401]
let p1000_x = final_state[4000]
let p1000_y = final_state[4001]

let mut bounded = 1.0
let mut i = 0.0
while i < N
  let x = final_state[int(i * 4.0)]
  let y = final_state[int(i * 4.0 + 1.0)]
  if abs(x) > 1000.0
    bounded = 0.0
  end
  if abs(y) > 1000.0
    bounded = 0.0
  end
  i = i + 1.0
end

let interactions = N * N * STEPS
let interactions_per_ms = interactions / total_ms

// ── Report ───────────────────────────────────────────────────────────
print("")
print("OctoFlow GPU N-body Simulation")
print("  Particles: {N}")
print("  Timesteps: {STEPS}")
print("  dt: {DT}")
print("  Softening: {SOFT}")
print("  Dispatches: {STEPS} (1 per step)")
print("  CPU force calculations: 0")
print("  Total time: {total_ms} ms")
print("  Interactions: {interactions}")
print("  Interactions/ms: {interactions_per_ms}")
print("")
print("  Initial CoM: ({cx0}, {cy0})")
print("  Final CoM:   ({cx1}, {cy1})")
print("  CoM drift: ({com_drift_x}, {com_drift_y})")
print("")
print("  Sample particles (final):")
print("    P[0]:    ({p0_x}, {p0_y})")
print("    P[100]:  ({p100_x}, {p100_y})")
print("    P[1000]: ({p1000_x}, {p1000_y})")
print("  All bounded: {bounded}")

let com_tol = 0.01
if com_drift_x < com_tol
  if com_drift_y < com_tol
    if bounded == 1.0
      print("  PASS: {N} particles, {STEPS} steps, CoM conserved, all bounded")
    else
      print("  FAIL: particles escaped bounds")
    end
  else
    print("  FAIL: CoM Y drifted by {com_drift_y}")
  end
else
  print("  FAIL: CoM X drifted by {com_drift_x}")
end

print("")
loom_shutdown(vm)
