// gpu_bitonic_sort.flow — GPU Bitonic Sort (65536 elements)
//
// "65536 elements. 136 dispatches. Fully sorted. 0 CPU comparisons."
//
// Bitonic merge sort network: O(log²N) dispatches of compare-and-swap.
// Each dispatch: every thread XORs its index with substep to find partner,
// compares, and swaps if needed. Alternating ascending/descending halves
// merge into a fully sorted array.
//
// Run: octoflow run examples/gpu_bitonic_sort.flow --allow-ffi --allow-read

use "../stdlib/loom/ops/runtime"

let N = 65536.0

rt_init()

let pipe_sort = rt_load_pipeline("tests/gpu_shaders/36_bitonic_sort.spv", 1.0, 12.0)

// ── Input: reverse sorted [65536, 65535, ..., 2, 1] ────────────────
let mut input = []
let mut i = 0.0
while i < N
  push(input, N - i)
  i = i + 1.0
end

let buf = rt_create_buffer(N * 4.0)
rt_upload(buf, input)

let n_wgs = int((N + 255.0) / 256.0)

// ── Bitonic sort network ───────────────────────────────────────────
let t0 = time()
let mut dispatches = 0.0

let mut k = 2.0
while k <= N
  let mut j = k / 2.0
  while j >= 1.0
    rt_chain_begin(1.0, 1.0)
    let mut pc = [k, j, N]
    rt_chain_push_constants(pipe_sort, pc)
    let mut bufs = [buf]
    rt_chain_dispatch(pipe_sort, bufs, n_wgs)
    rt_chain_end()
    rt_chain_submit_wait()
    dispatches = dispatches + 1.0
    j = j / 2.0
  end
  k = k * 2.0
end

let t1 = time()
let total_ms = (t1 - t0) * 1000.0

// ── Verify ─────────────────────────────────────────────────────────
rt_download(buf, N)

let mut pass = 1.0

// Check first, last, and boundaries
let v0 = rt_result[0]
let v1 = rt_result[1]
let vmid = rt_result[32767]
let vlast = rt_result[int(N - 1.0)]

if v0 != 1.0
  print("FAIL: result[0] = {v0}, expected 1")
  pass = 0.0
end
if v1 != 2.0
  print("FAIL: result[1] = {v1}, expected 2")
  pass = 0.0
end
if vlast != N
  print("FAIL: result[{N}-1] = {vlast}, expected {N}")
  pass = 0.0
end

// Spot check every 1000th element
let mut spot_pass = 1.0
let mut i = 0.0
while i < N
  let got = rt_result[int(i)]
  let exp = i + 1.0
  if got != exp
    spot_pass = 0.0
  end
  i = i + 1000.0
end

// ── Report ─────────────────────────────────────────────────────────
print("")
print("OctoFlow GPU Bitonic Sort")
print("  Elements: {N}")
print("  Dispatches: {dispatches}")
print("  Workgroups per dispatch: {n_wgs}")
print("  CPU comparisons: 0")
print("  Total time: {total_ms} ms")
print("")
print("  Verification:")
print("    sorted[0] = {v0} (expected 1)")
print("    sorted[1] = {v1} (expected 2)")
print("    sorted[32767] = {vmid} (expected 32768)")
print("    sorted[65535] = {vlast} (expected 65536)")
print("    Spot check (every 1000): {spot_pass}")

if pass == 1.0
  if spot_pass == 1.0
    print("  PASS: {N}-element bitonic sort BIT EXACT")
  else
    print("  FAIL: spot check failed")
  end
else
  print("  FAIL: boundary check failed")
end

print("")
rt_cleanup()
