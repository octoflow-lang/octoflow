// gpu_bitonic_sort.flow — GPU Bitonic Sort (65536 elements)
//
// "65536 elements. 136 dispatches. Fully sorted. 0 CPU comparisons."
//
// Bitonic merge sort network: O(log^2 N) dispatches of compare-and-swap.
// Each dispatch: every thread XORs its index with substep to find partner,
// compares, and swaps if needed. Alternating ascending/descending halves
// merge into a fully sorted array.
//
// Run: octoflow run examples/gpu_bitonic_sort.flow --allow-ffi --allow-read

let N = 65536.0

let vm = loom_boot(1.0, 1.0, N)
loom_prefetch("tests/gpu_shaders/36_bitonic_sort.spv")

// ── Input: reverse sorted [65536, 65535, ..., 2, 1] ────────────────
let mut input = []
let mut i = 0.0
while i < N
  push(input, N - i)
  i = i + 1.0
end
vm_write_register(vm, 0.0, 0.0, input)

let n_wgs = int((N + 255.0) / 256.0)

// ── Bitonic sort network ───────────────────────────────────────────
let t0 = time()
let mut dispatches = 0.0

let mut k = 2.0
while k <= N
  let mut j = k / 2.0
  while j >= 1.0
    loom_dispatch(vm, "tests/gpu_shaders/36_bitonic_sort.spv", [k, j, N], n_wgs)
    let prog = loom_build(vm)
    loom_run(prog)
    loom_free(prog)
    dispatches = dispatches + 1.0
    j = j / 2.0
  end
  k = k * 2.0
end

let t1 = time()
let total_ms = (t1 - t0) * 1000.0

// ── Verify ─────────────────────────────────────────────────────────
let result = loom_read(vm, 0.0, 0.0, N)

let mut pass = 1.0

let v0 = result[0]
let v1 = result[1]
let vmid = result[32767]
let vlast = result[int(N - 1.0)]

if v0 != 1.0
  print("FAIL: result[0] = {v0}, expected 1")
  pass = 0.0
end
if v1 != 2.0
  print("FAIL: result[1] = {v1}, expected 2")
  pass = 0.0
end
if vlast != N
  print("FAIL: result[{N}-1] = {vlast}, expected {N}")
  pass = 0.0
end

// Spot check every 1000th element
let mut spot_pass = 1.0
let mut i = 0.0
while i < N
  let got = result[int(i)]
  let exp = i + 1.0
  if got != exp
    spot_pass = 0.0
  end
  i = i + 1000.0
end

// ── Report ─────────────────────────────────────────────────────────
print("")
print("OctoFlow GPU Bitonic Sort")
print("  Elements: {N}")
print("  Dispatches: {dispatches}")
print("  Workgroups per dispatch: {n_wgs}")
print("  CPU comparisons: 0")
print("  Total time: {total_ms} ms")
print("")
print("  Verification:")
print("    sorted[0] = {v0} (expected 1)")
print("    sorted[1] = {v1} (expected 2)")
print("    sorted[32767] = {vmid} (expected 32768)")
print("    sorted[65535] = {vlast} (expected 65536)")
print("    Spot check (every 1000): {spot_pass}")

if pass == 1.0
  if spot_pass == 1.0
    print("  PASS: {N}-element bitonic sort BIT EXACT")
  else
    print("  FAIL: spot check failed")
  end
else
  print("  FAIL: boundary check failed")
end

print("")
loom_shutdown(vm)
