// gpu_bfs.flow — GPU Breadth-First Search on a Grid Graph
//
// "BFS as frontier expansion. 1 dispatch per level. 0 CPU vertex iterations."
//
// Graph: 64x64 grid (4096 vertices), each connected to 4 neighbors.
// BFS from vertex 0 (top-left corner).
// Expected max distance = 126 (Manhattan distance to bottom-right = 63+63).
//
// CSR format. Multi-dispatch: 1 dispatch per BFS level.
//
// Run: octoflow run examples/gpu_bfs.flow --allow-ffi --allow-read

let GRID = 64.0
let N = GRID * GRID
let PAD = 4096.0

// ── Build CSR for 64x64 grid ─────────────────────────────────────────
let mut csr_offsets = []
let mut csr_edges = []
let mut edge_count = 0.0

let mut v = 0.0
while v < N
  push(csr_offsets, edge_count)
  let r = floor(v / GRID)
  let c = v - r * GRID

  if r > 0.0
    push(csr_edges, (r - 1.0) * GRID + c)
    edge_count = edge_count + 1.0
  end
  if r < GRID - 1.0
    push(csr_edges, (r + 1.0) * GRID + c)
    edge_count = edge_count + 1.0
  end
  if c > 0.0
    push(csr_edges, r * GRID + c - 1.0)
    edge_count = edge_count + 1.0
  end
  if c < GRID - 1.0
    push(csr_edges, r * GRID + c + 1.0)
    edge_count = edge_count + 1.0
  end

  v = v + 1.0
end
push(csr_offsets, edge_count)

// ── Boot VM: 5 bindings (offsets, edges, frontier, next, visited) ────
let vm = loom_boot(1.0, 5.0, N + 1.0 + edge_count)
loom_prefetch("tests/gpu_shaders/25_bfs_expand.spv")

vm_write_register(vm, 0.0, 0.0, csr_offsets)
vm_write_register(vm, 0.0, 1.0, csr_edges)

// Initialize frontier: vertex 0 = 1.0, rest = 0.0
let mut frontier = []
let mut i = 0.0
while i < PAD
  if i == 0.0
    push(frontier, 1.0)
  else
    push(frontier, 0.0)
  end
  i = i + 1.0
end
vm_write_register(vm, 0.0, 2.0, frontier)

let mut zeros = []
let mut i = 0.0
while i < PAD
  push(zeros, 0.0)
  i = i + 1.0
end
vm_write_register(vm, 0.0, 3.0, zeros)
vm_write_register(vm, 0.0, 4.0, zeros)

// ── BFS loop ─────────────────────────────────────────────────────────
let WGS = PAD / 256.0
let t0 = time()
let mut level = 1.0
let mut total_dispatches = 0.0

while level < 200.0
  loom_dispatch(vm, "tests/gpu_shaders/25_bfs_expand.spv", [level], WGS)
  let prog = loom_build(vm)
  loom_run(prog)
  loom_free(prog)
  total_dispatches = total_dispatches + 1.0

  // Check if next frontier has any active vertices
  let next = loom_read(vm, 0.0, 3.0, N)
  let mut has_next = 0.0
  let mut i = 0.0
  while i < N
    if next[int(i)] == 1.0
      has_next = 1.0
    end
    i = i + 1.0
  end

  if has_next == 0.0
    level = 999.0
  else
    // Swap frontier <- next, clear next
    vm_write_register(vm, 0.0, 2.0, next)
    vm_write_register(vm, 0.0, 3.0, zeros)
    level = level + 1.0
  end
end

let t1 = time()
let total_ms = (t1 - t0) * 1000.0

// ── Download and verify ──────────────────────────────────────────────
let visited = loom_read(vm, 0.0, 4.0, N)

let mut max_level = 0.0
let mut visited_count = 0.0
let mut i = 0.0
while i < N
  let lv = visited[int(i)]
  if lv > max_level
    max_level = lv
  end
  if lv > 0.0
    visited_count = visited_count + 1.0
  end
  i = i + 1.0
end

let v_00 = visited[0]
let v_063 = visited[63]
let v_630 = visited[4032]
let v_6363 = visited[4095]

let exp_00 = 1.0
let exp_063 = 64.0
let exp_630 = 64.0
let exp_6363 = 127.0

let mut pass = 1.0
if v_00 != exp_00
  print("FAIL: vertex(0,0)={v_00} expected={exp_00}")
  pass = 0.0
end
if v_063 != exp_063
  print("FAIL: vertex(0,63)={v_063} expected={exp_063}")
  pass = 0.0
end
if v_630 != exp_630
  print("FAIL: vertex(63,0)={v_630} expected={exp_630}")
  pass = 0.0
end
if v_6363 != exp_6363
  print("FAIL: vertex(63,63)={v_6363} expected={exp_6363}")
  pass = 0.0
end
if visited_count != N
  print("FAIL: visited {visited_count}/{N} vertices")
  pass = 0.0
end

// ── Report ───────────────────────────────────────────────────────────
print("")
print("OctoFlow GPU Breadth-First Search")
print("  Graph: {GRID}x{GRID} grid ({N} vertices, {edge_count} edges)")
print("  BFS source: vertex 0 (top-left)")
print("  Max BFS level: {max_level}")
print("  Vertices visited: {visited_count}/{N}")
print("  BFS levels (dispatches): {total_dispatches}")
print("  CPU vertex iterations: 0")
print("  Total time: {total_ms} ms")
print("")
print("  Corner verification:")
print("    (0,0)   -> level {v_00} (expected {exp_00})")
print("    (0,63)  -> level {v_063} (expected {exp_063})")
print("    (63,0)  -> level {v_630} (expected {exp_630})")
print("    (63,63) -> level {v_6363} (expected {exp_6363})")

if pass == 1.0
  print("  PASS: all {N} vertices reached, corner distances BIT EXACT")
else
  print("  FAIL")
end

print("")
loom_shutdown(vm)
