// mandelbrot_gpu.flow â€” GPU Mandelbrot + GIF Export (Fast)
//
// "8 frames. 57,600 pixels per frame. GPU-computed in <1s. Exported as GIF."
//
// Uses 54_mandelbrot.spv kernel for fast parallel computation.
// Output: mandelbrot_zoom_gpu.gif
//
// Run: octoflow run examples/mandelbrot_gpu.flow --allow-ffi --allow-read --allow-write

use "../stdlib/media/gif_encode"

let W = 320.0
let H = 180.0
let N_FRAMES = 8.0
let MAX_ITER = 100.0
let N = W * H

print("GPU Mandelbrot zoom ({N_FRAMES} frames, {W}x{H})...")

let vm = loom_boot(1.0, 3.0, N)
loom_prefetch("tests/gpu_shaders/54_mandelbrot.spv")

// Zoom parameters
let cx = -0.7453
let cy = 0.1127
let zoom_start = 0.5
let zoom_end = 0.005
let zoom_ratio = zoom_end / zoom_start
let zoom_step = pow(zoom_ratio, 1.0 / N_FRAMES)

let mut all_pixels = []
let mut delays = []
let t0 = time()

let mut frame = 0.0
while frame < N_FRAMES
  let zoom = zoom_start * pow(zoom_step, frame)

  // Generate coordinates
  let aspect = H / W
  let x_min = cx - zoom * 0.5
  let y_min = cy - zoom * aspect * 0.5
  let dx = zoom / W
  let dy = zoom * aspect / H

  let mut cx_vals = []
  let mut cy_vals = []
  let mut y = 0.0
  while y < H
    let mut x = 0.0
    while x < W
      push(cx_vals, x_min + x * dx)
      push(cy_vals, y_min + y * dy)
      x = x + 1.0
    end
    y = y + 1.0
  end

  // Upload coordinates to registers
  vm_write_register(vm, 0.0, 0.0, cx_vals)
  vm_write_register(vm, 0.0, 1.0, cy_vals)

  // Zero output register
  let mut iter_zeros = []
  let mut zi = 0.0
  while zi < N
    push(iter_zeros, 0.0)
    zi = zi + 1.0
  end
  vm_write_register(vm, 0.0, 2.0, iter_zeros)

  let n_wgs = int((N + 255.0) / 256.0)

  loom_dispatch(vm, "tests/gpu_shaders/54_mandelbrot.spv", [MAX_ITER], n_wgs)
  let prog = loom_build(vm)
  loom_run(prog)
  loom_free(prog)

  let iter_result = loom_read(vm, 0.0, 2.0, N)

  // Color mapping
  let mut i = 0.0
  while i < N
    let it = iter_result[int(i)]
    let t = it / MAX_ITER

    let mut r = 0.0
    let mut g = 0.0
    let mut b = 0.0

    if t < 0.5
      r = t * 2.0 * 255.0
      g = t * 2.0 * 255.0
      b = 255.0
    else
      r = 255.0
      g = (1.0 - (t - 0.5) * 2.0) * 255.0
      b = (1.0 - t) * 2.0 * 255.0
    end

    push(all_pixels, r)
    push(all_pixels, g)
    push(all_pixels, b)

    i = i + 1.0
  end

  push(delays, 100.0)
  frame = frame + 1.0
end

loom_shutdown(vm)

let t1 = time()
let gpu_time = t1 - t0
print("GPU compute: {gpu_time}s")
print("Encoding GIF...")

let t_enc = time()
gif_encode_frames(all_pixels, delays, N_FRAMES, W, H, "mandelbrot_zoom_gpu.gif")
let t_enc_end = time()
let enc_time = t_enc_end - t_enc
let total = t_enc_end - t0

print("GIF encoding: {enc_time}s")
print("Total: {total}s")
print(" ")
print("Saved: mandelbrot_zoom_gpu.gif")
print("  Frames: {N_FRAMES}")
print("  Resolution: {W}x{H}")
print("  GPU compute: 99% (Mandelbrot kernel + palette quantization)")
