// gpu_argminmax.flow — GPU Argmin/Argmax (65536 elements, 2-pass reduction)
//
// "65536 elements. Find min and max with indices. 4 dispatches. 0 CPU comparisons."
//
// Multi-pass reduction: Pass 1 reduces 65536→256 partial results,
// Pass 2 reduces 256→1. Tracks both value and index.
//
// Run: octoflow run examples/gpu_argminmax.flow --allow-ffi --allow-read

let N = 65536.0

// ── Input: [N, N-1, ..., 2, 1] — min=1.0 at index N-1, max=N at index 0 ──
let mut input = []
let mut i = 0.0
while i < N
  push(input, N - i)
  i = i + 1.0
end

let n_wgs1 = int((N + 255.0) / 256.0)
let n_wgs2 = 1.0

// ── Pass 1: Reduce 65536 → 256 partial results ────────────────────
// Argmin: 3 bindings (input, val_out, idx_out), push constant = N
let vm_min1 = loom_boot(1.0, 3.0, N)
let vm_max1 = loom_boot(1.0, 3.0, N)
loom_prefetch("tests/gpu_shaders/37_argmin.spv")
loom_prefetch("tests/gpu_shaders/38_argmax.spv")

vm_write_register(vm_min1, 0.0, 0.0, input)
vm_write_register(vm_max1, 0.0, 0.0, input)

// Zero output registers
let mut zeros_wgs = []
let mut i = 0.0
while i < N
  push(zeros_wgs, 0.0)
  i = i + 1.0
end
vm_write_register(vm_min1, 0.0, 1.0, zeros_wgs)
vm_write_register(vm_min1, 0.0, 2.0, zeros_wgs)
vm_write_register(vm_max1, 0.0, 1.0, zeros_wgs)
vm_write_register(vm_max1, 0.0, 2.0, zeros_wgs)

let t0 = time()

loom_dispatch(vm_min1, "tests/gpu_shaders/37_argmin.spv", [N], n_wgs1)
let prog_min1 = loom_build(vm_min1)
loom_run(prog_min1)
loom_free(prog_min1)

loom_dispatch(vm_max1, "tests/gpu_shaders/38_argmax.spv", [N], n_wgs1)
let prog_max1 = loom_build(vm_max1)
loom_run(prog_max1)
loom_free(prog_max1)

// Read partial results from pass 1
let min_val1 = loom_read(vm_min1, 0.0, 1.0, n_wgs1)
let min_idx1 = loom_read(vm_min1, 0.0, 2.0, n_wgs1)
let max_val1 = loom_read(vm_max1, 0.0, 1.0, n_wgs1)
let max_idx1 = loom_read(vm_max1, 0.0, 2.0, n_wgs1)

// ── Pass 2: Reduce 256 → 1 final result ───────────────────────────
let vm_min2 = loom_boot(1.0, 3.0, n_wgs1)
let vm_max2 = loom_boot(1.0, 3.0, n_wgs1)

vm_write_register(vm_min2, 0.0, 0.0, min_val1)
vm_write_register(vm_max2, 0.0, 0.0, max_val1)

let mut zeros_small = []
let mut i = 0.0
while i < n_wgs1
  push(zeros_small, 0.0)
  i = i + 1.0
end
vm_write_register(vm_min2, 0.0, 1.0, zeros_small)
vm_write_register(vm_min2, 0.0, 2.0, zeros_small)
vm_write_register(vm_max2, 0.0, 1.0, zeros_small)
vm_write_register(vm_max2, 0.0, 2.0, zeros_small)

loom_dispatch(vm_min2, "tests/gpu_shaders/37_argmin.spv", [n_wgs1], n_wgs2)
let prog_min2 = loom_build(vm_min2)
loom_run(prog_min2)
loom_free(prog_min2)

loom_dispatch(vm_max2, "tests/gpu_shaders/38_argmax.spv", [n_wgs1], n_wgs2)
let prog_max2 = loom_build(vm_max2)
loom_run(prog_max2)
loom_free(prog_max2)

let t1 = time()
let total_ms = (t1 - t0) * 1000.0

// ── Download results ───────────────────────────────────────────────
let min_val_result = loom_read(vm_min2, 0.0, 1.0, 1.0)
let min_val = min_val_result[0]
let min_idx_result = loom_read(vm_min2, 0.0, 2.0, 1.0)
let min_idx_raw = min_idx_result[0]

let max_val_result = loom_read(vm_max2, 0.0, 1.0, 1.0)
let max_val = max_val_result[0]
let max_idx_result = loom_read(vm_max2, 0.0, 2.0, 1.0)
let max_idx_raw = max_idx_result[0]

// Pass 2 index is within the 256 partials. Look up original index.
let min_idx = min_idx1[int(min_idx_raw)]
let max_idx = max_idx1[int(max_idx_raw)]

// ── Verify ─────────────────────────────────────────────────────────
let mut pass = 1.0
let exp_min_val = 1.0
let exp_min_idx = N - 1.0
let exp_max_val = N
let exp_max_idx = 0.0

if min_val != exp_min_val
  print("FAIL: min_val={min_val}, expected {exp_min_val}")
  pass = 0.0
end
if min_idx != exp_min_idx
  print("FAIL: min_idx={min_idx}, expected {exp_min_idx}")
  pass = 0.0
end
if max_val != exp_max_val
  print("FAIL: max_val={max_val}, expected {exp_max_val}")
  pass = 0.0
end
if max_idx != exp_max_idx
  print("FAIL: max_idx={max_idx}, expected {exp_max_idx}")
  pass = 0.0
end

// ── Report ─────────────────────────────────────────────────────────
print("")
print("OctoFlow GPU Argmin/Argmax")
print("  Elements: {N}")
print("  Passes: 2 (65536 -> 256 -> 1)")
print("  Dispatches: 4 (2x argmin + 2x argmax)")
print("  CPU comparisons: 0")
print("  Total time: {total_ms} ms")
print("")
print("  Results:")
print("    min_value = {min_val} at index {min_idx}")
print("    max_value = {max_val} at index {max_idx}")

if pass == 1.0
  print("  PASS: {N}-element argmin/argmax BIT EXACT")
else
  print("  FAIL: see errors above")
end

print("")
loom_shutdown(vm_min1)
loom_shutdown(vm_max1)
loom_shutdown(vm_min2)
loom_shutdown(vm_max2)
