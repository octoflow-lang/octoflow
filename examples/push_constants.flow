// push_constants.flow — Dynamic Shader Parameters: Push Constants Demo
//
// Passes a scale factor to the GPU shader via push constants.
// Push constants live in the command buffer — zero buffer allocation,
// zero descriptor binding, zero memory mapping. Up to 128 bytes of
// parameters passed directly to the shader.
//
// This is how every real GPU workload parameterizes shaders:
// element counts, strides, thresholds, iteration limits, matrix dimensions.
//
// Architecture:
//   CPU: records push constant value into command buffer
//   GPU: reads push constant directly (no buffer indirection)
//   Cost: 0 allocations, 0 descriptors, 0 memory maps
//
// Run: octoflow run examples/push_constants.flow --allow-ffi --allow-read

let N = 256.0
let SCALE = 7.0

// Boot GPU
let vm = loom_boot(1.0, 2.0, N)
loom_prefetch("tests/gpu_shaders/13_scale.spv")

// Upload data: [1, 2, 3, ..., 256]
let mut data = []
let mut i = 0.0
while i < N
  push(data, i + 1.0)
  i = i + 1.0
end
vm_write_register(vm, 0.0, 0.0, data)

// Zero output register
let mut zeros = []
let mut i = 0.0
while i < N
  push(zeros, 0.0)
  i = i + 1.0
end
vm_write_register(vm, 0.0, 1.0, zeros)

// ── Record + submit ──────────────────────────────────────────────────
let t0 = time()

loom_dispatch(vm, "tests/gpu_shaders/13_scale.spv", [SCALE], 1.0)
let prog = loom_build(vm)

let t1 = time()
let record_ms = (t1 - t0) * 1000.0

let t2 = time()
loom_run(prog)
let t3 = time()
let gpu_ms = (t3 - t2) * 1000.0
loom_free(prog)

// ── Verify result (bit-exact) ────────────────────────────────────────
let result = loom_read(vm, 0.0, 1.0, 4.0)

let expected_0 = 1.0 * SCALE
let expected_1 = 2.0 * SCALE
let expected_2 = 3.0 * SCALE
let expected_3 = 4.0 * SCALE

let v0 = result[0]
let v1 = result[1]
let v2 = result[2]
let v3 = result[3]

print("")
print("OctoFlow Push Constants Demo")
print("  Shader: 13_scale.spv (output[i] = input[i] * scale)")
print("  Push constant: scale = {SCALE}")
print("  Elements: {N}")
print("  Buffer allocations for parameter: 0")
print("  Descriptor bindings for parameter: 0")
print("  Record time: {record_ms} ms")
print("  GPU time:    {gpu_ms} ms")
print("  Result[0..3]: [{v0}, {v1}, {v2}, {v3}]")
print("  Expected:     [{expected_0}, {expected_1}, {expected_2}, {expected_3}]")

if v0 == expected_0
  if v1 == expected_1
    if v2 == expected_2
      if v3 == expected_3
        print("  EXACT MATCH")
      else
        print("  MISMATCH: v3 got {v3}, expected {expected_3}")
      end
    else
      print("  MISMATCH: v2 got {v2}, expected {expected_2}")
    end
  else
    print("  MISMATCH: v1 got {v1}, expected {expected_1}")
  end
else
  print("  MISMATCH: v0 got {v0}, expected {expected_0}")
end

print("")
loom_shutdown(vm)
