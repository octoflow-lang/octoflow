// timeline_semaphore.flow — GPU Sequential Doubling (Loom API)
//
// 30 sequential GPU doublings via the Loom VM.
// 3 phases of 10 doublings each, all using ping-pong pattern.
//
// Verification is BIT-EXACT: 30 doublings of [1..256] = [2^30, 2*2^30, ...].
// Powers of 2 — zero floating-point ambiguity.
//
// Run: octoflow run examples/timeline_semaphore.flow --allow-ffi --allow-read

let N = 256.0
let DOUBLINGS = 10.0
let TOTAL_DOUBLINGS = 30.0

// Boot GPU
let vm = loom_boot(1.0, 2.0, N)
loom_prefetch("tests/gpu_shaders/01_double.spv")

// Upload data: [1, 2, 3, ..., 256]
let mut data = []
let mut i = 0.0
while i < N
  push(data, i + 1.0)
  i = i + 1.0
end
vm_write_register(vm, 0.0, 0.0, data)

let mut zeros = []
let mut i = 0.0
while i < N
  push(zeros, 0.0)
  i = i + 1.0
end
vm_write_register(vm, 0.0, 1.0, zeros)

// ── 30 sequential doublings (ping-pong) ─────────────────────────────
let t0 = time()

let mut d = 0.0
while d < TOTAL_DOUBLINGS
  loom_dispatch(vm, "tests/gpu_shaders/01_double.spv", [], 1.0)
  let prog = loom_build(vm)
  loom_run(prog)
  loom_free(prog)

  // Ping-pong: read output (register 1), write back to input (register 0)
  let result = loom_read(vm, 0.0, 1.0, N)
  vm_write_register(vm, 0.0, 0.0, result)

  d = d + 1.0
end

let t1 = time()
let total_ms = (t1 - t0) * 1000.0

// ── Verify result (bit-exact) ──────────────────────────────────────
let final_data = loom_read(vm, 0.0, 0.0, 4.0)

// 30 doublings: x * 2^30
let expected_0 = 1073741824.0
let expected_1 = 2147483648.0
let expected_2 = 3221225472.0
let expected_3 = 4294967296.0

let v0 = final_data[0]
let v1 = final_data[1]
let v2 = final_data[2]
let v3 = final_data[3]

print("")
print("OctoFlow GPU — 30 Sequential Doublings (Loom API)")
print("  Phases: 3 x 10 doublings = 30 total")
print("  Total time: {total_ms} ms")
print("  Result[0..3]: [{v0}, {v1}, {v2}, {v3}]")
print("  Expected:     [{expected_0}, {expected_1}, {expected_2}, {expected_3}]")

if v0 == expected_0
  if v1 == expected_1
    if v2 == expected_2
      if v3 == expected_3
        print("  EXACT MATCH")
      else
        print("  MISMATCH: v3 got {v3}, expected {expected_3}")
      end
    else
      print("  MISMATCH: v2 got {v2}, expected {expected_2}")
    end
  else
    print("  MISMATCH: v1 got {v1}, expected {expected_1}")
  end
else
  print("  MISMATCH: v0 got {v0}, expected {expected_0}")
end

print("")
loom_shutdown(vm)
