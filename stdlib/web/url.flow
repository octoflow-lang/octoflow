// stdlib/web/url.flow â€” URL parsing and manipulation
//
// Functions: url_parse, build_url, query_string, url_encode

fn url_parse(url)
  let mut result = map()
  // Protocol
  let proto_end = index_of(url, "://")
  if proto_end >= 0.0
    map_set(result, "protocol", substr(url, 0.0, proto_end))
    let rest = substr(url, proto_end + 3.0, len(url))
    // Host + path
    let slash = index_of(rest, "/")
    if slash >= 0.0
      let host_part = substr(rest, 0.0, slash)
      let path_part = substr(rest, slash, len(rest))
      map_set(result, "host", host_part)
      // Check for query string
      let qmark = index_of(path_part, "?")
      if qmark >= 0.0
        map_set(result, "path", substr(path_part, 0.0, qmark))
        map_set(result, "query", substr(path_part, qmark + 1.0, len(path_part)))
      else
        map_set(result, "path", path_part)
      end
    else
      map_set(result, "host", rest)
      map_set(result, "path", "/")
    end
  else
    map_set(result, "protocol", "")
    map_set(result, "host", url)
    map_set(result, "path", "/")
  end
  return result
end

fn build_url(protocol, host, path, query)
  let mut url = protocol + "://" + host + path
  if len(query) > 0.0
    url = url + "?" + query
  end
  return url
end

// Percent-encode a string for safe use in URLs.
// Encodes all characters except unreserved: A-Z a-z 0-9 - _ . ~
fn url_encode(s)
  if len(s) == 0.0
    return ""
  end
  let mut result = ""
  let hex = "0123456789ABCDEF"
  let mut i = 0.0
  while i < len(s)
    let c = char_at(s, i)
    let code = ord(c)
    // Unreserved characters pass through
    if (code >= 65.0 && code <= 90.0) || (code >= 97.0 && code <= 122.0) || (code >= 48.0 && code <= 57.0) || c == "-" || c == "_" || c == "." || c == "~"
      result = result + c
    else
      // Percent-encode: %XX
      let hi = int(code / 16.0)
      let lo = int(code) % 16
      result = result + "%" + char_at(hex, hi) + char_at(hex, lo)
    end
    i = i + 1.0
  end
  return result
end

fn query_string(params)
  // params: map of key -> value
  // Values are percent-encoded to prevent injection
  let keys = split(map_keys(params), ",")
  let mut parts = []
  for key in keys
    let val = map_get(params, key)
    push(parts, url_encode(key) + "=" + url_encode(val))
  end
  return join(parts, "&")
end
