// emit_vm_copy.flow — VM Register Copy Kernel Emitter
//
// Copies reg_size floats within the registers SSBO (binding 0).
// src and dst offsets are passed via push constants.
//
// Push constants:
//   pc[0] = src_offset (flat float index into registers SSBO)
//   pc[1] = dst_offset (flat float index into registers SSBO)
//   pc[2] = count      (number of elements — bounds guard)
//
// Each thread copies one float if gid < count:
//   registers[dst_offset + gid] = registers[src_offset + gid]
//
// Binding layout (must match VM's 4-SSBO descriptor set):
//   Binding 0: registers (read/write via ir_load_input_at + ir_buf_store_f)
//   Binding 1: metrics   (unused by this kernel)
//   Binding 2: globals   (unused by this kernel)
//   Binding 3: control   (output binding, unused by this kernel)
//
// Dispatch: workgroups = ceil(reg_size / 256)
//
// Run: octoflow run stdlib/loom/emit_vm_copy.flow --allow-read --allow-write

use "../compiler/ir"

fn emit_vm_copy(out_path)
  ir_new()
  ir_input_count = 3.0

  let entry = ir_block("entry")
  let body = ir_block("body")
  let exit_block = ir_block("exit")

  let gid = ir_load_gid(entry)

  // Load push constants: src_offset, dst_offset, count
  let src_off = ir_push_const(entry, 0.0)
  let dst_off = ir_push_const(entry, 1.0)
  let cnt_f = ir_push_const(entry, 2.0)

  // Bounds check: skip if gid >= count
  let cnt_u = ir_ftou(entry, cnt_f)
  let oob = ir_ugte(entry, gid, cnt_u)
  let _sm = ir_selection_merge(entry, exit_block)
  let _br = ir_term_cond_branch(entry, oob, exit_block, body)

  // body: compute indices, copy element
  let src_u = ir_ftou(body, src_off)
  let dst_u = ir_ftou(body, dst_off)
  let src_idx = ir_iadd(body, src_u, gid)
  let dst_idx = ir_iadd(body, dst_u, gid)
  let val = ir_load_input_at(body, 0.0, src_idx)
  let _s = ir_buf_store_f(body, 0.0, dst_idx, val)
  let _br2 = ir_term_branch(body, exit_block)

  let _ret = ir_term_return(exit_block)

  ir_emit_spirv(out_path)
  return 0.0
end

// Emit the kernel
let out = "stdlib/loom/kernels/ops/vm_copy.spv"
let _r = emit_vm_copy(out)
print("Emitted: {out}")
