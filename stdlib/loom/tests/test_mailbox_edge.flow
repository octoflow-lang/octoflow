// test_mailbox_edge.flow — Edge case tests for mailbox communication
//
// Covers gaps not in test_mailbox.flow:
//   1. Overflow guard — send count > slot_size returns -1
//   2. Zero-size mailbox — slot_size=0 or slot_count=0 returns -1
//   3. Single-slot mailbox — minimal 1-slot-of-1 configuration
//
// Run: octoflow run stdlib/loom/tests/test_mailbox_edge.flow --allow-ffi --allow-read --allow-write

print("=== Test: Mailbox Edge Cases ===")
print("")

let mut pass = 0.0
let mut fail = 0.0

fn check(name, got, expected)
  if abs(got - expected) < 0.5
    print("  PASS: {name} = {got}")
    return 1.0
  else
    print("  FAIL: {name} = {got} (expected {expected})")
    return 0.0
  end
end

fn tally(result)
  if result > 0.5
    pass = pass + 1.0
  else
    fail = fail + 1.0
  end
  return 0.0
end

// ── Test 1: Overflow guard — send count > slot_size ─────────────────
print("Test 1: Send count > slot_size returns -1")

let mb1 = loom_mailbox(4.0, 2.0)
let vm1 = loom_boot(1.0, 1.0, 64.0)

// Write 8 floats but slot_size is only 4
let overflow_data = [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0]
vm_write_globals(vm1, 0.0, overflow_data)
let result1 = loom_mail_send(mb1, vm1, 0.0, 8.0)
let _t = tally(check("send 8 to slot_size=4", result1, -1.0))

// Sending exactly slot_size should succeed
let exact_data = [10.0, 20.0, 30.0, 40.0]
vm_write_globals(vm1, 0.0, exact_data)
let result1b = loom_mail_send(mb1, vm1, 0.0, 4.0)
let _t = tally(check("send 4 to slot_size=4", result1b, 1.0))

loom_shutdown(vm1)
print("")

// ── Test 2: Zero-size mailbox returns -1 ────────────────────────────
print("Test 2: Zero-size mailbox rejected")

// slot_size=0 should fail
let mb_bad1 = loom_mailbox(0.0, 4.0)
let _t = tally(check("slot_size=0 fails", mb_bad1, -1.0))

// slot_count=0 should fail
let mb_bad2 = loom_mailbox(16.0, 0.0)
let _t = tally(check("slot_count=0 fails", mb_bad2, -1.0))

print("")

// ── Test 3: Single-slot mailbox ─────────────────────────────────────
print("Test 3: Single-slot mailbox (1 slot of size 1)")

let mb3 = loom_mailbox(1.0, 1.0)
let vm3a = loom_boot(1.0, 1.0, 64.0)
let vm3b = loom_boot(1.0, 1.0, 64.0)

// Send 1 float — should succeed
let single = [99.0]
vm_write_globals(vm3a, 0.0, single)
let s3a = loom_mail_send(mb3, vm3a, 0.0, 1.0)
let _t = tally(check("send to single-slot", s3a, 1.0))

// Second send — should fail (full)
let single2 = [100.0]
vm_write_globals(vm3a, 0.0, single2)
let s3b = loom_mail_send(mb3, vm3a, 0.0, 1.0)
let _t = tally(check("single-slot full", s3b, 0.0))

// Poll — should have a message
let poll3 = loom_mail_poll(mb3)
let _t = tally(check("poll has message", poll3, 1.0))

// Recv — should succeed and free the slot
let count3 = loom_mail_recv(mb3, vm3b, 0.0)
let _t = tally(check("recv returns 1", count3, 1.0))

let data3 = vm_read_globals(vm3b, 0.0, 1.0)
let _t = tally(check("recv data=99", data3[0], 99.0))

// After recv, poll should show empty
let poll3b = loom_mail_poll(mb3)
let _t = tally(check("poll empty after recv", poll3b, 0.0))

// Send again — should succeed (slot freed)
let single3 = [200.0]
vm_write_globals(vm3a, 0.0, single3)
let s3c = loom_mail_send(mb3, vm3a, 0.0, 1.0)
let _t = tally(check("send after drain", s3c, 1.0))

loom_shutdown(vm3a)
loom_shutdown(vm3b)
print("")

// ── Summary ─────────────────────────────────────────────────────────
print("Results: {pass} passed, {fail} failed")
if fail < 0.5
  print("ALL PASS")
else
  print("SOME FAILED")
end
print("")
