// widgets.flow — GUI Widget Creation + Queries
//
// All 16 widget types: creation functions, helpers, and state queries.
// All query/mutation functions bounds-check id before array access.
//
// Usage:
//   use "gui"
//   let btn = gui_button(10.0, 10.0, 120.0, 36.0, "CLICK")

use "gui_core"

// ── Internal bounds helper ──────────────────────────────────────────
// Returns 1.0 if id is valid widget index, 0.0 otherwise
fn _gui_id_ok(id)
  if id < 0.0
    return 0.0
  end
  if id >= len(_gui_types)
    return 0.0
  end
  return 1.0
end

// ── Basic Widgets ───────────────────────────────────────────────────

fn gui_panel(x, y, w, h)
  let id = _gui_add_widget(GUI_PANEL, x, y, w, h, " ")
  return id
end

fn gui_label(x, y, text)
  let tw = len(text) * 10.0 + 4.0
  let id = _gui_add_widget(GUI_LABEL, x, y, tw, 20.0, text)
  return id
end

fn gui_button(x, y, w, h, text)
  let id = _gui_add_widget(GUI_BUTTON, x, y, w, h, text)
  return id
end

fn gui_checkbox(x, y, text)
  let tw = len(text) * 10.0 + 28.0
  let id = _gui_add_widget(GUI_CHECKBOX, x, y, tw, 22.0, text)
  return id
end

fn gui_slider(x, y, w, min_val, max_val, initial)
  let id = _gui_add_widget(GUI_SLIDER, x, y, w, 24.0, " ")
  _gui_slider_min[int(id)] = min_val
  _gui_slider_max[int(id)] = max_val
  _gui_slider_val[int(id)] = initial
  return id
end

fn gui_textinput(x, y, w)
  let id = _gui_add_widget(GUI_TEXTINPUT, x, y, w, 30.0, " ")
  return id
end

fn gui_progress(x, y, w)
  let id = _gui_add_widget(GUI_PROGRESS, x, y, w, 22.0, " ")
  _gui_slider_val[int(id)] = 0.0
  _gui_slider_min[int(id)] = 0.0
  _gui_slider_max[int(id)] = 100.0
  return id
end

fn gui_radio(x, y, text, group)
  let tw = len(text) * 10.0 + 28.0
  let id = _gui_add_widget(GUI_RADIO, x, y, tw, 22.0, text)
  _gui_parent[int(id)] = group
  return id
end

fn gui_separator(x, y, w)
  let id = _gui_add_widget(GUI_SEPARATOR, x, y, w, 2.0, " ")
  return id
end

// ── Listbox ─────────────────────────────────────────────────────────

fn gui_listbox(x, y, w, h)
  let id = _gui_add_widget(GUI_LISTBOX, x, y, w, h, " ")
  _gui_list_start[int(id)] = len(_gui_list_items)
  _gui_list_count[int(id)] = 0.0
  _gui_list_selected[int(id)] = -1.0
  _gui_list_scroll[int(id)] = 0.0
  return id
end

fn gui_listbox_add(id, text)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  push(_gui_list_items, text)
  let ii = int(id)
  _gui_list_count[ii] = _gui_list_count[ii] + 1.0
  _gs[9] = 1.0
  return 0.0
end

fn gui_listbox_selected(id)
  if _gui_id_ok(id) == 0.0
    return -1.0
  end
  return _gui_list_selected[int(id)]
end

fn gui_listbox_text(id, idx)
  if _gui_id_ok(id) == 0.0
    return ""
  end
  let ii = int(id)
  let count = _gui_list_count[ii]
  if idx < 0.0 || idx >= count
    return ""
  end
  let start = _gui_list_start[ii]
  let actual = int(start + idx)
  if actual < 0.0 || actual >= len(_gui_list_items)
    return ""
  end
  return _gui_list_items[actual]
end

// ── Spinbox ─────────────────────────────────────────────────────────

fn gui_spinbox(x, y, w, min_val, max_val, initial, step)
  let id = _gui_add_widget(GUI_SPINBOX, x, y, w, 30.0, " ")
  _gui_slider_min[int(id)] = min_val
  _gui_slider_max[int(id)] = max_val
  _gui_slider_val[int(id)] = initial
  _gui_parent[int(id)] = step
  return id
end

fn gui_spinbox_value(id)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  return _gui_slider_val[int(id)]
end

fn gui_set_spinbox(id, val)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let ii = int(id)
  let mut v = val
  let smin = _gui_slider_min[ii]
  let smax = _gui_slider_max[ii]
  if v < smin
    v = smin
  end
  if v > smax
    v = smax
  end
  _gui_slider_val[ii] = v
  _gs[9] = 1.0
  return 0.0
end

// ── Dropdown ────────────────────────────────────────────────────────

fn gui_dropdown(x, y, w)
  let id = _gui_add_widget(GUI_DROPDOWN, x, y, w, 30.0, " ")
  // Fix H-23: initialize list_start for dropdown
  _gui_list_start[int(id)] = len(_gui_list_items)
  return id
end

fn gui_dropdown_add(id, text)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let ii = int(id)
  let count = _gui_list_count[ii]
  if count == 0.0
    _gui_list_start[ii] = len(_gui_list_items)
  end
  push(_gui_list_items, text)
  _gui_list_count[ii] = count + 1.0
  if count == 0.0
    _gui_list_selected[ii] = 0.0
  end
  _gs[9] = 1.0
  return 0.0
end

fn gui_dropdown_selected(id)
  if _gui_id_ok(id) == 0.0
    return -1.0
  end
  return _gui_list_selected[int(id)]
end

fn gui_dropdown_text(id, idx)
  if _gui_id_ok(id) == 0.0
    return ""
  end
  let ii = int(id)
  let count = _gui_list_count[ii]
  if idx < 0.0 || idx >= count
    return ""
  end
  let start = _gui_list_start[ii]
  let actual = int(start + idx)
  if actual < 0.0 || actual >= len(_gui_list_items)
    return ""
  end
  return _gui_list_items[actual]
end

fn gui_set_dropdown(id, idx)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let ii = int(id)
  let count = _gui_list_count[ii]
  if idx >= 0.0
    if idx < count
      _gui_list_selected[ii] = idx
    end
  end
  _gs[9] = 1.0
  return 0.0
end

// ── Tabs ────────────────────────────────────────────────────────────

fn gui_tabs(x, y, w, h)
  let id = _gui_add_widget(GUI_TABS, x, y, w, h, " ")
  _gui_slider_val[int(id)] = 0.0
  return id
end

fn gui_tab_add(id, label)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let ii = int(id)
  let count = _gui_list_count[ii]
  if count == 0.0
    _gui_list_start[ii] = len(_gui_list_items)
  end
  push(_gui_list_items, label)
  _gui_list_count[ii] = count + 1.0
  _gs[9] = 1.0
  return 0.0
end

fn gui_tab_active(id)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  return _gui_slider_val[int(id)]
end

fn gui_set_tab(id, idx)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  _gui_slider_val[int(id)] = idx
  _gui_clicked[int(id)] = 1.0
  _gs[9] = 1.0
  return 0.0
end

// ── Treeview ────────────────────────────────────────────────────────

fn gui_treeview(x, y, w, h)
  let id = _gui_add_widget(GUI_TREEVIEW, x, y, w, h, " ")
  _gui_list_start[int(id)] = len(_gui_tree_labels)
  _gui_list_count[int(id)] = 0.0
  _gui_list_selected[int(id)] = -1.0
  _gui_list_scroll[int(id)] = 0.0
  return id
end

fn gui_tree_add(id, label, parent_node)
  if _gui_id_ok(id) == 0.0
    return -1.0
  end
  let ii = int(id)
  let tree_start = _gui_list_start[ii]
  let mut depth = 0.0
  if parent_node >= 0.0
    let pidx = int(tree_start + parent_node)
    if pidx >= 0.0
      if pidx < len(_gui_tree_depth)
        depth = _gui_tree_depth[pidx] + 1.0
      end
    end
  end
  push(_gui_tree_labels, label)
  push(_gui_tree_parents, parent_node)
  push(_gui_tree_depth, depth)
  push(_gui_tree_expanded, 1.0)
  let node_idx = _gui_list_count[ii]
  _gui_list_count[ii] = node_idx + 1.0
  _gs[9] = 1.0
  return node_idx
end

fn gui_tree_selected(id)
  if _gui_id_ok(id) == 0.0
    return -1.0
  end
  return _gui_list_selected[int(id)]
end

fn gui_tree_text(id, node_idx)
  if _gui_id_ok(id) == 0.0
    return ""
  end
  let ii = int(id)
  let count = _gui_list_count[ii]
  if node_idx < 0.0 || node_idx >= count
    return ""
  end
  let start = _gui_list_start[ii]
  let actual = int(start + node_idx)
  if actual < 0.0 || actual >= len(_gui_tree_labels)
    return ""
  end
  return _gui_tree_labels[actual]
end

fn gui_tree_toggle(id, node_idx)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let ii = int(id)
  let count = _gui_list_count[ii]
  if node_idx < 0.0 || node_idx >= count
    return 0.0
  end
  let abs_idx = int(_gui_list_start[ii] + node_idx)
  if abs_idx < 0.0 || abs_idx >= len(_gui_tree_expanded)
    return 0.0
  end
  if _gui_tree_expanded[abs_idx] == 1.0
    _gui_tree_expanded[abs_idx] = 0.0
  else
    _gui_tree_expanded[abs_idx] = 1.0
  end
  _gs[9] = 1.0
  return 0.0
end

fn gui_tree_is_expanded(id, node_idx)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let ii = int(id)
  let count = _gui_list_count[ii]
  if node_idx < 0.0 || node_idx >= count
    return 0.0
  end
  let abs_idx = int(_gui_list_start[ii] + node_idx)
  if abs_idx < 0.0 || abs_idx >= len(_gui_tree_expanded)
    return 0.0
  end
  return _gui_tree_expanded[abs_idx]
end

fn _gui_tree_node_visible(id, node_idx)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let ii = int(id)
  let tree_start = _gui_list_start[ii]
  let abs = int(tree_start + node_idx)
  if abs < 0.0 || abs >= len(_gui_tree_parents)
    return 0.0
  end
  let mut p = _gui_tree_parents[abs]
  let mut depth = 0.0
  while p >= 0.0
    depth = depth + 1.0
    if depth > 100.0
      return 0.0
    end
    let pidx = int(tree_start + p)
    if pidx < 0.0 || pidx >= len(_gui_tree_expanded)
      return 0.0
    end
    if _gui_tree_expanded[pidx] == 0.0
      return 0.0
    end
    if pidx >= len(_gui_tree_parents)
      return 0.0
    end
    p = _gui_tree_parents[pidx]
  end
  return 1.0
end

// ── Tooltip ─────────────────────────────────────────────────────────

fn gui_tooltip(target_id, text)
  let tw = len(text) * 10.0 + 8.0
  let id = _gui_add_widget(GUI_TOOLTIP, 0.0, 0.0, tw, 22.0, text)
  _gui_parent[int(id)] = target_id
  _gui_visible[int(id)] = 0.0
  return id
end

// ── Widget Queries (all bounds-checked) ─────────────────────────────

fn gui_running()
  return _gs[0]
end

fn gui_clicked(id)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  return _gui_clicked[int(id)]
end

fn gui_checked(id)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  return _gui_checked[int(id)]
end

fn gui_slider_value(id)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  return _gui_slider_val[int(id)]
end

fn gui_get_text(id)
  if _gui_id_ok(id) == 0.0
    return ""
  end
  return _gui_input_text[int(id)]
end

// ── Widget Mutations (all bounds-checked) ───────────────────────────

fn gui_set_text(id, text)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  _gui_texts[int(id)] = text
  _gs[9] = 1.0
  return 0.0
end

fn gui_set_checked(id, val)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  _gui_checked[int(id)] = val
  _gs[9] = 1.0
  return 0.0
end

fn gui_set_slider(id, val)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  _gui_slider_val[int(id)] = val
  _gs[9] = 1.0
  return 0.0
end

fn gui_set_visible(id, val)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  _gui_visible[int(id)] = val
  _gs[9] = 1.0
  return 0.0
end

fn gui_set_enabled(id, val)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  _gui_enabled[int(id)] = val
  _gs[9] = 1.0
  return 0.0
end

fn gui_set_progress(id, val)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let mut v = val
  if v < 0.0
    v = 0.0
  end
  if v > 100.0
    v = 100.0
  end
  _gui_slider_val[int(id)] = v
  _gs[9] = 1.0
  return 0.0
end

// H-23: Set text input value programmatically
fn gui_set_input_text(id, text)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  _gui_input_text[int(id)] = text
  _gui_input_cursor[int(id)] = len(text)
  _gs[9] = 1.0
  return 1.0
end

fn gui_radio_value(group)
  let wcount = len(_gui_types)
  let mut j = 0.0
  while j < wcount
    let jj = int(j)
    if _gui_types[jj] == GUI_RADIO
      if _gui_parent[jj] == group
        if _gui_checked[jj] == 1.0
          return j
        end
      end
    end
    j = j + 1.0
  end
  return -1.0
end

// H-32: Widget removal — mark widget as removed
fn gui_remove(id)
  if _gui_id_ok(id) == 0.0
    return 0.0
  end
  let ii = int(id)
  _gui_types[ii] = 0.0
  _gui_visible[ii] = 0.0
  _gui_enabled[ii] = 0.0
  _gs[9] = 1.0
  return 1.0
end
