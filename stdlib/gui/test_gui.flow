// test_gui.flow — GUI Widget Toolkit State Management Tests
//
// Tests all 16 widget types: creation, state queries, setters.
// Also tests: OOB safety, text input roundtrip, gui_remove, themes,
// canvas commands, layout positions, and new Phase 3H features.
// Does NOT call gui_init() — exercises array-based state only.
//
// Usage:
//   octoflow run stdlib/gui/test_gui.flow

use "gui"
use "layout"
use "animation"

// Array-based counters (scalar snapshot semantics — functions can't modify scalars)
let mut _tcount = [0.0, 0.0]

fn check(name, got, expected)
  if got == expected
    _tcount[0] = _tcount[0] + 1.0
    return 1.0
  end
  print("  FAIL: {name} — got {got}, expected {expected}")
  _tcount[1] = _tcount[1] + 1.0
  return 0.0
end

fn check_str(name, got, expected)
  if got == expected
    _tcount[0] = _tcount[0] + 1.0
    return 1.0
  end
  print("  FAIL: {name} — got {got}, expected {expected}")
  _tcount[1] = _tcount[1] + 1.0
  return 0.0
end

print("=== GUI Widget Toolkit Tests ===")

// ── 1. Panel ───────────────────────────────────────────────────────
print("1. Panel")
let panel = gui_panel(10.0, 20.0, 300.0, 400.0)
let _c1 = check("panel id", panel, 0.0)
let _c2 = check("panel type", _gui_types[0], GUI_PANEL)
let _c3 = check("panel x", _gui_x[0], 10.0)
let _c4 = check("panel y", _gui_y[0], 20.0)
let _c5 = check("panel w", _gui_w[0], 300.0)
let _c6 = check("panel h", _gui_h[0], 400.0)
let _c7 = check("panel visible", _gui_visible[0], 1.0)
let _c8 = check("panel enabled", _gui_enabled[0], 1.0)

// ── 2. Label ───────────────────────────────────────────────────────
print("2. Label")
let lbl = gui_label(50.0, 60.0, "HELLO")
let _c9 = check("label id", lbl, 1.0)
let _c10 = check("label type", _gui_types[1], GUI_LABEL)
let _c11 = check("label x", _gui_x[1], 50.0)
let _c12 = check_str("label text", _gui_texts[1], "HELLO")
let _st1 = gui_set_text(lbl, "WORLD")
let _c13 = check_str("label set_text", _gui_texts[1], "WORLD")

// ── 3. Button ──────────────────────────────────────────────────────
print("3. Button")
let btn = gui_button(10.0, 100.0, 120.0, 36.0, "CLICK ME")
let _c14 = check("button id", btn, 2.0)
let _c15 = check("button type", _gui_types[2], GUI_BUTTON)
let _c16 = check("button w", _gui_w[2], 120.0)
let _c17 = check("button h", _gui_h[2], 36.0)
let _c18 = check_str("button text", _gui_texts[2], "CLICK ME")
let _c19 = check("button clicked init", gui_clicked(btn), 0.0)

// ── 4. Checkbox ────────────────────────────────────────────────────
print("4. Checkbox")
let chk = gui_checkbox(10.0, 150.0, "OPTION")
let _c20 = check("checkbox id", chk, 3.0)
let _c21 = check("checkbox type", _gui_types[3], GUI_CHECKBOX)
let _c22 = check("checkbox checked init", gui_checked(chk), 0.0)
let _sc1 = gui_set_checked(chk, 1.0)
let _c23 = check("checkbox set_checked", gui_checked(chk), 1.0)
let _sc2 = gui_set_checked(chk, 0.0)
let _c24 = check("checkbox uncheck", gui_checked(chk), 0.0)

// ── 5. Slider ──────────────────────────────────────────────────────
print("5. Slider")
let sld = gui_slider(10.0, 200.0, 200.0, 0.0, 100.0, 50.0)
let _c25 = check("slider id", sld, 4.0)
let _c26 = check("slider type", _gui_types[4], GUI_SLIDER)
let _c27 = check("slider initial", gui_slider_value(sld), 50.0)
let _c28 = check("slider min", _gui_slider_min[4], 0.0)
let _c29 = check("slider max", _gui_slider_max[4], 100.0)
let _ss1 = gui_set_slider(sld, 75.0)
let _c30 = check("slider set", gui_slider_value(sld), 75.0)

// ── 6. Text Input ──────────────────────────────────────────────────
print("6. Text Input")
let inp = gui_textinput(10.0, 250.0, 200.0)
let _c31 = check("input id", inp, 5.0)
let _c32 = check("input type", _gui_types[5], GUI_TEXTINPUT)
let _c33 = check("input w", _gui_w[5], 200.0)
let _c34 = check("input h", _gui_h[5], 30.0)

// ── 7. Progress Bar ────────────────────────────────────────────────
print("7. Progress Bar")
let prog = gui_progress(10.0, 300.0, 250.0)
let _c35 = check("progress id", prog, 6.0)
let _c36 = check("progress type", _gui_types[6], GUI_PROGRESS)
let _c37 = check("progress init", gui_slider_value(prog), 0.0)
let _sp1 = gui_set_progress(prog, 42.0)
let _c38 = check("progress set", gui_slider_value(prog), 42.0)
// Clamp to 0-100
let _sp2 = gui_set_progress(prog, 150.0)
let _c39 = check("progress clamp high", gui_slider_value(prog), 100.0)
let _sp3 = gui_set_progress(prog, -10.0)
let _c40 = check("progress clamp low", gui_slider_value(prog), 0.0)

// ── 8. Radio Buttons ───────────────────────────────────────────────
print("8. Radio Buttons")
let rad1 = gui_radio(10.0, 350.0, "OPT A", 1.0)
let rad2 = gui_radio(120.0, 350.0, "OPT B", 1.0)
let rad3 = gui_radio(230.0, 350.0, "OPT C", 2.0)
let _c41 = check("radio1 id", rad1, 7.0)
let _c42 = check("radio2 id", rad2, 8.0)
let _c43 = check("radio3 id", rad3, 9.0)
let _c44 = check("radio1 type", _gui_types[7], GUI_RADIO)
let _c45 = check("radio1 group", _gui_parent[7], 1.0)
let _c46 = check("radio2 group", _gui_parent[8], 1.0)
let _c47 = check("radio3 group", _gui_parent[9], 2.0)
// Set checked state
let _sr1 = gui_set_checked(rad1, 1.0)
let _c48 = check("radio1 checked", gui_checked(rad1), 1.0)
let _c49 = check("radio2 checked", gui_checked(rad2), 0.0)

// ── 9. Separator ───────────────────────────────────────────────────
print("9. Separator")
let sep = gui_separator(10.0, 390.0, 300.0)
let _c50 = check("separator id", sep, 10.0)
let _c51 = check("separator type", _gui_types[10], GUI_SEPARATOR)
let _c52 = check("separator w", _gui_w[10], 300.0)
let _c53 = check("separator h", _gui_h[10], 2.0)

// ── 10. Listbox ────────────────────────────────────────────────────
print("10. Listbox")
let lst = gui_listbox(10.0, 400.0, 200.0, 100.0)
let _c54 = check("listbox id", lst, 11.0)
let _c55 = check("listbox type", _gui_types[11], GUI_LISTBOX)
let _c56 = check("listbox count init", _gui_list_count[11], 0.0)
let _c57 = check("listbox selected init", gui_listbox_selected(lst), -1.0)
let _la1 = gui_listbox_add(lst, "ALPHA")
let _la2 = gui_listbox_add(lst, "BETA")
let _la3 = gui_listbox_add(lst, "GAMMA")
let _c58 = check("listbox count", _gui_list_count[11], 3.0)
let _c59 = check_str("listbox item 0", gui_listbox_text(lst, 0.0), "ALPHA")
let _c60 = check_str("listbox item 1", gui_listbox_text(lst, 1.0), "BETA")
let _c61 = check_str("listbox item 2", gui_listbox_text(lst, 2.0), "GAMMA")
// Simulate selection
_gui_list_selected[11] = 1.0
let _c62 = check("listbox selected", gui_listbox_selected(lst), 1.0)

// ── 11. Spinbox ────────────────────────────────────────────────────
print("11. Spinbox")
let spn = gui_spinbox(10.0, 520.0, 140.0, 0.0, 50.0, 10.0, 2.0)
let _c63 = check("spinbox id", spn, 12.0)
let _c64 = check("spinbox type", _gui_types[12], GUI_SPINBOX)
let _c65 = check("spinbox initial", gui_spinbox_value(spn), 10.0)
let _c66 = check("spinbox min", _gui_slider_min[12], 0.0)
let _c67 = check("spinbox max", _gui_slider_max[12], 50.0)
let _c68 = check("spinbox step", _gui_parent[12], 2.0)
// Set value within range
let _ssn1 = gui_set_spinbox(spn, 30.0)
let _c69 = check("spinbox set", gui_spinbox_value(spn), 30.0)
// Clamp above max
let _ssn2 = gui_set_spinbox(spn, 999.0)
let _c70 = check("spinbox clamp high", gui_spinbox_value(spn), 50.0)
// Clamp below min
let _ssn3 = gui_set_spinbox(spn, -5.0)
let _c71 = check("spinbox clamp low", gui_spinbox_value(spn), 0.0)

// ── 12. Dropdown ───────────────────────────────────────────────────
print("12. Dropdown")
let dd = gui_dropdown(10.0, 570.0, 160.0)
let _c72 = check("dropdown id", dd, 13.0)
let _c73 = check("dropdown type", _gui_types[13], GUI_DROPDOWN)
let _da1 = gui_dropdown_add(dd, "RED")
let _da2 = gui_dropdown_add(dd, "GREEN")
let _da3 = gui_dropdown_add(dd, "BLUE")
let _c74 = check("dropdown count", _gui_list_count[13], 3.0)
let _c75 = check("dropdown selected init", gui_dropdown_selected(dd), 0.0)
let _c76 = check_str("dropdown text 0", gui_dropdown_text(dd, 0.0), "RED")
let _c77 = check_str("dropdown text 1", gui_dropdown_text(dd, 1.0), "GREEN")
let _c78 = check_str("dropdown text 2", gui_dropdown_text(dd, 2.0), "BLUE")
// Change selection
let _sdd = gui_set_dropdown(dd, 2.0)
let _c79 = check("dropdown set", gui_dropdown_selected(dd), 2.0)
// Out of range — should not change
let _sdd2 = gui_set_dropdown(dd, 10.0)
let _c80 = check("dropdown oob no change", gui_dropdown_selected(dd), 2.0)

// ── 13. Tabs ───────────────────────────────────────────────────────
print("13. Tabs")
let tabs = gui_tabs(10.0, 620.0, 300.0, 100.0)
let _c81 = check("tabs id", tabs, 14.0)
let _c82 = check("tabs type", _gui_types[14], GUI_TABS)
let _c83 = check("tabs active init", gui_tab_active(tabs), 0.0)
let _ta1 = gui_tab_add(tabs, "HOME")
let _ta2 = gui_tab_add(tabs, "SETTINGS")
let _ta3 = gui_tab_add(tabs, "ABOUT")
let _c84 = check("tabs count", _gui_list_count[14], 3.0)
// Switch tab
let _st2 = gui_set_tab(tabs, 2.0)
let _c85 = check("tabs set active", gui_tab_active(tabs), 2.0)
let _c86 = check("tabs set fires click", gui_clicked(tabs), 1.0)

// ── Cross-cutting: visibility/enabled ──────────────────────────────
print("14. Visibility and Enabled")
let _sv1 = gui_set_visible(btn, 0.0)
let _c87 = check("button hidden", _gui_visible[2], 0.0)
let _sv2 = gui_set_visible(btn, 1.0)
let _c88 = check("button visible", _gui_visible[2], 1.0)
let _se1 = gui_set_enabled(btn, 0.0)
let _c89 = check("button disabled", _gui_enabled[2], 0.0)
let _se2 = gui_set_enabled(btn, 1.0)
let _c90 = check("button enabled", _gui_enabled[2], 1.0)

// ── Theme switching ────────────────────────────────────────────────
print("15. Themes")
let _td = gui_theme_dark()
let dark_bg_r = _tc[0]
let _tl = gui_theme_light()
let light_bg_r = _tc[0]
let _to = gui_theme_ocean()
let ocean_bg_r = _tc[0]
// Dark bg R=30, Light bg R=240, Ocean bg R=15
let _c91 = check("dark bg R", dark_bg_r, 30.0)
let _c92 = check("light bg R", light_bg_r, 240.0)
let _c93 = check("ocean bg R", ocean_bg_r, 15.0)

// ── 14. Canvas ───────────────────────────────────────────────────────
print("16. Canvas")
let cvs = gui_canvas(10.0, 700.0, 300.0, 200.0)
let _c94 = check("canvas id", cvs, 15.0)
let _c95 = check("canvas type", _gui_types[15], GUI_CANVAS)
let _c96 = check("canvas x", _gui_x[15], 10.0)
let _c97 = check("canvas w", _gui_w[15], 300.0)
let _c98 = check("canvas h", _gui_h[15], 200.0)
let _c99 = check("canvas cmd count init", _gui_list_count[15], 0.0)
// Add draw commands
let _cl1 = gui_canvas_line(cvs, 0.0, 0.0, 100.0, 100.0, 255.0, 0.0, 0.0)
let _c100 = check("canvas 1 cmd", _gui_list_count[15], 1.0)
let _cr1 = gui_canvas_rect(cvs, 10.0, 10.0, 50.0, 30.0, 0.0, 255.0, 0.0)
let _c101 = check("canvas 2 cmds", _gui_list_count[15], 2.0)
let _cf1 = gui_canvas_fill(cvs, 20.0, 20.0, 40.0, 20.0, 0.0, 0.0, 255.0)
let _cc1 = gui_canvas_circle(cvs, 50.0, 50.0, 20.0, 255.0, 255.0, 0.0)
let _cfc1 = gui_canvas_fill_circle(cvs, 80.0, 80.0, 15.0, 255.0, 0.0, 255.0)
let _cpx1 = gui_canvas_pixel(cvs, 5.0, 5.0, 128.0, 128.0, 128.0)
let _c102 = check("canvas 6 cmds", _gui_list_count[15], 6.0)
// Verify command encoding (line: type=1, x1=0, y1=0, x2=100, y2=100, r=255, g=0, b=0)
let cmd_base = _gui_list_start[15]
let _c103 = check("cmd type=line", _gui_canvas_cmds[int(cmd_base)], 1.0)
let _c104 = check("cmd x2=100", _gui_canvas_cmds[int(cmd_base + 3)], 100.0)
let _c105 = check("cmd r=255", _gui_canvas_cmds[int(cmd_base + 5)], 255.0)
// Clear canvas
let _ccl = gui_canvas_clear(cvs)
let _c106 = check("canvas cleared", _gui_list_count[15], 0.0)

// ── 15. Treeview ─────────────────────────────────────────────────────
print("17. Treeview")
let tree = gui_treeview(10.0, 910.0, 250.0, 150.0)
let _c107 = check("tree id", tree, 16.0)
let _c108 = check("tree type", _gui_types[16], GUI_TREEVIEW)
let _c109 = check("tree count init", _gui_list_count[16], 0.0)
let _c110 = check("tree selected init", gui_tree_selected(tree), -1.0)
// Add root nodes
let n0 = gui_tree_add(tree, "ROOT A", -1.0)
let _c111 = check("node0 idx", n0, 0.0)
let n1 = gui_tree_add(tree, "ROOT B", -1.0)
let _c112 = check("node1 idx", n1, 1.0)
// Add children
let n2 = gui_tree_add(tree, "CHILD A1", 0.0)
let _c113 = check("node2 idx", n2, 2.0)
let n3 = gui_tree_add(tree, "CHILD A2", 0.0)
let _c114 = check("tree count", _gui_list_count[16], 4.0)
// Check depth
let ts = _gui_list_start[16]
let _c115 = check("root depth", _gui_tree_depth[int(ts)], 0.0)
let _c116 = check("child depth", _gui_tree_depth[int(ts + 2)], 1.0)
// Check text
let _c117 = check_str("tree text 0", gui_tree_text(tree, 0.0), "ROOT A")
let _c118 = check_str("tree text 2", gui_tree_text(tree, 2.0), "CHILD A1")
// Expand/collapse
let _c119 = check("expanded init", gui_tree_is_expanded(tree, 0.0), 1.0)
let _tgl = gui_tree_toggle(tree, 0.0)
let _c120 = check("collapsed", gui_tree_is_expanded(tree, 0.0), 0.0)
let _tgl2 = gui_tree_toggle(tree, 0.0)
let _c121 = check("re-expanded", gui_tree_is_expanded(tree, 0.0), 1.0)
// Visibility: children of collapsed parent
let _tgl3 = gui_tree_toggle(tree, 0.0)
let _c122 = check("child hidden", _gui_tree_node_visible(tree, 2.0), 0.0)
let _tgl4 = gui_tree_toggle(tree, 0.0)
let _c123 = check("child visible", _gui_tree_node_visible(tree, 2.0), 1.0)

// ── 16. Tooltip ──────────────────────────────────────────────────────
print("18. Tooltip")
let tt = gui_tooltip(btn, "CLICK THIS BUTTON")
let _c124 = check("tooltip type", _gui_types[int(tt)], GUI_TOOLTIP)
let _c125 = check("tooltip target", _gui_parent[int(tt)], btn)
let _c126 = check("tooltip hidden", _gui_visible[int(tt)], 0.0)
let _c127 = check_str("tooltip text", _gui_texts[int(tt)], "CLICK THIS BUTTON")

// ── Widget count ───────────────────────────────────────────────────
print("19. Widget Count")
let total_widgets = len(_gui_types)
// 15 original + canvas + treeview + tooltip = 18
let _c128 = check("total widgets", total_widgets, 18.0)

// ── _gs state array ────────────────────────────────────────────────
print("20. State Array")
let _c129 = check("dropdown_open init", _gs[11], -1.0)
let _c130 = check("dirty flag", _gs[9], 1.0)

// ════════════════════════════════════════════════════════════════════
// ── NEW Phase 3H Tests ─────────────────────────────────────────────
// ════════════════════════════════════════════════════════════════════

// ── H-20: OOB query safety ─────────────────────────────────────────
print("21. OOB Query Safety (H-20)")
let _oob1 = check("clicked OOB -1", gui_clicked(-1.0), 0.0)
let _oob2 = check("clicked OOB 999", gui_clicked(999.0), 0.0)
let _oob3 = check("checked OOB", gui_checked(-5.0), 0.0)
let _oob4 = check("slider_value OOB", gui_slider_value(999.0), 0.0)
let _oob5 = check_str("get_text OOB", gui_get_text(-1.0), "")
let _oob6 = check("listbox_selected OOB", gui_listbox_selected(-1.0), -1.0)
let _oob7 = check_str("listbox_text OOB", gui_listbox_text(-1.0, 0.0), "")
let _oob8 = check("dropdown_selected OOB", gui_dropdown_selected(999.0), -1.0)
let _oob9 = check_str("dropdown_text OOB", gui_dropdown_text(999.0, 0.0), "")
let _oob10 = check("spinbox_value OOB", gui_spinbox_value(-1.0), 0.0)
let _oob11 = check("tab_active OOB", gui_tab_active(999.0), 0.0)
let _oob12 = check("tree_selected OOB", gui_tree_selected(-1.0), -1.0)
let _oob13 = check_str("tree_text OOB", gui_tree_text(-1.0, 0.0), "")
// OOB mutations should be no-ops (return 0.0)
let _oob_m1 = check("set_text OOB", gui_set_text(-1.0, "X"), 0.0)
let _oob_m2 = check("set_checked OOB", gui_set_checked(999.0, 1.0), 0.0)
let _oob_m3 = check("set_slider OOB", gui_set_slider(-1.0, 50.0), 0.0)
let _oob_m4 = check("set_visible OOB", gui_set_visible(999.0, 0.0), 0.0)
let _oob_m5 = check("set_enabled OOB", gui_set_enabled(-1.0, 0.0), 0.0)
let _oob_m6 = check("set_progress OOB", gui_set_progress(999.0, 50.0), 0.0)
let _oob_m7 = check("set_spinbox OOB", gui_set_spinbox(-1.0, 10.0), 0.0)
let _oob_m8 = check("set_dropdown OOB", gui_set_dropdown(-1.0, 0.0), 0.0)
let _oob_m9 = check("set_tab OOB", gui_set_tab(999.0, 0.0), 0.0)
let _oob_m10 = check("listbox_add OOB", gui_listbox_add(-1.0, "X"), 0.0)
let _oob_m11 = check("dropdown_add OOB", gui_dropdown_add(-1.0, "X"), 0.0)
let _oob_m12 = check("tab_add OOB", gui_tab_add(-1.0, "X"), 0.0)

// ── H-23: Text input roundtrip ─────────────────────────────────────
print("22. Text Input Roundtrip (H-23)")
let _sit1 = gui_set_input_text(inp, "HELLO FLOW")
let _ti1 = check("set_input_text ok", _sit1, 1.0)
let _ti2 = check_str("get_text roundtrip", gui_get_text(inp), "HELLO FLOW")
let _ti3 = check("cursor at end", _gui_input_cursor[int(inp)], 10.0)
// Set empty text
let _sit2 = gui_set_input_text(inp, "")
let _ti4 = check_str("empty text", gui_get_text(inp), "")
let _ti5 = check("cursor at 0", _gui_input_cursor[int(inp)], 0.0)
// OOB set_input_text
let _ti6 = check("set_input_text OOB", gui_set_input_text(-1.0, "X"), 0.0)

// ── H-32: Widget removal ───────────────────────────────────────────
print("23. Widget Removal (H-32)")
// Create a temporary button then remove it
let tmp_btn = gui_button(0.0, 0.0, 50.0, 20.0, "TEMP")
let tmp_id = int(tmp_btn)
let _rm0 = check("tmp btn type before", _gui_types[tmp_id], GUI_BUTTON)
let _rm1 = gui_remove(tmp_btn)
let _rm2 = check("remove returns 1", _rm1, 1.0)
let _rm3 = check("removed type=0", _gui_types[tmp_id], 0.0)
let _rm4 = check("removed visible=0", _gui_visible[tmp_id], 0.0)
let _rm5 = check("removed enabled=0", _gui_enabled[tmp_id], 0.0)
// OOB remove
let _rm6 = check("remove OOB", gui_remove(-1.0), 0.0)
let _rm7 = check("remove OOB 999", gui_remove(999.0), 0.0)

// ── H-24: Theme 30-value check ─────────────────────────────────────
print("24. Theme 30-value Check (H-24)")
// Switch to dark theme and verify all 30 slots are set
let _td2 = gui_theme_dark()
let _tc0 = check("tc[0] bg_r", _tc[0], 30.0)
let _tc1 = check("tc[3] panel_r", _tc[3], 45.0)
let _tc2 = check("tc[6] widget_r", _tc[6], 60.0)
let _tc3 = check("tc[9] hover_r", _tc[9], 75.0)
let _tc4 = check("tc[12] active_r", _tc[12], 90.0)
let _tc5 = check("tc[15] text_r", _tc[15], 220.0)
let _tc6 = check("tc[18] text_dim_r", _tc[18], 140.0)
let _tc7 = check("tc[21] border_r", _tc[21], 80.0)
let _tc8 = check("tc[24] accent_r", _tc[24], 100.0)
let _tc9 = check("tc[27] slider_r", _tc[27], 90.0)

// ── H-24: New themes ───────────────────────────────────────────────
print("25. New Themes (H-24)")
// Midnight theme
let _tmn = gui_theme_midnight()
let _mn1 = check("midnight bg_r", _tc[0], 18.0)
let _mn2 = check("midnight text_r", _tc[15], 210.0)
let _mn3 = check("midnight accent_r", _tc[24], 160.0)
// Forest theme
let _tfo = gui_theme_forest()
let _fo1 = check("forest bg_r", _tc[0], 20.0)
let _fo2 = check("forest bg_g", _tc[1], 30.0)
let _fo3 = check("forest accent_g", _tc[25], 200.0)
// High contrast theme
let _thc = gui_theme_high_contrast()
let _hc1 = check("hicon bg_r", _tc[0], 0.0)
let _hc2 = check("hicon text_r", _tc[15], 255.0)
let _hc3 = check("hicon border_r", _tc[21], 255.0)
let _hc4 = check("hicon accent_r", _tc[24], 255.0)

// ── H-30: Canvas text commands ─────────────────────────────────────
print("26. Canvas Text Commands (H-30)")
// Redraw on canvas after clear
let _ct1 = gui_canvas_text(cvs, 10.0, 10.0, "HELLO", 1.0)
let _ct2 = check("canvas text cmd", _gui_list_count[15], 1.0)
// Check text was stored in buffer
let text_buf_len = len(_gui_canvas_text_buf)
let _ct3 = check("text buf has entry", text_buf_len > 0.0, 1.0)
// Colored text
let _ct4 = gui_canvas_text_colored(cvs, 10.0, 30.0, "RED", 1.0, 255.0, 0.0, 0.0)
let _ct5 = check("canvas 2 text cmds", _gui_list_count[15], 2.0)
// Clear for next tests
let _ct6 = gui_canvas_clear(cvs)

// ── H-21: Canvas init fresh start ──────────────────────────────────
print("27. Canvas Start Isolation (H-21)")
let cvs2 = gui_canvas(0.0, 0.0, 100.0, 100.0)
let _ci1 = check("cvs2 cmd count", _gui_list_count[int(cvs2)], 0.0)
let _ci2 = gui_canvas_line(cvs2, 0.0, 0.0, 50.0, 50.0, 255.0, 255.0, 255.0)
let _ci3 = check("cvs2 has 1 cmd", _gui_list_count[int(cvs2)], 1.0)
// Original canvas should still be cleared
let _ci4 = check("cvs1 still clear", _gui_list_count[15], 0.0)

// ── Layout: vstack positions ───────────────────────────────────────
print("28. VStack Positions")
let vs = vstack(100.0, 50.0, 10.0)
let vs_lbl = vstack_label(vs, "LABEL A")
// Label placed at (100, 50), advance by 20 + 10 spacing = cursor at 80
let _vs1 = check("vstack lbl x", _gui_x[int(vs_lbl)], 100.0)
let _vs2 = check("vstack lbl y", _gui_y[int(vs_lbl)], 50.0)
let vs_btn = vstack_button(vs, 120.0, 36.0, "BTN")
// Button placed at (100, 80), advance by 36 + 10 = cursor at 126
let _vs3 = check("vstack btn x", _gui_x[int(vs_btn)], 100.0)
let _vs4 = check("vstack btn y", _gui_y[int(vs_btn)], 80.0)
let vs_chk = vstack_checkbox(vs, "CHECK")
// Checkbox at (100, 126)
let _vs5 = check("vstack chk y", _gui_y[int(vs_chk)], 126.0)
// Cursor should now be at 126 + 22 + 10 = 158
let _vs6 = check("vstack cursor", vstack_cursor_y(vs), 158.0)

// ── Layout: hstack positions ───────────────────────────────────────
print("29. HStack Positions")
let hs = hstack(200.0, 300.0, 8.0)
let hs_btn1 = hstack_button(hs, 80.0, 30.0, "A")
let _hs1 = check("hstack btn1 x", _gui_x[int(hs_btn1)], 200.0)
let _hs2 = check("hstack btn1 y", _gui_y[int(hs_btn1)], 300.0)
let hs_btn2 = hstack_button(hs, 80.0, 30.0, "B")
// Second button at x = 200 + 80 + 8 = 288
let _hs3 = check("hstack btn2 x", _gui_x[int(hs_btn2)], 288.0)
let _hs4 = check("hstack btn2 y", _gui_y[int(hs_btn2)], 300.0)

// ── Layout: grid positions ─────────────────────────────────────────
print("30. Grid Positions")
let g = grid(20.0, 20.0, 3.0, 100.0, 36.0, 4.0)
let g_b00 = grid_button(g, 0.0, 0.0, "A")
let g_b01 = grid_button(g, 0.0, 1.0, "B")
let g_b10 = grid_button(g, 1.0, 0.0, "C")
// (0,0) at (20, 20)
let _g1 = check("grid 0,0 x", _gui_x[int(g_b00)], 20.0)
let _g2 = check("grid 0,0 y", _gui_y[int(g_b00)], 20.0)
// (0,1) at (20 + 1*(100+4), 20) = (124, 20)
let _g3 = check("grid 0,1 x", _gui_x[int(g_b01)], 124.0)
let _g4 = check("grid 0,1 y", _gui_y[int(g_b01)], 20.0)
// (1,0) at (20, 20 + 1*(36+4)) = (20, 60)
let _g5 = check("grid 1,0 x", _gui_x[int(g_b10)], 20.0)
let _g6 = check("grid 1,0 y", _gui_y[int(g_b10)], 60.0)

// ── H-36: Animation easing ─────────────────────────────────────────
print("31. Animation Easing (H-36)")
// ease_linear(0.5) = 0.5
let _el1 = check("ease_linear 0", ease_linear(0.0), 0.0)
let _el2 = check("ease_linear 1", ease_linear(1.0), 1.0)
let _el3 = check("ease_linear 0.5", ease_linear(0.5), 0.5)
// ease_in(0.5) = 0.25
let _ei1 = check("ease_in 0.5", ease_in(0.5), 0.25)
let _ei2 = check("ease_in 0", ease_in(0.0), 0.0)
let _ei3 = check("ease_in 1", ease_in(1.0), 1.0)
// ease_out(0.0) = 0.0, ease_out(1.0) = 1.0
let _eo1 = check("ease_out 0", ease_out(0.0), 0.0)
let _eo2 = check("ease_out 1", ease_out(1.0), 1.0)

// ── H-36: Animation create + step ──────────────────────────────────
print("32. Animation Create/Step (H-36)")
let anim = gui_anim_create(0.0, 100.0, 1000.0, "linear")
let _a1 = check("anim created", anim >= 0.0, 1.0)
let _a2 = check("anim not done", gui_anim_done(anim), 0.0)
// Step 500ms — should be at 50.0 (linear, 0→100 over 1000ms)
let val_half = gui_anim_step(anim, 500.0)
let _a3 = check("anim half", val_half, 50.0)
// Step another 500ms — should be done at 100.0
let val_full = gui_anim_step(anim, 500.0)
let _a4 = check("anim full", val_full, 100.0)
let _a5 = check("anim done", gui_anim_done(anim), 1.0)
// Reset
let _ar = gui_anim_reset(anim)
let _a6 = check("anim reset not done", gui_anim_done(anim), 0.0)

// ── H-36: Lerp helper ──────────────────────────────────────────────
print("33. Lerp Helper (H-36)")
let _lp1 = check("lerp 0", gui_lerp(10.0, 20.0, 0.0), 10.0)
let _lp2 = check("lerp 1", gui_lerp(10.0, 20.0, 1.0), 20.0)
let _lp3 = check("lerp 0.5", gui_lerp(10.0, 20.0, 0.5), 15.0)
let _lp4 = check("lerp neg", gui_lerp(0.0, 100.0, 0.25), 25.0)

// ── H-23: Dropdown list_start init ─────────────────────────────────
print("34. Dropdown Init (H-23)")
// Create a fresh dropdown — list_start should be set at creation
let dd2 = gui_dropdown(0.0, 0.0, 100.0)
let dd2_ii = int(dd2)
let dd2_start = _gui_list_start[dd2_ii]
// Start should be >= 0 and point into list_items
let _di1 = check("dd2 start >= 0", dd2_start >= 0.0, 1.0)
// Add items and verify they come back correctly
let _da4 = gui_dropdown_add(dd2, "FIRST")
let _da5 = gui_dropdown_add(dd2, "SECOND")
let _di2 = check("dd2 count", _gui_list_count[dd2_ii], 2.0)
let _di3 = check_str("dd2 item 0", gui_dropdown_text(dd2, 0.0), "FIRST")
let _di4 = check_str("dd2 item 1", gui_dropdown_text(dd2, 1.0), "SECOND")
let _di5 = check("dd2 auto select 0", gui_dropdown_selected(dd2), 0.0)

// ── Listbox OOB item access ────────────────────────────────────────
print("35. Listbox OOB Item Access")
let _lo1 = check_str("listbox text OOB idx -1", gui_listbox_text(lst, -1.0), "")
let _lo2 = check_str("listbox text OOB idx 99", gui_listbox_text(lst, 99.0), "")
let _lo3 = check_str("dropdown text OOB idx -1", gui_dropdown_text(dd, -1.0), "")
let _lo4 = check_str("dropdown text OOB idx 99", gui_dropdown_text(dd, 99.0), "")

// ── _gui_id_ok helper ──────────────────────────────────────────────
print("36. _gui_id_ok Helper")
let _ok1 = check("id_ok valid", _gui_id_ok(0.0), 1.0)
let _ok2 = check("id_ok last", _gui_id_ok(btn), 1.0)
let _ok3 = check("id_ok -1", _gui_id_ok(-1.0), 0.0)
let _ok4 = check("id_ok 99999", _gui_id_ok(99999.0), 0.0)

// ── Summary ────────────────────────────────────────────────────────
let total = _tcount[0] + _tcount[1]
let passed = _tcount[0]
let failed = _tcount[1]
print(" ")
print("=== Results: {passed}/{total} passed ===")
if failed > 0.0
  print("FAILURES: {failed}")
end
