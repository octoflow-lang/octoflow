// test_plot.flow — Plot Library Tests
//
// Tests plot creation, series types, coordinate mapping,
// autoscale, and candle rendering without a GUI window.
//
// Usage:
//   octoflow run stdlib/gui/test_plot.flow

use "gui"
use "plot"

let mut _tcount = [0.0, 0.0]

fn check(name, got, expected)
  if got == expected
    _tcount[0] = _tcount[0] + 1.0
    return 1.0
  end
  print("  FAIL: {name} — got {got}, expected {expected}")
  _tcount[1] = _tcount[1] + 1.0
  return 0.0
end

fn check_range(name, got, lo, hi)
  if got >= lo
    if got <= hi
      _tcount[0] = _tcount[0] + 1.0
      return 1.0
    end
  end
  print("  FAIL: {name} — got {got}, expected [{lo}..{hi}]")
  _tcount[1] = _tcount[1] + 1.0
  return 0.0
end

print("=== Plot Library Tests ===")

// ── 1. Plot Creation ────────────────────────────────────────────────
print("1. Plot creation")
let cvs = gui_canvas(10.0, 10.0, 400.0, 300.0)
let p = plot_create(cvs, 0.0, 100.0, 0.0, 50.0)
let _c1 = check("plot id", p, 0.0)
let _c2 = check("canvas stored", _plot_canvas[0], cvs)
let _c3 = check("x_min", _plot_x_min[0], 0.0)
let _c4 = check("x_max", _plot_x_max[0], 100.0)
let _c5 = check("y_min", _plot_y_min[0], 0.0)
let _c6 = check("y_max", _plot_y_max[0], 50.0)

// ── 2. Padding ──────────────────────────────────────────────────────
print("2. Padding")
let _sp = plot_set_padding(p, 40.0, 30.0)
let _c7 = check("pad_left", _plot_pad_left[0], 40.0)
let _c8 = check("pad_bottom", _plot_pad_bottom[0], 30.0)
// Reset for simpler coordinate tests
let _sp2 = plot_set_padding(p, 0.0, 0.0)

// ── 3. Coordinate Mapping ───────────────────────────────────────────
print("3. Coordinate mapping")
// With range 0-100 and canvas width 400, x=50 should map to 200
let mx = _plot_map_x(p, 50.0)
let _c9 = check("map_x center", mx, 200.0)
let mx0 = _plot_map_x(p, 0.0)
let _c10 = check("map_x min", mx0, 0.0)
let mx100 = _plot_map_x(p, 100.0)
let _c11 = check("map_x max", mx100, 400.0)
// Y mapping is inverted: y=50 → top (0), y=0 → bottom (300)
let my0 = _plot_map_y(p, 0.0)
let _c12 = check("map_y min", my0, 300.0)
let my50 = _plot_map_y(p, 50.0)
let _c13 = check("map_y max", my50, 0.0)
let my25 = _plot_map_y(p, 25.0)
let _c14 = check("map_y center", my25, 150.0)

// ── 4. Line Series ──────────────────────────────────────────────────
print("4. Line series")
let mut x_data = [0.0, 25.0, 50.0, 75.0, 100.0]
let mut y_data = [10.0, 30.0, 20.0, 40.0, 15.0]
let s1 = plot_series_line(p, x_data, y_data, 255.0, 0.0, 0.0)
let _c15 = check("line series id", s1, 0.0)
let _c16 = check("line type", _pseries_type[0], PLOT_LINE)
let _c17 = check("line count", _pseries_count[0], 5.0)
let _c18 = check("line color r", _pseries_r[0], 255.0)

// ── 5. Scatter Series ───────────────────────────────────────────────
print("5. Scatter series")
let mut sx_data = [10.0, 50.0, 90.0]
let mut sy_data = [5.0, 25.0, 45.0]
let s2 = plot_series_scatter(p, sx_data, sy_data, 0.0, 255.0, 0.0)
let _c19 = check("scatter series id", s2, 1.0)
let _c20 = check("scatter type", _pseries_type[1], PLOT_SCATTER)
let _c21 = check("scatter count", _pseries_count[1], 3.0)

// ── 6. Bar Series ───────────────────────────────────────────────────
print("6. Bar series")
let mut bx = [10.0, 30.0, 50.0, 70.0]
let mut by = [20.0, 35.0, 15.0, 40.0]
let s3 = plot_series_bar(p, bx, by, 0.0, 0.0, 255.0, 15.0)
let _c22 = check("bar series id", s3, 2.0)
let _c23 = check("bar type", _pseries_type[2], PLOT_BAR)
let _c24 = check("bar extra (width)", _pseries_extra[2], 15.0)

// ── 7. Candle Series ────────────────────────────────────────────────
print("7. Candle series")
let mut cx = [1.0, 2.0, 3.0, 4.0, 5.0]
let mut co = [100.0, 105.0, 102.0, 98.0, 110.0]
let mut ch2 = [110.0, 108.0, 106.0, 105.0, 115.0]
let mut cl = [95.0, 100.0, 97.0, 92.0, 108.0]
let mut cc = [105.0, 102.0, 98.0, 104.0, 112.0]
let s4 = plot_series_candle(p, cx, co, ch2, cl, cc, 0.0, 200.0, 0.0, 200.0, 0.0, 0.0)
let _c25 = check("candle series id", s4, 3.0)
let _c26 = check("candle type", _pseries_type[3], PLOT_CANDLE)
let _c27 = check("candle count", _pseries_count[3], 5.0)
let _c28 = check("candle open[0]", _pcandle_open[0], 100.0)
let _c29 = check("candle high[0]", _pcandle_high[0], 110.0)
let _c30 = check("candle low[0]", _pcandle_low[0], 95.0)
let _c31 = check("candle close[0]", _pcandle_close[0], 105.0)
let _c32 = check("candle up color r", _pcandle_up_r[0], 0.0)
let _c33 = check("candle up color g", _pcandle_up_g[0], 200.0)
let _c34 = check("candle dn color r", _pcandle_dn_r[0], 200.0)

// ── 8. Autoscale ────────────────────────────────────────────────────
print("8. Autoscale")
// Create a fresh plot for autoscale test
let cvs2 = gui_canvas(10.0, 320.0, 200.0, 200.0)
let p2 = plot_create(cvs2, 0.0, 1.0, 0.0, 1.0)
let mut ax = [10.0, 20.0, 30.0]
let mut ay = [100.0, 200.0, 150.0]
let _as1 = plot_series_line(p2, ax, ay, 255.0, 255.0, 255.0)
let _auto = plot_autoscale(p2)
let p2i = int(p2)
// After autoscale: x range should be ~[10-pad, 30+pad], y ~[100-pad, 200+pad]
// pad = range * 0.05 = 20*0.05=1 for x, 100*0.05=5 for y
let _c35 = check("auto x_min", _plot_x_min[p2i], 9.0)
let _c36 = check("auto x_max", _plot_x_max[p2i], 31.0)
let _c37 = check("auto y_min", _plot_y_min[p2i], 95.0)
let _c38 = check("auto y_max", _plot_y_max[p2i], 205.0)

// ── 9. Plot Draw (smoke test) ───────────────────────────────────────
print("9. Plot draw (smoke test)")
let _draw = plot_draw(p2)
// Just check it doesn't crash. Canvas should have commands.
let cvs2_id = int(cvs2)
let cmd_count = _gui_list_count[cvs2_id]
let _c39 = check_range("draw produced commands", cmd_count, 1.0, 9999.0)

// ── 10. Set Range ───────────────────────────────────────────────────
print("10. Set range")
let _sr = plot_set_range(p, 10.0, 90.0, 5.0, 45.0)
let _c40 = check("set x_min", _plot_x_min[0], 10.0)
let _c41 = check("set x_max", _plot_x_max[0], 90.0)
let _c42 = check("set y_min", _plot_y_min[0], 5.0)
let _c43 = check("set y_max", _plot_y_max[0], 45.0)

// ── 11. Clear ───────────────────────────────────────────────────────
print("11. Plot clear")
let _pc = plot_clear(p2)
// After clear, series counts should be 0 for p2's series
// s_as1 is the only series on p2 — it's series index 4
let _c44 = check("clear zeroes count", _pseries_count[4], 0.0)

// ── 12. Grid Lines ──────────────────────────────────────────────────
print("12. Grid lines")
let cvs3 = gui_canvas(10.0, 530.0, 200.0, 200.0)
let p3 = plot_create(cvs3, 0.0, 100.0, 0.0, 100.0)
let _g = plot_grid(p3, 5.0, 5.0)
// Grid should produce 8 lines (4 vertical + 4 horizontal, skipping endpoints)
let cvs3_id = int(cvs3)
let grid_cmds = _gui_list_count[cvs3_id]
let _c45 = check("grid lines", grid_cmds, 8.0)

// ── 13. Second plot creation ────────────────────────────────────────
print("13. Multiple plots")
let _c46 = check("plot count", len(_plot_canvas), 3.0)

// ── 14. Candle autoscale ────────────────────────────────────────────
print("14. Candle autoscale")
let cvs4 = gui_canvas(10.0, 740.0, 200.0, 200.0)
let p4 = plot_create(cvs4, 0.0, 1.0, 0.0, 1.0)
let mut cx2 = [1.0, 2.0, 3.0]
let mut co2 = [100.0, 105.0, 110.0]
let mut ch3 = [112.0, 108.0, 115.0]
let mut cl2 = [98.0, 101.0, 107.0]
let mut cc2 = [105.0, 103.0, 112.0]
let _cs2 = plot_series_candle(p4, cx2, co2, ch3, cl2, cc2, 0.0, 255.0, 0.0, 255.0, 0.0, 0.0)
let _auto2 = plot_autoscale(p4)
let p4i = int(p4)
// Y range should span from min(low)=98 to max(high)=115, with 5% padding = 0.85
let _c47 = check_range("candle auto y_min", _plot_y_min[p4i], 96.0, 98.5)
let _c48 = check_range("candle auto y_max", _plot_y_max[p4i], 114.5, 116.0)

// ── Summary ─────────────────────────────────────────────────────────
let total = _tcount[0] + _tcount[1]
let passed = _tcount[0]
let failed = _tcount[1]
print(" ")
print("=== Results: {passed}/{total} passed ===")
if failed > 0.0
  print("FAILURES: {failed}")
end
