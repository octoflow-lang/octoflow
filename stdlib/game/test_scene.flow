// test_scene.flow — Tests for stdlib/game/scene.flow
use "scene"

fn check(name, cond)
    if cond
        print("PASS: {name}")
    else
        print("FAIL: {name}")
        assert(0.0 == 1.0, name)
    end
    return 0.0
end

fn approx(a, b)
    if abs(a - b) < 0.01
        return 1.0
    end
    return 0.0
end

// ── Create scene ────────────────────────────────────────

fn test_create()
    let sc = scene_create()
    check("create empty", scene_entity_count(sc) == 0.0)
    check("create active", scene_active_count(sc) == 0.0)
    return 0.0
end

// ── Add entities ────────────────────────────────────────

fn test_add()
    let sc = scene_create()
    let e0 = scene_add_entity(sc)
    let e1 = scene_add_entity(sc)
    check("add e0", e0 == 0.0)
    check("add e1", e1 == 1.0)
    check("add count", scene_entity_count(sc) == 2.0)
    check("add active", scene_active_count(sc) == 2.0)
    return 0.0
end

// ── Position component ──────────────────────────────────

fn test_position()
    let sc = scene_create()
    let e = scene_add_entity(sc)
    let _p = scene_set_pos(sc, e, 100.5, 200.3)
    let mut pos = [0.0, 0.0]
    let has = scene_get_pos(sc, e, pos)
    check("pos has", has == 1.0)
    check("pos x", approx(pos[0], 100.5) == 1.0)
    check("pos y", approx(pos[1], 200.3) == 1.0)
    return 0.0
end

// ── Velocity component ──────────────────────────────────

fn test_velocity()
    let sc = scene_create()
    let e = scene_add_entity(sc)
    let _v = scene_set_vel(sc, e, 5.0, -3.0)
    let mut vel = [0.0, 0.0]
    let has = scene_get_vel(sc, e, vel)
    check("vel has", has == 1.0)
    check("vel vx", vel[0] == 5.0)
    check("vel vy", vel[1] == -3.0)
    // Entity without velocity
    let e2 = scene_add_entity(sc)
    let mut vel2 = [0.0, 0.0]
    let has2 = scene_get_vel(sc, e2, vel2)
    check("vel no has", has2 == 0.0)
    return 0.0
end

// ── Health component ────────────────────────────────────

fn test_health()
    let sc = scene_create()
    let e = scene_add_entity(sc)
    let _h = scene_set_hp(sc, e, 100.0)
    check("hp get", scene_get_hp(sc, e) == 100.0)
    // No health
    let e2 = scene_add_entity(sc)
    check("hp no has", scene_get_hp(sc, e2) == -1.0)
    return 0.0
end

// ── Tags ────────────────────────────────────────────────

fn test_tags()
    let sc = scene_create()
    let e0 = scene_add_entity(sc)
    let _t0 = scene_set_tag(sc, e0, "player")
    let e1 = scene_add_entity(sc)
    let _t1 = scene_set_tag(sc, e1, "enemy")
    let e2 = scene_add_entity(sc)
    let _t2 = scene_set_tag(sc, e2, "enemy")
    check("tag get", scene_get_tag(sc, e0) == "player")
    check("tag find", scene_find_by_tag(sc, "player") == 0.0)
    check("tag find enemy", scene_find_by_tag(sc, "enemy") == 1.0)
    check("tag find miss", scene_find_by_tag(sc, "npc") == -1.0)
    // Find all enemies
    let mut enemies = []
    let n = scene_find_all_by_tag(sc, "enemy", enemies)
    check("tag find all", n == 2.0)
    return 0.0
end

// ── Remove entity ───────────────────────────────────────

fn test_remove()
    let sc = scene_create()
    let e0 = scene_add_entity(sc)
    let _t = scene_set_tag(sc, e0, "temp")
    let e1 = scene_add_entity(sc)
    let _r = scene_remove_entity(sc, e0)
    check("remove active", scene_active_count(sc) == 1.0)
    check("remove total", scene_entity_count(sc) == 2.0)
    check("remove inactive", scene_is_active(sc, e0) == 0.0)
    check("remove other active", scene_is_active(sc, e1) == 1.0)
    // Find by tag should skip removed
    check("remove tag skip", scene_find_by_tag(sc, "temp") == -1.0)
    return 0.0
end

// ── Custom properties ───────────────────────────────────

fn test_custom()
    let sc = scene_create()
    let e = scene_add_entity(sc)
    let _c1 = scene_set_custom(sc, e, "damage", 25.0)
    let _c2 = scene_set_custom(sc, e, "speed", 5.5)
    check("custom damage", scene_get_custom(sc, e, "damage") == 25.0)
    check("custom speed", approx(scene_get_custom(sc, e, "speed"), 5.5) == 1.0)
    return 0.0
end

// ── Spawn at ────────────────────────────────────────────

fn test_spawn()
    let sc = scene_create()
    let e = scene_spawn_at(sc, "goblin", 50.0, 75.0, 30.0)
    check("spawn tag", scene_get_tag(sc, e) == "goblin")
    let mut pos = [0.0, 0.0]
    let _p = scene_get_pos(sc, e, pos)
    check("spawn x", pos[0] == 50.0)
    check("spawn y", pos[1] == 75.0)
    check("spawn hp", scene_get_hp(sc, e) == 30.0)
    return 0.0
end

// ── Save and load ───────────────────────────────────────

fn test_save_load()
    let sc = scene_create()
    let _e0 = scene_spawn_at(sc, "hero", 100.0, 200.0, 100.0)
    let _e1 = scene_spawn_at(sc, "chest", 300.0, 150.0, 0.0)
    // Save
    let saved = scene_save(sc)
    // Load into new scene
    let sc2 = scene_load(saved)
    check("load count", scene_entity_count(sc2) == 2.0)
    check("load tag", scene_get_tag(sc2, 0.0) == "hero")
    let mut pos = [0.0, 0.0]
    let _p = scene_get_pos(sc2, 0.0, pos)
    check("load pos x", pos[0] == 100.0)
    check("load pos y", pos[1] == 200.0)
    return 0.0
end

// ── Merge scenes ────────────────────────────────────────

fn test_merge()
    let sc1 = scene_create()
    let _e0 = scene_spawn_at(sc1, "a", 10.0, 20.0, 50.0)
    let sc2 = scene_create()
    let _e1 = scene_spawn_at(sc2, "b", 30.0, 40.0, 75.0)
    let _e2 = scene_spawn_at(sc2, "c", 50.0, 60.0, 25.0)
    let added = scene_merge(sc1, sc2)
    check("merge added", added == 2.0)
    check("merge total", scene_entity_count(sc1) == 3.0)
    check("merge tag", scene_get_tag(sc1, 1.0) == "b")
    return 0.0
end

// ── Clear ───────────────────────────────────────────────

fn test_clear()
    let sc = scene_create()
    let _e = scene_spawn_at(sc, "x", 0.0, 0.0, 10.0)
    let _c = scene_clear(sc)
    check("clear count", scene_entity_count(sc) == 0.0)
    return 0.0
end

// ── Run all ─────────────────────────────────────────────

test_create()
test_add()
test_position()
test_velocity()
test_health()
test_tags()
test_remove()
test_custom()
test_spawn()
test_save_load()
test_merge()
test_clear()
print("")
print("All scene tests passed (12 tests)")
