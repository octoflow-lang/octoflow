// test_gpu_scan.flow — GPU Prefix Sum (Scan) unit test
//
// Test 1: Small array (N=8) — single workgroup, verify exact prefix sums
//   Input:  [1, 2, 3, 4, 5, 6, 7, 8]
//   Output: [1, 3, 6, 10, 15, 21, 28, 36]  (inclusive scan)
//
// Test 2: Larger array (N=256) — still single workgroup
//   Input:  [1, 1, 1, ..., 1]  (256 ones)
//   Output: [1, 2, 3, ..., 256]
//
// Run: octoflow run stdlib/tests/test_gpu_scan.flow --allow-ffi --allow-read

use "../gpu/runtime"

rt_init()

let pipe_scan = rt_load_pipeline("tests/gpu_shaders/32_scan_sum.spv", 2.0, 4.0)

// ── Test 1: N=8 exact prefix sums ────────────────────────────────────
let N1 = 8.0
let PAD1 = 512.0

let mut input1 = []
let mut i = 0.0
while i < PAD1
  if i < N1
    push(input1, i + 1.0)
  else
    push(input1, 0.0)
  end
  i = i + 1.0
end

let buf_in1 = rt_create_buffer(PAD1 * 4.0)
let buf_out1 = rt_create_buffer(PAD1 * 4.0)
rt_upload(buf_in1, input1)

let mut zeros = []
let mut i = 0.0
while i < PAD1
  push(zeros, 0.0)
  i = i + 1.0
end
rt_upload(buf_out1, zeros)

rt_chain_begin(1.0, 2.0)
let mut pc1 = [N1]
rt_chain_push_constants(pipe_scan, pc1)
let mut bufs1 = [buf_in1, buf_out1]
rt_chain_dispatch(pipe_scan, bufs1, 1.0)
rt_chain_end()
rt_chain_submit_wait()

rt_download(buf_out1, N1)

let mut expected1 = [1.0, 3.0, 6.0, 10.0, 15.0, 21.0, 28.0, 36.0]

let mut pass1 = 1.0
print("Test 1: Prefix sum of [1..8]:")
let mut i = 0.0
while i < N1
  let got = rt_result[int(i)]
  let exp = expected1[int(i)]
  if got != exp
    print("  FAIL: index {i} got={got} expected={exp}")
    pass1 = 0.0
  end
  i = i + 1.0
end

let r0 = rt_result[0]
let r1 = rt_result[1]
let r2 = rt_result[2]
let r7 = rt_result[7]
print("  Result: [{r0}, {r1}, {r2}, ..., {r7}]")
if pass1 == 1.0
  print("  PASS: Test 1 BIT EXACT")
end

// ── Test 2: N=256 ones → [1, 2, 3, ..., 256] ────────────────────────
let N2 = 256.0

let mut input2 = []
let mut i = 0.0
while i < PAD1
  if i < N2
    push(input2, 1.0)
  else
    push(input2, 0.0)
  end
  i = i + 1.0
end

let buf_in2 = rt_create_buffer(PAD1 * 4.0)
let buf_out2 = rt_create_buffer(PAD1 * 4.0)
rt_upload(buf_in2, input2)
rt_upload(buf_out2, zeros)

rt_chain_begin(1.0, 2.0)
let mut pc2 = [N2]
rt_chain_push_constants(pipe_scan, pc2)
let mut bufs2 = [buf_in2, buf_out2]
rt_chain_dispatch(pipe_scan, bufs2, 1.0)
rt_chain_end()
rt_chain_submit_wait()

rt_download(buf_out2, N2)

let mut pass2 = 1.0
let mut i = 0.0
while i < N2
  let got = rt_result[int(i)]
  let exp = i + 1.0
  if got != exp
    print("  FAIL: index {i} got={got} expected={exp}")
    pass2 = 0.0
  end
  i = i + 1.0
end

let s0 = rt_result[0]
let s1 = rt_result[1]
let s255 = rt_result[255]
print("Test 2: Prefix sum of 256 ones:")
print("  Result: [{s0}, {s1}, ..., {s255}]")
if pass2 == 1.0
  print("  PASS: Test 2 BIT EXACT")
end

// ── Overall ──────────────────────────────────────────────────────────
if pass1 == 1.0
  if pass2 == 1.0
    print("PASS: gpu_scan all tests BIT EXACT")
  end
end

rt_cleanup()
