// test_timeline_semaphore.flow — Tier 3: Timeline Semaphore Test
// 30 doublings across 3 timeline-synchronized submissions.
// 0 fences. GPU manages all inter-submission synchronization.
//
// Run: octoflow run stdlib/tests/test_timeline_semaphore.flow --allow-ffi --allow-read

use "../gpu/runtime"

let N = 256.0
let BUF_BYTES = N * 4.0
let DOUBLINGS = 10.0

rt_init()

let pipe = rt_load_pipeline("tests/gpu_shaders/01_double.spv", 2.0, 0.0)

let buf_a = rt_create_buffer(BUF_BYTES)
let buf_b = rt_create_buffer(BUF_BYTES)

// Upload: [1, 2, 3, ..., 256]
let mut data = []
let mut i = 0.0
while i < N
  push(data, i + 1.0)
  i = i + 1.0
end
rt_upload(buf_a, data)

// Zero buf_b
let mut zeros = []
let mut i = 0.0
while i < N
  push(zeros, 0.0)
  i = i + 1.0
end
rt_upload(buf_b, zeros)

// Create timeline semaphore (initial=0)
let sem = rt_create_timeline_semaphore(0.0)

// Ping-pong buffer pairs
let mut bufs_ab = [buf_a, buf_b]
let mut bufs_ba = [buf_b, buf_a]

// ── Submit 1: 10 doublings, signal timeline=1 ──────────────────────
rt_chain_begin(DOUBLINGS, 2.0)
let mut d = 0.0
let mut use_ab = 1.0
while d < DOUBLINGS
  if use_ab == 1.0
    rt_chain_dispatch(pipe, bufs_ab, 1.0)
    use_ab = 0.0
  else
    rt_chain_dispatch(pipe, bufs_ba, 1.0)
    use_ab = 1.0
  end
  d = d + 1.0
end
rt_chain_end()
rt_chain_submit_timeline(0.0 - 1.0, 0.0, sem, 1.0)

// ── Submit 2: 10 doublings, wait>=1, signal=2 ──────────────────────
rt_chain_begin(DOUBLINGS, 2.0)
let mut d = 0.0
let mut use_ab = 1.0
while d < DOUBLINGS
  if use_ab == 1.0
    rt_chain_dispatch(pipe, bufs_ab, 1.0)
    use_ab = 0.0
  else
    rt_chain_dispatch(pipe, bufs_ba, 1.0)
    use_ab = 1.0
  end
  d = d + 1.0
end
rt_chain_end()
rt_chain_submit_timeline(sem, 1.0, sem, 2.0)

// ── Submit 3: 10 doublings, wait>=2, signal=3 ──────────────────────
rt_chain_begin(DOUBLINGS, 2.0)
let mut d = 0.0
let mut use_ab = 1.0
while d < DOUBLINGS
  if use_ab == 1.0
    rt_chain_dispatch(pipe, bufs_ab, 1.0)
    use_ab = 0.0
  else
    rt_chain_dispatch(pipe, bufs_ba, 1.0)
    use_ab = 1.0
  end
  d = d + 1.0
end
rt_chain_end()
rt_chain_submit_timeline(sem, 2.0, sem, 3.0)

// ── CPU wait for timeline >= 3 ─────────────────────────────────────
rt_wait_semaphore(sem, 3.0)
rt_chain_reset()

// ── Verify ─────────────────────────────────────────────────────────
rt_download(buf_a, 4.0)

// 30 doublings: 2^30 = 1073741824 (power of 2, exact in f32)
let expected = 1073741824.0
let v0 = rt_result[0]

if v0 == expected
  print("PASS: timeline_semaphore v0={v0} (3 submits, 30 doublings, 0 fences)")
else
  print("FAIL: timeline_semaphore v0={v0} expected={expected}")
end

rt_cleanup()
