// test_regression.flow â€” Tests for stdlib/ml/regression.flow
// Functions tested: linear regression, prediction, r_squared

let mut pass = 0.0
let mut fail = 0.0

// -- Helper: r_squared (only uses arrays, no maps) --
fn r_squared(y_actual, y_predicted)
  let n = len(y_actual)
  let m = mean(y_actual)
  let mut ss_res = 0.0
  let mut ss_tot = 0.0
  let mut i = 0.0
  while i < n
    ss_res = ss_res + (y_actual[i] - y_predicted[i]) * (y_actual[i] - y_predicted[i])
    ss_tot = ss_tot + (y_actual[i] - m) * (y_actual[i] - m)
    i = i + 1.0
  end
  if ss_tot == 0.0
    return 0.0
  end
  return 1.0 - ss_res / ss_tot
end

// -- Tests --

print("=== test_regression ===")

// Perfect linear data: y = 2x + 1
let x = [1.0, 2.0, 3.0, 4.0, 5.0]
let y = [3.0, 5.0, 7.0, 9.0, 11.0]

// Inline linear regression computation
let n = len(x)
let mx = mean(x)
let my = mean(y)
let mut sxy = 0.0
let mut sxx = 0.0
let mut i = 0.0
while i < n
  sxy = sxy + (x[i] - mx) * (y[i] - my)
  sxx = sxx + (x[i] - mx) * (x[i] - mx)
  i = i + 1.0
end
let slope = sxy / sxx
let intercept = my - slope * mx

// Slope should be 2.0
let diff_slope = abs(slope - 2.0)
if diff_slope < 0.001
  pass = pass + 1.0
else
  print("  FAIL: slope expected 2.0 got {slope}")
  fail = fail + 1.0
end

// Intercept should be 1.0
let diff_int = abs(intercept - 1.0)
if diff_int < 0.001
  pass = pass + 1.0
else
  print("  FAIL: intercept expected 1.0 got {intercept}")
  fail = fail + 1.0
end

// Predict at x=6 should give 13
let pred6 = slope * 6.0 + intercept
let diff_pred = abs(pred6 - 13.0)
if diff_pred < 0.001
  pass = pass + 1.0
else
  print("  FAIL: predict(6) expected 13.0 got {pred6}")
  fail = fail + 1.0
end

// R-squared for perfect fit should be 1.0
// Compute predictions for all x
let mut y_hat = []
let mut j = 0.0
while j < n
  push(y_hat, slope * x[j] + intercept)
  j = j + 1.0
end
let r2 = r_squared(y, y_hat)
let diff_r2 = abs(r2 - 1.0)
if diff_r2 < 0.001
  pass = pass + 1.0
else
  print("  FAIL: r_squared expected 1.0 got {r2}")
  fail = fail + 1.0
end

// Noisy data: R-squared should be < 1 but > 0
let y_noisy = [3.1, 4.8, 7.2, 8.9, 11.1]
let my2 = mean(y_noisy)
let mut sxy2 = 0.0
let mut sxx2 = 0.0
let mut k = 0.0
while k < n
  sxy2 = sxy2 + (x[k] - mx) * (y_noisy[k] - my2)
  sxx2 = sxx2 + (x[k] - mx) * (x[k] - mx)
  k = k + 1.0
end
let slope2 = sxy2 / sxx2
let intercept2 = my2 - slope2 * mx
let mut y_hat2 = []
let mut l = 0.0
while l < n
  push(y_hat2, slope2 * x[l] + intercept2)
  l = l + 1.0
end
let r2_noisy = r_squared(y_noisy, y_hat2)
if r2_noisy > 0.9 && r2_noisy <= 1.0
  pass = pass + 1.0
else
  print("  FAIL: r_squared noisy expected 0.9-1.0 got {r2_noisy}")
  fail = fail + 1.0
end

// Summary
let total = pass + fail
print("")
print("--- test_regression ---")
print("  pass: {pass}/{total}")
if fail > 0.0
  print("  FAIL: {fail} failures")
else
  print("  ALL PASS")
end
