// test_gpu_sliding.flow — GPU Sliding Window unit test
//
// Test 1: Sliding sum, W=3, input=[1,2,3,4,5]
//   Expected: [1, 3, 6, 9, 12]
//   (1), (1+2), (1+2+3), (2+3+4), (3+4+5)
//
// Test 2: Sliding average (moving average), W=4, input=[2,4,6,8,10,12]
//   Expected: [2.0, 3.0, 4.0, 5.0, 7.0, 9.0]
//   (2/1), (6/2), (12/3), (20/4), (28/4), (36/4)
//
// Run: octoflow run stdlib/tests/test_gpu_sliding.flow --allow-ffi --allow-read

use "../gpu/runtime"

rt_init()

let pipe_sum = rt_load_pipeline("tests/gpu_shaders/39_sliding_sum.spv", 2.0, 8.0)
let pipe_avg = rt_load_pipeline("tests/gpu_shaders/40_sliding_avg.spv", 2.0, 8.0)

// ── Test 1: Sliding sum, W=3 ───────────────────────────────────────
let N1 = 5.0
let W1 = 3.0
let mut input1 = [1.0, 2.0, 3.0, 4.0, 5.0]
let mut expected1 = [1.0, 3.0, 6.0, 9.0, 12.0]

let buf_in1 = rt_create_buffer(N1 * 4.0)
let buf_out1 = rt_create_buffer(N1 * 4.0)
rt_upload(buf_in1, input1)

rt_chain_begin(1.0, 2.0)
let mut pc1 = [N1, W1]
rt_chain_push_constants(pipe_sum, pc1)
let mut bufs1 = [buf_in1, buf_out1]
rt_chain_dispatch(pipe_sum, bufs1, 1.0)
rt_chain_end()
rt_chain_submit_wait()

rt_download(buf_out1, N1)

let mut pass1 = 1.0
print("Test 1: Sliding sum W=3 of [1,2,3,4,5]:")
let mut i = 0.0
while i < N1
  let got = rt_result[int(i)]
  let exp = expected1[int(i)]
  if got != exp
    print("  FAIL: index {i} got={got} expected={exp}")
    pass1 = 0.0
  end
  i = i + 1.0
end

let r0 = rt_result[0]
let r2 = rt_result[2]
let r4 = rt_result[4]
print("  Result: [{r0}, ..., {r2}, ..., {r4}]")
if pass1 == 1.0
  print("  PASS: Test 1 BIT EXACT")
end

// ── Test 2: Sliding average, W=4 ──────────────────────────────────
let N2 = 6.0
let W2 = 4.0
let mut input2 = [2.0, 4.0, 6.0, 8.0, 10.0, 12.0]
let mut expected2 = [2.0, 3.0, 4.0, 5.0, 7.0, 9.0]

let buf_in2 = rt_create_buffer(N2 * 4.0)
let buf_out2 = rt_create_buffer(N2 * 4.0)
rt_upload(buf_in2, input2)

rt_chain_begin(1.0, 2.0)
let mut pc2 = [N2, W2]
rt_chain_push_constants(pipe_avg, pc2)
let mut bufs2 = [buf_in2, buf_out2]
rt_chain_dispatch(pipe_avg, bufs2, 1.0)
rt_chain_end()
rt_chain_submit_wait()

rt_download(buf_out2, N2)

let mut pass2 = 1.0
print("Test 2: Moving average W=4 of [2,4,6,8,10,12]:")
let mut i = 0.0
while i < N2
  let got = rt_result[int(i)]
  let exp = expected2[int(i)]
  if got != exp
    print("  FAIL: index {i} got={got} expected={exp}")
    pass2 = 0.0
  end
  i = i + 1.0
end

let a0 = rt_result[0]
let a3 = rt_result[3]
let a5 = rt_result[5]
print("  Result: [{a0}, ..., {a3}, ..., {a5}]")
if pass2 == 1.0
  print("  PASS: Test 2 BIT EXACT")
end

// ── Overall ────────────────────────────────────────────────────────
if pass1 == 1.0
  if pass2 == 1.0
    print("PASS: gpu_sliding all tests BIT EXACT")
  end
end

rt_cleanup()
