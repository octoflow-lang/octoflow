// test_math_ext.flow â€” Tests for stdlib/stats/math_ext.flow
// Functions tested: factorial, fibonacci, gcd, lcm, is_prime

let mut pass = 0.0
let mut fail = 0.0

// -- Inline from stats/math_ext.flow --
fn factorial(n)
  let mut result = 1.0
  let mut i = 2.0
  while i <= n
    result = result * i
    i = i + 1.0
  end
  return result
end

fn fibonacci(n)
  if n <= 0.0
    return 0.0
  end
  if n == 1.0
    return 1.0
  end
  let mut a = 0.0
  let mut b = 1.0
  let mut i = 2.0
  while i <= n
    let c = a + b
    a = b
    b = c
    i = i + 1.0
  end
  return b
end

fn gcd(a, b)
  let mut x = abs(floor(a))
  let mut y = abs(floor(b))
  while y > 0.0
    let t = y
    y = x - floor(x / y) * y
    x = t
  end
  return x
end

fn lcm(a, b)
  if a == 0.0 || b == 0.0
    return 0.0
  end
  return abs(a * b) / gcd(a, b)
end

fn is_prime(n)
  if n < 2.0
    return 0.0
  end
  if n < 4.0
    return 1.0
  end
  let r2 = n - floor(n / 2.0) * 2.0
  if r2 == 0.0
    return 0.0
  end
  let r3 = n - floor(n / 3.0) * 3.0
  if r3 == 0.0
    return 0.0
  end
  let mut i = 5.0
  while i * i <= n
    let ri = n - floor(n / i) * i
    let ri2 = n - floor(n / (i + 2.0)) * (i + 2.0)
    if ri == 0.0 || ri2 == 0.0
      return 0.0
    end
    i = i + 6.0
  end
  return 1.0
end

// -- Tests --

print("=== test_math_ext ===")

// factorial(0) = 1
let f0 = factorial(0.0)
if f0 == 1.0
  pass = pass + 1.0
else
  print("  FAIL: factorial(0) expected 1 got {f0}")
  fail = fail + 1.0
end

// factorial(5) = 120
let f5 = factorial(5.0)
if f5 == 120.0
  pass = pass + 1.0
else
  print("  FAIL: factorial(5) expected 120 got {f5}")
  fail = fail + 1.0
end

// fibonacci(0) = 0
let fib0 = fibonacci(0.0)
if fib0 == 0.0
  pass = pass + 1.0
else
  print("  FAIL: fibonacci(0) expected 0 got {fib0}")
  fail = fail + 1.0
end

// fibonacci(1) = 1
let fib1 = fibonacci(1.0)
if fib1 == 1.0
  pass = pass + 1.0
else
  print("  FAIL: fibonacci(1) expected 1 got {fib1}")
  fail = fail + 1.0
end

// fibonacci(10) = 55
let fib10 = fibonacci(10.0)
if fib10 == 55.0
  pass = pass + 1.0
else
  print("  FAIL: fibonacci(10) expected 55 got {fib10}")
  fail = fail + 1.0
end

// gcd(12, 8) = 4
let g1 = gcd(12.0, 8.0)
if g1 == 4.0
  pass = pass + 1.0
else
  print("  FAIL: gcd(12,8) expected 4 got {g1}")
  fail = fail + 1.0
end

// gcd(17, 13) = 1 (coprime)
let g2 = gcd(17.0, 13.0)
if g2 == 1.0
  pass = pass + 1.0
else
  print("  FAIL: gcd(17,13) expected 1 got {g2}")
  fail = fail + 1.0
end

// lcm(4, 6) = 12
let l1 = lcm(4.0, 6.0)
if l1 == 12.0
  pass = pass + 1.0
else
  print("  FAIL: lcm(4,6) expected 12 got {l1}")
  fail = fail + 1.0
end

// is_prime tests
let pr2 = is_prime(2.0)
let pr4 = is_prime(4.0)
let pr7 = is_prime(7.0)
let pr1 = is_prime(1.0)

if pr2 == 1.0
  pass = pass + 1.0
else
  print("  FAIL: is_prime(2) expected 1 got {pr2}")
  fail = fail + 1.0
end

if pr4 == 0.0
  pass = pass + 1.0
else
  print("  FAIL: is_prime(4) expected 0 got {pr4}")
  fail = fail + 1.0
end

if pr7 == 1.0
  pass = pass + 1.0
else
  print("  FAIL: is_prime(7) expected 1 got {pr7}")
  fail = fail + 1.0
end

if pr1 == 0.0
  pass = pass + 1.0
else
  print("  FAIL: is_prime(1) expected 0 got {pr1}")
  fail = fail + 1.0
end

// Summary
let total = pass + fail
print("")
print("--- test_math_ext ---")
print("  pass: {pass}/{total}")
if fail > 0.0
  print("  FAIL: {fail} failures")
else
  print("  ALL PASS")
end
