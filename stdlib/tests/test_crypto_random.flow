// test_crypto_random.flow â€” Tests for stdlib/crypto/random.flow
// Functions tested: random_float, random_int, random_hex, uuid_v4, random_token

let mut pass = 0.0
let mut fail = 0.0

// -- Inline from crypto/random.flow --

fn random_float(lo, hi)
  return lo + random() * (hi - lo)
end

fn random_int(lo, hi)
  return floor(lo + random() * (hi - lo + 1.0))
end

fn random_hex(length)
  let chars = "0123456789abcdef"
  let mut result = ""
  let mut i = 0.0
  while i < length
    let idx = floor(random() * 16.0)
    result = result + char_at(chars, idx)
    i = i + 1.0
  end
  return result
end

fn uuid_v4()
  let h1 = random_hex(8.0)
  let h2 = random_hex(4.0)
  let h3 = "4" + random_hex(3.0)
  let y_chars = "89ab"
  let y = char_at(y_chars, floor(random() * 4.0))
  let h4 = y + random_hex(3.0)
  let h5 = random_hex(12.0)
  return h1 + "-" + h2 + "-" + h3 + "-" + h4 + "-" + h5
end

fn random_token(length)
  let chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
  let n = len(chars)
  let mut result = ""
  let mut i = 0.0
  while i < length
    let idx = floor(random() * n)
    result = result + char_at(chars, idx)
    i = i + 1.0
  end
  return result
end

fn random_choice(arr)
  let n = len(arr)
  let idx = floor(random() * n)
  return arr[idx]
end

// -- Tests --

print("=== test_crypto_random ===")

// Test 1: random_float in range
let rf = random_float(10.0, 20.0)
if rf >= 10.0 && rf <= 20.0
  pass = pass + 1.0
else
  print("  FAIL: random_float(10,20) = {rf} out of range")
  fail = fail + 1.0
end

// Test 2: random_int in range
let ri = random_int(1.0, 6.0)
if ri >= 1.0 && ri <= 6.0
  pass = pass + 1.0
else
  print("  FAIL: random_int(1,6) = {ri} out of range")
  fail = fail + 1.0
end

// Test 3: random_int is integer (floor)
let ri2 = random_int(0.0, 100.0)
if ri2 == floor(ri2)
  pass = pass + 1.0
else
  print("  FAIL: random_int not integer: {ri2}")
  fail = fail + 1.0
end

// Test 4: random_hex correct length
let rh = random_hex(8.0)
let rh_len = len(rh)
if rh_len == 8.0
  pass = pass + 1.0
else
  print("  FAIL: random_hex(8) len = {rh_len}")
  fail = fail + 1.0
end

// Test 5: random_hex only hex chars
let rh2 = random_hex(4.0)
let hex_chars = "0123456789abcdef"
let mut all_hex = 1.0
let mut i = 0.0
while i < len(rh2)
  let c = char_at(rh2, i)
  if contains(hex_chars, c) == 0.0
    all_hex = 0.0
  end
  i = i + 1.0
end
if all_hex == 1.0
  pass = pass + 1.0
else
  print("  FAIL: random_hex contains non-hex chars: {rh2}")
  fail = fail + 1.0
end

// Test 6: uuid_v4 correct length (36 chars: 8-4-4-4-12)
let uid = uuid_v4()
let uid_len = len(uid)
if uid_len == 36.0
  pass = pass + 1.0
else
  print("  FAIL: uuid_v4 len = {uid_len} expected 36")
  fail = fail + 1.0
end

// Test 7: uuid_v4 has dashes at correct positions
if char_at(uid, 8.0) == "-" && char_at(uid, 13.0) == "-" && char_at(uid, 18.0) == "-" && char_at(uid, 23.0) == "-"
  pass = pass + 1.0
else
  print("  FAIL: uuid_v4 dash positions: {uid}")
  fail = fail + 1.0
end

// Test 8: uuid_v4 has '4' at version position (index 14)
if char_at(uid, 14.0) == "4"
  pass = pass + 1.0
else
  print("  FAIL: uuid_v4 version not 4: {uid}")
  fail = fail + 1.0
end

// Test 9: random_token correct length
let rt = random_token(16.0)
let rt_len = len(rt)
if rt_len == 16.0
  pass = pass + 1.0
else
  print("  FAIL: random_token(16) len = {rt_len}")
  fail = fail + 1.0
end

// Test 10: random_choice picks from array
let choices = [10.0, 20.0, 30.0]
let rc = random_choice(choices)
if rc == 10.0 || rc == 20.0 || rc == 30.0
  pass = pass + 1.0
else
  print("  FAIL: random_choice got {rc} not in array")
  fail = fail + 1.0
end

// Test 11: two uuid_v4 calls produce different results (probabilistic)
let uid2 = uuid_v4()
if uid != uid2
  pass = pass + 1.0
else
  print("  FAIL: two uuid_v4 identical (unlikely): {uid}")
  fail = fail + 1.0
end

// Summary
let total = pass + fail
print("")
print("--- test_crypto_random ---")
print("  pass: {pass}/{total}")
if fail > 0.0
  print("  FAIL: {fail} failures")
else
  print("  ALL PASS")
end
