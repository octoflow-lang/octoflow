// test_indirect_dispatch.flow — Indirect dispatch unit test
// CPU uploads VkDispatchIndirectCommand {1, 1, 1} to indirect buffer.
// One indirect dispatch doubles 256 elements using that workgroup count.
// Verify: [2, 4, 6, 8] — exact, no floating-point ambiguity.

use "../gpu/runtime"

let N = 256.0
let BUF_BYTES = N * 4.0

// Boot GPU
rt_init()

// Load shader: 01_double.spv (binding 0 = input, binding 1 = output)
let pipe = rt_load_pipeline("tests/gpu_shaders/01_double.spv", 2.0, 0.0)

// Create data + result buffers
let data_buf = rt_create_buffer(BUF_BYTES)
let result_buf = rt_create_buffer(BUF_BYTES)

// Create indirect buffer (12 bytes = VkDispatchIndirectCommand {x, y, z})
let indirect_buf = rt_create_indirect_buffer(12.0)

// Upload data: [1, 2, 3, ..., 256]
let mut data = []
let mut i = 0.0
while i < N
  push(data, i + 1.0)
  i = i + 1.0
end
rt_upload(data_buf, data)

// Zero result buffer
let mut zeros = []
let mut i = 0.0
while i < N
  push(zeros, 0.0)
  i = i + 1.0
end
rt_upload(result_buf, zeros)

// Upload dispatch params: {x=1, y=1, z=1} (1 workgroup of 256 threads)
let mut dispatch_params = [1.0, 1.0, 1.0]
rt_upload_u32(indirect_buf, dispatch_params)

// Chain: 1 indirect dispatch
rt_chain_begin(1.0, 2.0)
let mut bufs = [data_buf, result_buf]
rt_chain_dispatch_indirect(pipe, bufs, indirect_buf)
rt_chain_end()

// Single submit — GPU reads workgroup count from indirect buffer
rt_chain_submit_wait()

// Download and verify
rt_download(result_buf, 4.0)

let mut pass = 1.0
let expected_0 = 2.0
let expected_1 = 4.0
let expected_2 = 6.0
let expected_3 = 8.0

let v0 = rt_result[0]
let v1 = rt_result[1]
let v2 = rt_result[2]
let v3 = rt_result[3]
print("Result: [{v0}, {v1}, {v2}, {v3}]")
print("Expected: [{expected_0}, {expected_1}, {expected_2}, {expected_3}]")

if v0 != expected_0
  print("FAIL: v0={v0} expected {expected_0}")
  pass = 0.0
end
if v1 != expected_1
  print("FAIL: v1={v1} expected {expected_1}")
  pass = 0.0
end
if v2 != expected_2
  print("FAIL: v2={v2} expected {expected_2}")
  pass = 0.0
end
if v3 != expected_3
  print("FAIL: v3={v3} expected {expected_3}")
  pass = 0.0
end

if pass == 1.0
  print("PASS: 1 indirect dispatch, GPU read workgroup count from buffer")
end

rt_cleanup()
