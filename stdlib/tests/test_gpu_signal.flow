// Tests for Signal Processing GPU Functions

use "../gpu/signal.flow"

let pass_count = 0.0
let fail_count = 0.0

fn test_diff()
    print("Testing gpu_diff...")

    let arr = [1.0, 3.0, 6.0, 10.0, 15.0]
    let result = gpu_diff(arr)

    // Should be [2, 3, 4, 5]
    if len(result) == 4.0
        if abs(result[0.0] - 2.0) < 0.01
            if abs(result[1.0] - 3.0) < 0.01
                if abs(result[2.0] - 4.0) < 0.01
                    if abs(result[3.0] - 5.0) < 0.01
                        print("  PASS: diff basic")
                        let pass_count = pass_count + 1.0
                        return

    print("  FAIL: diff basic")
    let fail_count = fail_count + 1.0

fn test_cumsum()
    print("Testing gpu_cumsum...")

    let arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    let result = gpu_cumsum(arr)

    // Should be [1, 3, 6, 10, 15]
    if len(result) == 5.0
        if abs(result[0.0] - 1.0) < 0.01
            if abs(result[4.0] - 15.0) < 0.01
                print("  PASS: cumsum basic")
                let pass_count = pass_count + 1.0
                return

    print("  FAIL: cumsum basic")
    let fail_count = fail_count + 1.0

fn test_ema()
    print("Testing gpu_ema...")

    let arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    let alpha = 0.5

    let result = gpu_ema(arr, alpha)

    if len(result) > 0.0
        print("  PASS: ema runs")
        let pass_count = pass_count + 1.0
    else
        print("  FAIL: ema empty result")
        let fail_count = fail_count + 1.0

fn test_autocorrelation()
    print("Testing gpu_autocorrelation...")

    let signal = [1.0, 2.0, 3.0, 2.0, 1.0, 2.0, 3.0]
    let max_lag = 3.0

    let result = gpu_autocorrelation(signal, max_lag)

    if len(result) == 4.0
        // Lag 0 should be 1.0 (perfect correlation)
        if abs(result[0.0] - 1.0) < 0.1
            print("  PASS: autocorrelation basic")
            let pass_count = pass_count + 1.0
            return

    print("  FAIL: autocorrelation")
    let fail_count = fail_count + 1.0

fn test_cross_correlation()
    print("Testing gpu_cross_correlation...")

    let sig1 = [1.0, 2.0, 3.0, 4.0, 5.0]
    let sig2 = [1.0, 2.0, 3.0, 4.0, 5.0]

    let corr = gpu_cross_correlation(sig1, sig2)

    // Should be 1.0 (identical signals)
    if abs(corr - 1.0) < 0.01
        print("  PASS: cross_correlation identical")
        let pass_count = pass_count + 1.0
    else
        print("  FAIL: cross_correlation")
        let fail_count = fail_count + 1.0

fn test_bandpass_filter()
    print("Testing gpu_bandpass_filter...")

    let signal = [1.0, 2.0, 1.0, 2.0, 1.0, 2.0]
    let low = 0.1
    let high = 0.5

    let filtered = gpu_bandpass_filter(signal, low, high)

    if len(filtered) > 0.0
        print("  PASS: bandpass runs")
        let pass_count = pass_count + 1.0
    else
        print("  FAIL: bandpass empty")
        let fail_count = fail_count + 1.0

// Run tests
print("=== Signal Processing Tests ===")
test_diff()
test_cumsum()
test_ema()
test_autocorrelation()
test_cross_correlation()
test_bandpass_filter()

print("")
print("Signal tests: {pass_count} passed, {fail_count} failed")
