// test_boot_once.flow — Boot Once GPU Runtime unit test
// Chains 10 dispatches in a single VkCommandBuffer, single vkQueueSubmit.
// GPU runs all 10 doublings autonomously. CPU passive until fence.
// Verify: 1.0 * 2^10 = 1024.0

use "../gpu/runtime"

let N = 256.0
let BUF_BYTES = N * 4.0

// Boot GPU
rt_init()

// Load shader: 01_double.spv (binding 0 = input, binding 1 = output)
let pipe = rt_load_pipeline("tests/gpu_shaders/01_double.spv", 2.0, 0.0)

// Create two buffers for ping-pong
let buf_a = rt_create_buffer(BUF_BYTES)
let buf_b = rt_create_buffer(BUF_BYTES)

// Upload initial data: [1.0, 2.0, 3.0, 4.0, ...] for 256 elements
let mut data = []
let mut i = 0.0
while i < N
  push(data, i + 1.0)
  i = i + 1.0
end
rt_upload(buf_a, data)

// Zero buffer B
let mut zeros = []
let mut i = 0.0
while i < N
  push(zeros, 0.0)
  i = i + 1.0
end
rt_upload(buf_b, zeros)

// Chain 10 dispatches: ping-pong A↔B
let NUM_DISPATCHES = 10.0
rt_chain_begin(NUM_DISPATCHES, 2.0)

let mut d = 0.0
let mut ping = 1.0
while d < NUM_DISPATCHES
  if ping == 1.0
    let mut bufs = [buf_a, buf_b]
    rt_chain_dispatch(pipe, bufs, 1.0)
    ping = 0.0
  else
    let mut bufs = [buf_b, buf_a]
    rt_chain_dispatch(pipe, bufs, 1.0)
    ping = 1.0
  end
  d = d + 1.0
end

rt_chain_end()

// Single submit — GPU runs all 10 dispatches autonomously
rt_chain_submit_wait()

// Read result from A (10 dispatches: last dispatch writes to A)
rt_download(buf_a, 4.0)

// Verify: each element should be original * 2^10 = original * 1024
let mut pass = 1.0
let expected_0 = 1.0 * 1024.0
let expected_1 = 2.0 * 1024.0
let expected_2 = 3.0 * 1024.0
let expected_3 = 4.0 * 1024.0

let v0 = rt_result[0]
let v1 = rt_result[1]
let v2 = rt_result[2]
let v3 = rt_result[3]
print("Result: [{v0}, {v1}, {v2}, {v3}]")
print("Expected: [{expected_0}, {expected_1}, {expected_2}, {expected_3}]")

if v0 != expected_0
  print("FAIL: v0={v0} expected {expected_0}")
  pass = 0.0
end
if v1 != expected_1
  print("FAIL: v1={v1} expected {expected_1}")
  pass = 0.0
end
if v2 != expected_2
  print("FAIL: v2={v2} expected {expected_2}")
  pass = 0.0
end
if v3 != expected_3
  print("FAIL: v3={v3} expected {expected_3}")
  pass = 0.0
end

if pass == 1.0
  print("PASS: 10 GPU dispatches, 1 submit, 0 CPU wakeups")
end

rt_cleanup()
