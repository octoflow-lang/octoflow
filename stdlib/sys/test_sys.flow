// test_sys.flow — Tests for stdlib/sys/ modules
// Functions tested:
//   args: arg_flag, arg_value, arg_required
//   memory: format_bytes
//   platform: get_os, is_windows, is_linux, is_mac, path_separator
//   timer: format_duration
use "sys/args"
use "sys/memory"
use "sys/platform"
use "sys/timer"

fn approx_str(a, b)
  if a == b
    return 1.0
  end
  return 0.0
end

// ── arg_flag tests ────────────────────────────────────────

fn test_arg_flag_present()
  let mut args = map()
  map_set(args, "verbose", "1")
  assert(arg_flag(args, "--verbose") == 1.0, "arg_flag finds --verbose")
  print("PASS: test_arg_flag_present")
  return 0.0
end

fn test_arg_flag_missing()
  let mut args = map()
  map_set(args, "verbose", "1")
  assert(arg_flag(args, "--quiet") == 0.0, "arg_flag returns 0 for missing")
  print("PASS: test_arg_flag_missing")
  return 0.0
end

fn test_arg_flag_bare_key()
  let mut args = map()
  map_set(args, "raw", "1")
  assert(arg_flag(args, "raw") == 1.0, "arg_flag bare key works")
  print("PASS: test_arg_flag_bare_key")
  return 0.0
end

fn test_arg_flag_empty_args()
  let mut args = map()
  assert(arg_flag(args, "--anything") == 0.0, "arg_flag empty map returns 0")
  print("PASS: test_arg_flag_empty_args")
  return 0.0
end

// ── arg_value tests ───────────────────────────────────────

fn test_arg_value_present()
  let mut args = map()
  map_set(args, "output", "result.csv")
  assert(arg_value(args, "--output", "default.csv") == "result.csv", "arg_value returns existing")
  print("PASS: test_arg_value_present")
  return 0.0
end

fn test_arg_value_missing()
  let mut args = map()
  assert(arg_value(args, "--output", "default.csv") == "default.csv", "arg_value returns default")
  print("PASS: test_arg_value_missing")
  return 0.0
end

fn test_arg_value_bare_key()
  let mut args = map()
  map_set(args, "port", "8080")
  assert(arg_value(args, "port", "3000") == "8080", "arg_value bare key")
  print("PASS: test_arg_value_bare_key")
  return 0.0
end

// ── arg_required tests ────────────────────────────────────

fn test_arg_required_present()
  let mut args = map()
  map_set(args, "config", "/etc/app.conf")
  assert(arg_required(args, "--config") == "/etc/app.conf", "arg_required returns value")
  print("PASS: test_arg_required_present")
  return 0.0
end

fn test_arg_required_missing()
  let mut args = map()
  assert(arg_required(args, "--config") == "", "arg_required returns empty for missing")
  print("PASS: test_arg_required_missing")
  return 0.0
end

// ── format_bytes tests ────────────────────────────────────

fn test_format_bytes_bytes()
  assert(format_bytes(500.0) == "500 B", "format_bytes 500 B")
  print("PASS: test_format_bytes_bytes")
  return 0.0
end

fn test_format_bytes_zero()
  assert(format_bytes(0.0) == "0 B", "format_bytes 0 B")
  print("PASS: test_format_bytes_zero")
  return 0.0
end

fn test_format_bytes_kb()
  assert(format_bytes(2048.0) == "2 KB", "format_bytes 2 KB")
  print("PASS: test_format_bytes_kb")
  return 0.0
end

fn test_format_bytes_kb_boundary()
  assert(format_bytes(1024.0) == "1 KB", "format_bytes 1 KB boundary")
  print("PASS: test_format_bytes_kb_boundary")
  return 0.0
end

fn test_format_bytes_mb()
  assert(format_bytes(1048576.0) == "1 MB", "format_bytes 1 MB")
  print("PASS: test_format_bytes_mb")
  return 0.0
end

fn test_format_bytes_gb()
  assert(format_bytes(1073741824.0) == "1 GB", "format_bytes 1 GB")
  print("PASS: test_format_bytes_gb")
  return 0.0
end

fn test_format_bytes_fractional_kb()
  assert(format_bytes(1536.0) == "1.5 KB", "format_bytes 1.5 KB")
  print("PASS: test_format_bytes_fractional_kb")
  return 0.0
end

fn test_format_bytes_just_below_kb()
  assert(format_bytes(1023.0) == "1023 B", "format_bytes 1023 B")
  print("PASS: test_format_bytes_just_below_kb")
  return 0.0
end

// ── format_duration tests ─────────────────────────────────

fn test_format_duration_microseconds()
  assert(format_duration(0.5) == "500us", "format_duration 500us")
  print("PASS: test_format_duration_microseconds")
  return 0.0
end

fn test_format_duration_milliseconds()
  assert(format_duration(42.0) == "42ms", "format_duration 42ms")
  print("PASS: test_format_duration_milliseconds")
  return 0.0
end

fn test_format_duration_seconds()
  assert(format_duration(2500.0) == "2.5s", "format_duration 2.5s")
  print("PASS: test_format_duration_seconds")
  return 0.0
end

fn test_format_duration_exact_second()
  assert(format_duration(1000.0) == "1s", "format_duration 1s")
  print("PASS: test_format_duration_exact_second")
  return 0.0
end

fn test_format_duration_minutes()
  assert(format_duration(90000.0) == "1m 30s", "format_duration 1m 30s")
  print("PASS: test_format_duration_minutes")
  return 0.0
end

fn test_format_duration_just_below_second()
  assert(format_duration(999.0) == "999ms", "format_duration 999ms")
  print("PASS: test_format_duration_just_below_second")
  return 0.0
end

// ── platform detection tests ──────────────────────────────

fn test_get_os_returns_string()
  let os = get_os()
  assert(len(os) > 0.0, "get_os returns non-empty string")
  print("PASS: test_get_os_returns_string")
  return 0.0
end

fn test_platform_mutual_exclusion()
  let w = is_windows()
  let l = is_linux()
  let m = is_mac()
  assert(w + l + m <= 1.0, "at most one platform flag is 1.0")
  print("PASS: test_platform_mutual_exclusion")
  return 0.0
end

fn test_is_windows_returns_bool()
  let w = is_windows()
  assert(w == 0.0 || w == 1.0, "is_windows returns 0.0 or 1.0")
  print("PASS: test_is_windows_returns_bool")
  return 0.0
end

fn test_is_linux_returns_bool()
  let l = is_linux()
  assert(l == 0.0 || l == 1.0, "is_linux returns 0.0 or 1.0")
  print("PASS: test_is_linux_returns_bool")
  return 0.0
end

fn test_is_mac_returns_bool()
  let m = is_mac()
  assert(m == 0.0 || m == 1.0, "is_mac returns 0.0 or 1.0")
  print("PASS: test_is_mac_returns_bool")
  return 0.0
end

fn test_path_separator_valid()
  let sep = path_separator()
  assert(sep == "/" || sep == chr(92.0), "path_separator is / or backslash")
  print("PASS: test_path_separator_valid")
  return 0.0
end
