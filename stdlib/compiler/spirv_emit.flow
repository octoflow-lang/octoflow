// stdlib/compiler/spirv_emit.flow
// SPIR-V Binary Emitter — Pure OctoFlow
//
// Proof-of-concept: emits a valid SPIR-V compute shader that doubles each element.
// output[gid] = input[gid] * 2.0
//
// SPIR-V layout order: Header → Capability → MemoryModel → EntryPoint →
//   ExecutionMode → Annotations → Types/Vars/Constants → Functions

fn make_op(wc, op)
  return (wc << 16.0) | op
end
fn wb0(w)
  return w & 255.0
end
fn wb1(w)
  return (w >> 8.0) & 255.0
end
fn wb2(w)
  return (w >> 16.0) & 255.0
end
fn wb3(w)
  return (w >> 24.0) & 255.0
end

let mut buf = []

// ===================== SECTION 1: Header =====================
// Magic 0x07230203 (little-endian bytes)
push(buf, 3.0)
push(buf, 2.0)
push(buf, 35.0)
push(buf, 7.0)
// Version 1.4 = 0x00010400
let _w = 66560.0
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
// Generator, Bound=30, Schema=0
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 2: Capability =====================
// OpCapability(17) Shader(1)
let _w = make_op(2.0, 17.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 3: MemoryModel =====================
// OpMemoryModel(14) Logical(0) GLSL450(1)
let _w = make_op(3.0, 14.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 4: EntryPoint =====================
// OpEntryPoint(15) GLCompute(5) %3 "main" %8 %12 %13
// SPIR-V 1.4: ALL global variables must be listed as interfaces
let _w = make_op(8.0, 15.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// "main" = 109,97,105,110 + null pad
push(buf, 109.0)
push(buf, 97.0)
push(buf, 105.0)
push(buf, 110.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 5: ExecutionMode =====================
// OpExecutionMode(16) %3 LocalSize(17) 256 1 1
let _w = make_op(6.0, 16.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// 256 = 0x100
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 6: Annotations =====================
// OpDecorate(71) %8 BuiltIn(11) GlobalInvocationId(28)
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %10 Block(2)
let _w = make_op(3.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpMemberDecorate(72) %10 0 Offset(35) 0
let _w = make_op(5.0, 72.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %9 ArrayStride(6) 4
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %12 DescriptorSet(34) 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %12 Binding(33) 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %13 DescriptorSet(34) 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %13 Binding(33) 1
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 7: Types/Variables/Constants =====================
// %1 = OpTypeVoid(19)
let _w = make_op(2.0, 19.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %2 = OpTypeFunction(33) %1
let _w = make_op(3.0, 33.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %4 = OpTypeFloat(22) 32
let _w = make_op(3.0, 22.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %5 = OpTypeInt(21) 32 0
let _w = make_op(4.0, 21.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %6 = OpTypeVector(23) %5 3
let _w = make_op(4.0, 23.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %7 = OpTypePointer(32) Input(1) %6
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 7.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %9 = OpTypeRuntimeArray(29) %4
let _w = make_op(3.0, 29.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %10 = OpTypeStruct(30) %9
let _w = make_op(3.0, 30.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %11 = OpTypePointer(32) StorageBuffer(12) %10
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %15 = OpTypePointer(32) Input(1) %5
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 15.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %17 = OpTypePointer(32) StorageBuffer(12) %4
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %16 = OpConstant(43) %5 0
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %18 = OpConstant(43) %4 2.0 (float — use float_byte)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 18.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, float_byte(2.0, 0.0))
push(buf, float_byte(2.0, 1.0))
push(buf, float_byte(2.0, 2.0))
push(buf, float_byte(2.0, 3.0))

// %8 = OpVariable(59) %7 Input(1)
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 7.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %12 = OpVariable(59) %11 StorageBuffer(12)
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %13 = OpVariable(59) %11 StorageBuffer(12)
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 8: Function =====================
// OpFunction(54) %1 %3 None(0) %2
let _w = make_op(5.0, 54.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpLabel(248) %14
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 14.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %19 = OpAccessChain(65) %15 %8 %16
let _w = make_op(5.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 15.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 19.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %20 = OpLoad(61) %5 %19
let _w = make_op(4.0, 61.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 19.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %21 = OpAccessChain(65) %17 %12 %16 %20
let _w = make_op(6.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 21.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %22 = OpLoad(61) %4 %21
let _w = make_op(4.0, 61.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 21.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %23 = OpFMul(133) %4 %22 %18
let _w = make_op(5.0, 133.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 23.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 18.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %24 = OpAccessChain(65) %17 %13 %16 %20
let _w = make_op(6.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 24.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpStore(62) %24 %23
let _w = make_op(3.0, 62.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 24.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 23.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpReturn(253)
let _w = make_op(1.0, 253.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))

// OpFunctionEnd(56)
let _w = make_op(1.0, 56.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))

// ===================== WRITE =====================
let byte_count = len(buf)
let word_count = byte_count / 4.0
print("SPIR-V emitted: {word_count} words ({byte_count} bytes)")
write_bytes("spirv_test_double.spv", buf)
print("Written to spirv_test_double.spv")
