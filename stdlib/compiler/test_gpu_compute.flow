// test_gpu_compute.flow — End-to-end test of .flow SPIR-V → GPU dispatch
//
// Prerequisites: spirv_test_double.spv must exist (generated by spirv_emit.flow)
//
// Pipeline: spirv_emit.flow creates SPIR-V binary → this script loads it
//           and dispatches on the GPU → verifies output[i] == input[i] * 2.0

// Build input array: [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0]
let mut input = []
push(input, 1.0)
push(input, 2.0)
push(input, 3.0)
push(input, 4.0)
push(input, 5.0)
push(input, 6.0)
push(input, 7.0)
push(input, 8.0)

// Dispatch the SPIR-V shader on the GPU
let output = gpu_compute("spirv_test_double.spv", "input")

// Verify results
let n = len(output)
print("Output length: {n}")

let mut ok = 1.0
for i in range(0, 8)
  let expected = input[i] * 2.0
  let actual = output[i]
  if actual != expected
    print("MISMATCH at {i}: expected {expected}, got {actual}")
    ok = 0.0
  end
end

if ok == 1.0
  print("GPU compute test PASSED — all 8 elements doubled correctly")
else
  print("GPU compute test FAILED")
end
