// test_lambda_eval.flow — Test lambda/HOF support in eval.flow
// Uses simple conditions (no compound && with array indexing)

let mut pass = 0.0
let mut fail = 0.0

// Setup test data
let mut scores = []
push(scores, 85.0)
push(scores, 92.0)
push(scores, 67.0)
push(scores, 73.0)
push(scores, 95.0)
push(scores, 58.0)
push(scores, 88.0)

let mut nums = []
push(nums, 1.0)
push(nums, 2.0)
push(nums, 3.0)
push(nums, 4.0)
push(nums, 5.0)

// Test 1: filter — keep scores >= 80
let passing = filter(scores, fn(s) s >= 80.0 end)
let plen = len(passing)
if plen == 4.0
  pass = pass + 1.0
else
  print("  FAIL: filter count expected 4 got {plen}")
  fail = fail + 1.0
end

// Test 2: map_each — double each number
let doubled = map_each(nums, fn(x) x * 2.0 end)
let d0 = doubled[0]
let d2 = doubled[2]
let d4 = doubled[4]
if d0 == 2.0
  if d2 == 6.0
    if d4 == 10.0
      pass = pass + 1.0
    else
      print("  FAIL: map_each d4={d4}")
      fail = fail + 1.0
    end
  else
    print("  FAIL: map_each d2={d2}")
    fail = fail + 1.0
  end
else
  print("  FAIL: map_each d0={d0}")
  fail = fail + 1.0
end

// Test 3: reduce — sum
let total = reduce(nums, 0.0, fn(acc, x) acc + x end)
if total == 15.0
  pass = pass + 1.0
else
  print("  FAIL: reduce sum expected 15 got {total}")
  fail = fail + 1.0
end

// Test 4: reduce — product
let product = reduce(nums, 1.0, fn(acc, x) acc * x end)
if product == 120.0
  pass = pass + 1.0
else
  print("  FAIL: reduce product expected 120 got {product}")
  fail = fail + 1.0
end

// Test 5: sort_by — sort by value
let mut vals = []
push(vals, 30.0)
push(vals, 10.0)
push(vals, 50.0)
push(vals, 20.0)
push(vals, 40.0)
let sorted = sort_by(vals, fn(x) x end)
let s0 = sorted[0]
let s4 = sorted[4]
if s0 == 10.0
  if s4 == 50.0
    pass = pass + 1.0
  else
    print("  FAIL: sort_by s4={s4}")
    fail = fail + 1.0
  end
else
  print("  FAIL: sort_by s0={s0}")
  fail = fail + 1.0
end

// Test 6: filter with < comparison
let small = filter(nums, fn(x) x < 3.0 end)
let slen = len(small)
if slen == 2.0
  pass = pass + 1.0
else
  print("  FAIL: filter < 3 expected 2 got {slen}")
  fail = fail + 1.0
end

// Test 7: map_each with builtin abs()
let mut absvals = map_each(nums, fn(x) abs(x) end)
let a0 = absvals[0]
let a2 = absvals[2]
if a0 == 1.0
  if a2 == 3.0
    pass = pass + 1.0
  else
    print("  FAIL: map_each abs a2={a2}")
    fail = fail + 1.0
  end
else
  print("  FAIL: map_each abs a0={a0}")
  fail = fail + 1.0
end

print("=== test_lambda_eval ===")
let total_tests = pass + fail
print("  pass: {pass}/{total_tests}")
if fail > 0.0
  print("  FAIL: {fail} failures")
else
  print("  ALL PASS")
end
