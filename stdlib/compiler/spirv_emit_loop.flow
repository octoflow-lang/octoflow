// stdlib/compiler/spirv_emit_loop.flow
// Structured Loop SPIR-V Emitter — Pure OctoFlow
//
// Emits a compute shader with OpLoopMerge + OpPhi:
//   n = min(uint(val), 10)
//   sum = 0.0; i = 1
//   while (i <= n): sum += float(i); i++
//   output[gid] = sum
//
// This proves: OpLoopMerge, OpPhi for loop variables (both accumulator and counter),
//   back-edge SSA, OpConvertFToU/UToF, OpSelect, proper loop dominance
//
// Equivalent to tests/gpu_shaders/04_loop.comp
//
// Additional opcodes:
//   OpConvertFToU(112)  OpConvertUToF(113)  OpULessThanEqual(178)
//   OpSelect(169)  OpLoopMerge(246)  OpIAdd(128)
//
// ID allocation:
//   %1=void  %2=fn_type  %3=main  %4=float  %5=uint  %6=uvec3
//   %7=ptr_in_uvec3  %8=gid_var  %9=rt_array  %10=struct  %11=ptr_sb_struct
//   %12=input  %13=output  %14=entry_label  %15=ptr_in_uint
//   %16=const_uint_0  %17=ptr_sb_float  %25=bool
//   %26=const_uint_1  %27=const_uint_10  %28=const_float_0
//   %19=gid_chain  %20=gid  %21=input_chain  %22=val
//   %29=ConvertFToU  %30=ULessThanEqual  %31=Select(n)
//   %32=loop_header  %33=phi_sum  %34=phi_i
//   %35=body  %36=merge  %37=cond_check  %38=i<=n
//   %39=ConvertUToF  %40=FAdd(new_sum)  %41=IAdd(new_i)
//   %42=continue  %43=output_chain
//   Bound=44

let mut out_path = env("SPIRV_OUTPUT")
if out_path == ""
  out_path = "spirv_loop.spv"
end

fn make_op(wc, op)
  return (wc << 16.0) | op
end
fn wb0(w)
  return w & 255.0
end
fn wb1(w)
  return (w >> 8.0) & 255.0
end
fn wb2(w)
  return (w >> 16.0) & 255.0
end
fn wb3(w)
  return (w >> 24.0) & 255.0
end

// Helper: emit a 4-byte word to buf
// (Can't use function because functions can't mutate outer arrays)

let mut buf = []

// ===================== SECTION 1: Header =====================
push(buf, 3.0)
push(buf, 2.0)
push(buf, 35.0)
push(buf, 7.0)
let _w = 66560.0
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// Bound=44
push(buf, 44.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 2: Capability =====================
let _w = make_op(2.0, 17.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 3: MemoryModel =====================
let _w = make_op(3.0, 14.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 4: EntryPoint =====================
let _w = make_op(8.0, 15.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 109.0)
push(buf, 97.0)
push(buf, 105.0)
push(buf, 110.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 5: ExecutionMode =====================
let _w = make_op(6.0, 16.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 6: Annotations =====================
// OpDecorate %8 BuiltIn GlobalInvocationId
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %10 Block
let _w = make_op(3.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpMemberDecorate %10 0 Offset 0
let _w = make_op(5.0, 72.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %9 ArrayStride 4
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %12 DescriptorSet 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %12 Binding 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %13 DescriptorSet 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %13 Binding 1
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 7: Types/Variables/Constants =====================
// %1 = OpTypeVoid
let _w = make_op(2.0, 19.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %2 = OpTypeFunction %1
let _w = make_op(3.0, 33.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %4 = OpTypeFloat 32
let _w = make_op(3.0, 22.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %5 = OpTypeInt 32 0
let _w = make_op(4.0, 21.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %6 = OpTypeVector %5 3
let _w = make_op(4.0, 23.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %7 = OpTypePointer Input %6
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 7.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %9 = OpTypeRuntimeArray %4
let _w = make_op(3.0, 29.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %10 = OpTypeStruct %9
let _w = make_op(3.0, 30.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %11 = OpTypePointer StorageBuffer %10
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %15 = OpTypePointer Input %5
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 15.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %17 = OpTypePointer StorageBuffer %4
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %25 = OpTypeBool
let _w = make_op(2.0, 20.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// Constants
// %16 = OpConstant %5 0 (uint zero)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %26 = OpConstant %5 1 (uint one — loop init)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %27 = OpConstant %5 10 (uint ten — loop cap)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 27.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %28 = OpConstant %4 0.0 (float zero — sum init)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, float_byte(0.0, 0.0))
push(buf, float_byte(0.0, 1.0))
push(buf, float_byte(0.0, 2.0))
push(buf, float_byte(0.0, 3.0))

// Variables
// %8 = OpVariable %7 Input
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 7.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %12 = OpVariable %11 StorageBuffer
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %13 = OpVariable %11 StorageBuffer
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 8: Function =====================
// OpFunction %1 %3 None %2
let _w = make_op(5.0, 54.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %14: Entry =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 14.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %19 = OpAccessChain %15 %8 %16 (gid.x ptr)
let _w = make_op(5.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 15.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 19.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %20 = OpLoad %5 %19 (gid)
let _w = make_op(4.0, 61.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 19.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %21 = OpAccessChain %17 %12 %16 %20 (input[gid] ptr)
let _w = make_op(6.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 21.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %22 = OpLoad %4 %21 (val = input[gid])
let _w = make_op(4.0, 61.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 21.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %29 = OpConvertFToU(109) %5 %22 (n_raw = uint(val))
let _w = make_op(4.0, 109.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 29.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %30 = OpULessThanEqual(178) %25 %29 %27 (n_raw <= 10)
let _w = make_op(5.0, 178.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 29.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 27.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %31 = OpSelect(169) %5 %30 %29 %27 (n = cond ? n_raw : 10)
let _w = make_op(6.0, 169.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 31.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 29.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 27.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch(249) %32 (enter loop header)
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %32: Loop Header =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %33 = OpPhi(245) %4 %28 %14 %40 %42  (sum: 0.0 from entry, new_sum from continue)
let _w = make_op(7.0, 245.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 14.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 40.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %34 = OpPhi(245) %5 %26 %14 %41 %42  (i: 1 from entry, new_i from continue)
let _w = make_op(7.0, 245.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 14.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 41.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpLoopMerge(246) %36 %42 None(0)
let _w = make_op(4.0, 246.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 36.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch(249) %37 (jump to condition check)
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 37.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %37: Condition Check =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 37.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %38 = OpULessThanEqual(178) %25 %34 %31 (i <= n)
let _w = make_op(5.0, 178.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 38.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 31.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranchConditional(250) %38 %35 %36 (body or merge)
let _w = make_op(4.0, 250.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 38.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 36.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %35: Loop Body =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %39 = OpConvertUToF(112) %4 %34 (float(i))
let _w = make_op(4.0, 112.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 39.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %40 = OpFAdd(129) %4 %33 %39 (new_sum = sum + float(i))
let _w = make_op(5.0, 129.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 40.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 39.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch(249) %42 (to continue target)
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %42: Continue Target =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %41 = OpIAdd(128) %5 %34 %26 (new_i = i + 1)
let _w = make_op(5.0, 128.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 41.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch(249) %32 (back-edge to loop header)
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %36: Merge (after loop) =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 36.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %43 = OpAccessChain %17 %13 %16 %20 (output[gid] ptr)
let _w = make_op(6.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 43.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpStore %43 %33 (store sum)
let _w = make_op(3.0, 62.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 43.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpReturn
let _w = make_op(1.0, 253.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))

// OpFunctionEnd
let _w = make_op(1.0, 56.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))

// ===================== WRITE =====================
let byte_count = len(buf)
let word_count = byte_count / 4.0
print("SPIR-V [loop+phi] emitted: {word_count} words ({byte_count} bytes)")
write_bytes(out_path, buf)
print("Written to {out_path}")
