// stdlib/compiler/spirv_emit_nested.flow
// Nested Structured Control Flow SPIR-V Emitter â€” Pure OctoFlow
//
// STRESS TEST: outer loop > branch > inner loop
//   n = min(uint(val), 6)
//   acc = 0.0
//   for i = 1 to n:
//     if float(i) > 3.0:
//       s = 0.0; for j = 1 to i: s += float(j)
//       acc += s
//     else:
//       acc += float(i)
//   output[gid] = acc
//
// Proves: nested OpLoopMerge, OpSelectionMerge inside loop body,
//   inner loop with outer-scope-dependent bound, multiple OpPhi scopes,
//   cross-scope value propagation via dominance, proper nesting of
//   merge/continue targets.
//
// ID allocation (61 IDs, bound=61):
//   Types: %1=void %2=fn_type %4=float %5=uint %6=uvec3 %7=ptr_in_uvec3
//     %9=rt_array %10=struct %11=ptr_sb_struct %15=ptr_in_uint %17=ptr_sb_float %25=bool
//   Constants: %16=uint_0 %26=uint_1 %27=uint_6 %28=float_0 %29=float_3
//   Variables: %8=gid_var %12=input %13=output
//   Entry(%14): %19=gid_chain %20=gid %21=input_chain %22=val
//     %30=ConvertFToU %31=ULessThanEqual %32=Select(n)
//   Outer loop: %33=header %34=phi_acc %35=phi_i %36=cond %37=i<=n %38=merge
//     %39=body %40=ConvertUToF(i) %41=FOrdGT(i>3) %42=true_entry %43=inner_header
//   Inner loop: %44=phi_s %45=phi_j %46=inner_cond %47=inner_merge %48=inner_continue
//     %49=new_s %50=false_branch %51=j<=i %52=new_j %53=selection_merge
//   Outer continue: %54=outer_continue %55=new_acc %56=new_i
//   Inner body: %57=inner_body %58=ConvertUToF(j) %59=phi_branch %60=out_chain

let mut out_path = env("SPIRV_OUTPUT")
if out_path == ""
  out_path = "spirv_nested.spv"
end

fn make_op(wc, op)
  return (wc << 16.0) | op
end
fn wb0(w)
  return w & 255.0
end
fn wb1(w)
  return (w >> 8.0) & 255.0
end
fn wb2(w)
  return (w >> 16.0) & 255.0
end
fn wb3(w)
  return (w >> 24.0) & 255.0
end

let mut buf = []

// ===================== HEADER =====================
push(buf, 3.0)
push(buf, 2.0)
push(buf, 35.0)
push(buf, 7.0)
let _w = 66560.0
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// Bound=61
push(buf, 61.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== CAPABILITY =====================
let _w = make_op(2.0, 17.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== MEMORY MODEL =====================
let _w = make_op(3.0, 14.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== ENTRY POINT =====================
let _w = make_op(8.0, 15.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 109.0)
push(buf, 97.0)
push(buf, 105.0)
push(buf, 110.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== EXECUTION MODE =====================
let _w = make_op(6.0, 16.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== ANNOTATIONS =====================
// OpDecorate %8 BuiltIn GlobalInvocationId
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %10 Block
let _w = make_op(3.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpMemberDecorate %10 0 Offset 0
let _w = make_op(5.0, 72.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %9 ArrayStride 4
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %12 DescriptorSet 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %12 Binding 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %13 DescriptorSet 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %13 Binding 1
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== TYPES/VARS/CONSTANTS =====================
// %1 = OpTypeVoid
let _w = make_op(2.0, 19.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %2 = OpTypeFunction %1
let _w = make_op(3.0, 33.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %4 = OpTypeFloat 32
let _w = make_op(3.0, 22.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %5 = OpTypeInt 32 0
let _w = make_op(4.0, 21.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %6 = OpTypeVector %5 3
let _w = make_op(4.0, 23.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %7 = OpTypePointer Input %6
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 7.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %9 = OpTypeRuntimeArray %4
let _w = make_op(3.0, 29.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %10 = OpTypeStruct %9
let _w = make_op(3.0, 30.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %11 = OpTypePointer StorageBuffer %10
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %15 = OpTypePointer Input %5
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 15.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %17 = OpTypePointer StorageBuffer %4
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %25 = OpTypeBool
let _w = make_op(2.0, 20.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// Constants
// %16 = uint 0
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %26 = uint 1
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %27 = uint 6
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 27.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %28 = float 0.0
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, float_byte(0.0, 0.0))
push(buf, float_byte(0.0, 1.0))
push(buf, float_byte(0.0, 2.0))
push(buf, float_byte(0.0, 3.0))

// %29 = float 3.0
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 29.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, float_byte(3.0, 0.0))
push(buf, float_byte(3.0, 1.0))
push(buf, float_byte(3.0, 2.0))
push(buf, float_byte(3.0, 3.0))

// Variables
// %8 = OpVariable Input
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 7.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %12 = OpVariable StorageBuffer
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %13 = OpVariable StorageBuffer
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== FUNCTION =====================
// OpFunction %1 %3 None %2
let _w = make_op(5.0, 54.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %14: Entry =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 14.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %19 = OpAccessChain %15 %8 %16
let _w = make_op(5.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 15.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 19.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %20 = OpLoad %5 %19
let _w = make_op(4.0, 61.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 19.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %21 = OpAccessChain %17 %12 %16 %20
let _w = make_op(6.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 21.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %22 = OpLoad %4 %21
let _w = make_op(4.0, 61.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 21.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %30 = OpConvertFToU(109) %5 %22
let _w = make_op(4.0, 109.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %31 = OpULessThanEqual(178) %25 %30 %27
let _w = make_op(5.0, 178.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 31.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 27.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %32 = OpSelect(169) %5 %31 %30 %27
let _w = make_op(6.0, 169.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 31.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 27.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %33
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %33: Outer Loop Header =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %34 = OpPhi %4 %28 %14 %55 %54 (acc)
let _w = make_op(7.0, 245.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 14.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 55.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 54.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %35 = OpPhi %5 %26 %14 %56 %54 (i)
let _w = make_op(7.0, 245.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 14.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 56.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 54.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpLoopMerge %38 %54 None
let _w = make_op(4.0, 246.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 38.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 54.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %36
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 36.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %36: Outer Cond =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 36.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %37 = OpULessThanEqual %25 %35 %32 (i <= n)
let _w = make_op(5.0, 178.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 37.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranchConditional %37 %39 %38
let _w = make_op(4.0, 250.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 37.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 39.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 38.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %39: Outer Body =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 39.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %40 = OpConvertUToF(112) %4 %35 (i_float)
let _w = make_op(4.0, 112.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 40.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %41 = OpFOrdGreaterThan(186) %25 %40 %29 (i_float > 3.0)
let _w = make_op(5.0, 186.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 41.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 40.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 29.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpSelectionMerge %53 None
let _w = make_op(3.0, 247.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 53.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranchConditional %41 %42 %50 (true=inner loop, false=simple add)
let _w = make_op(4.0, 250.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 41.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 50.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %42: True Branch (enter inner loop) =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %43
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 43.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %43: Inner Loop Header =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 43.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %44 = OpPhi %4 %28 %42 %49 %48 (s: 0.0 from true_entry, new_s from inner_continue)
let _w = make_op(7.0, 245.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 44.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 49.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 48.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %45 = OpPhi %5 %26 %42 %52 %48 (j: 1 from true_entry, new_j from inner_continue)
let _w = make_op(7.0, 245.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 45.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 42.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 52.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 48.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpLoopMerge %47 %48 None
let _w = make_op(4.0, 246.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 47.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 48.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %46
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 46.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %46: Inner Cond =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 46.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %51 = OpULessThanEqual %25 %45 %35 (j <= i)
let _w = make_op(5.0, 178.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 51.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 45.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranchConditional %51 %57 %47
let _w = make_op(4.0, 250.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 51.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 57.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 47.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %57: Inner Body =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 57.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %58 = OpConvertUToF(112) %4 %45 (float(j))
let _w = make_op(4.0, 112.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 58.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 45.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %49 = OpFAdd %4 %44 %58 (new_s = s + float(j))
let _w = make_op(5.0, 129.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 49.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 44.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 58.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %48
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 48.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %48: Inner Continue =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 48.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %52 = OpIAdd(128) %5 %45 %26 (new_j = j + 1)
let _w = make_op(5.0, 128.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 52.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 45.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %43 (back-edge)
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 43.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %47: Inner Merge =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 47.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %53 (to selection merge)
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 53.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %50: False Branch =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 50.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %53
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 53.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %53: Selection Merge =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 53.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %59 = OpPhi %4 %44 %47 %40 %50 (inner_sum from inner_merge, i_float from false)
let _w = make_op(7.0, 245.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 59.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 44.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 47.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 40.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 50.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %55 = OpFAdd %4 %34 %59 (new_acc = acc + branch_val)
let _w = make_op(5.0, 129.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 55.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 59.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %54
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 54.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %54: Outer Continue =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 54.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %56 = OpIAdd(128) %5 %35 %26 (new_i = i + 1)
let _w = make_op(5.0, 128.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 56.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch %33 (outer back-edge)
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK %38: Outer Merge =====
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 38.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %60 = OpAccessChain %17 %13 %16 %20 (output[gid])
let _w = make_op(6.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 60.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpStore %60 %34 (store acc)
let _w = make_op(3.0, 62.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 60.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpReturn
let _w = make_op(1.0, 253.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))

// OpFunctionEnd
let _w = make_op(1.0, 56.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))

// ===================== WRITE =====================
let byte_count = len(buf)
let word_count = byte_count / 4.0
print("SPIR-V [nested loop>branch>loop] emitted: {word_count} words ({byte_count} bytes)")
write_bytes(out_path, buf)
print("Written to {out_path}")
