// stdlib/compiler/spirv_emit_branch.flow
// Structured Control Flow SPIR-V Emitter — Pure OctoFlow
//
// Emits a compute shader with OpSelectionMerge + OpPhi:
//   if (val > 5.0)
//     result = val * 10.0
//   else
//     result = val + 100.0
//   output[gid] = result
//
// This proves: OpSelectionMerge, OpBranchConditional, OpBranch, OpPhi,
//   proper dominance structure, multiple basic blocks, SSA value merging
//
// Equivalent to tests/gpu_shaders/02_branch.comp
//
// SPIR-V opcodes used:
//   OpTypeBool(20)  OpFOrdGreaterThan(186)  OpSelectionMerge(247)
//   OpBranchConditional(250)  OpBranch(249)  OpPhi(245)
//
// ID allocation:
//   %1=void  %2=fn_type  %3=main  %4=float  %5=uint  %6=uvec3
//   %7=ptr_in_uvec3  %8=gl_GlobalInvocationID  %9=rt_array  %10=struct
//   %11=ptr_sb_struct  %12=input_var  %13=output_var  %14=entry_label
//   %15=ptr_in_uint  %16=const_uint_0  %17=ptr_sb_float
//   %18=const_5.0  %19=gid_chain  %20=gid  %21=input_chain  %22=val
//   %25=bool_type  %26=const_10.0  %27=const_100.0
//   %28=cmp_result  %29=true_label  %30=false_label  %31=merge_label
//   %32=mul_result  %33=add_result  %34=phi_result  %24=output_chain
//   Bound=35

let mut out_path = env("SPIRV_OUTPUT")
if out_path == ""
  out_path = "spirv_branch.spv"
end

fn make_op(wc, op)
  return (wc << 16.0) | op
end
fn wb0(w)
  return w & 255.0
end
fn wb1(w)
  return (w >> 8.0) & 255.0
end
fn wb2(w)
  return (w >> 16.0) & 255.0
end
fn wb3(w)
  return (w >> 24.0) & 255.0
end

let mut buf = []

// ===================== SECTION 1: Header =====================
// Magic 0x07230203
push(buf, 3.0)
push(buf, 2.0)
push(buf, 35.0)
push(buf, 7.0)
// Version 1.4 = 0x00010400 = 66560
let _w = 66560.0
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
// Generator=0
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// Bound=35
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// Schema=0
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 2: Capability =====================
// OpCapability(17) Shader(1)
let _w = make_op(2.0, 17.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 3: MemoryModel =====================
// OpMemoryModel(14) Logical(0) GLSL450(1)
let _w = make_op(3.0, 14.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 4: EntryPoint =====================
// OpEntryPoint(15) GLCompute(5) %3 "main" %8 %12 %13
let _w = make_op(8.0, 15.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// "main" = 109,97,105,110 + null pad
push(buf, 109.0)
push(buf, 97.0)
push(buf, 105.0)
push(buf, 110.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// Interface: %8 %12 %13
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 5: ExecutionMode =====================
// OpExecutionMode(16) %3 LocalSize(17) 256 1 1
let _w = make_op(6.0, 16.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// 256 = 0x100
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 6: Annotations =====================
// OpDecorate %8 BuiltIn(11) GlobalInvocationId(28)
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %10 Block(2)
let _w = make_op(3.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpMemberDecorate %10 0 Offset(35) 0
let _w = make_op(5.0, 72.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 35.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %9 ArrayStride(6) 4
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %12 DescriptorSet(34) 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %12 Binding(33) 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %13 DescriptorSet(34) 0
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpDecorate %13 Binding(33) 1
let _w = make_op(4.0, 71.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 7: Types/Variables/Constants =====================
// %1 = OpTypeVoid
let _w = make_op(2.0, 19.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %2 = OpTypeFunction %1
let _w = make_op(3.0, 33.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %4 = OpTypeFloat 32
let _w = make_op(3.0, 22.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %5 = OpTypeInt 32 0
let _w = make_op(4.0, 21.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %6 = OpTypeVector %5 3
let _w = make_op(4.0, 23.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %7 = OpTypePointer Input %6
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 7.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 6.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %9 = OpTypeRuntimeArray %4
let _w = make_op(3.0, 29.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %10 = OpTypeStruct %9
let _w = make_op(3.0, 30.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 9.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %11 = OpTypePointer StorageBuffer %10
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 10.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %15 = OpTypePointer Input %5
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 15.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %17 = OpTypePointer StorageBuffer %4
let _w = make_op(4.0, 32.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %25 = OpTypeBool
let _w = make_op(2.0, 20.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// Constants
// %16 = OpConstant %5 0 (uint zero)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %18 = OpConstant %4 5.0 (threshold)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 18.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, float_byte(5.0, 0.0))
push(buf, float_byte(5.0, 1.0))
push(buf, float_byte(5.0, 2.0))
push(buf, float_byte(5.0, 3.0))

// %26 = OpConstant %4 10.0 (multiply factor)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, float_byte(10.0, 0.0))
push(buf, float_byte(10.0, 1.0))
push(buf, float_byte(10.0, 2.0))
push(buf, float_byte(10.0, 3.0))

// %27 = OpConstant %4 100.0 (add offset)
let _w = make_op(4.0, 43.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 27.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, float_byte(100.0, 0.0))
push(buf, float_byte(100.0, 1.0))
push(buf, float_byte(100.0, 2.0))
push(buf, float_byte(100.0, 3.0))

// Variables
// %8 = OpVariable %7 Input
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 7.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %12 = OpVariable %11 StorageBuffer
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %13 = OpVariable %11 StorageBuffer
let _w = make_op(4.0, 59.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 11.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===================== SECTION 8: Function =====================
// OpFunction %1 %3 None %2
let _w = make_op(5.0, 54.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 1.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 3.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 2.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK: %14 (entry) =====
// OpLabel %14
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 14.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %19 = OpAccessChain %15 %8 %16  (gid.x pointer)
let _w = make_op(5.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 15.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 19.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 8.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %20 = OpLoad %5 %19  (gid = gl_GlobalInvocationID.x)
let _w = make_op(4.0, 61.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 5.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 19.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %21 = OpAccessChain %17 %12 %16 %20  (input[gid] pointer)
let _w = make_op(6.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 21.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 12.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %22 = OpLoad %4 %21  (val = input[gid])
let _w = make_op(4.0, 61.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 21.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %28 = OpFOrdGreaterThan(186) %25 %22 %18  (val > 5.0)
let _w = make_op(5.0, 186.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 25.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 18.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpSelectionMerge(247) %31 None(0)
let _w = make_op(3.0, 247.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 31.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranchConditional(250) %28 %29 %30
let _w = make_op(4.0, 250.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 28.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 29.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK: %29 (true branch: val * 10.0) =====
// OpLabel %29
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 29.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %32 = OpFMul(133) %4 %22 %26  (val * 10.0)
let _w = make_op(5.0, 133.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 26.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch(249) %31
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 31.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK: %30 (false branch: val + 100.0) =====
// OpLabel %30
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %33 = OpFAdd(129) %4 %22 %27  (val + 100.0)
let _w = make_op(5.0, 129.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 22.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 27.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpBranch(249) %31
let _w = make_op(2.0, 249.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 31.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// ===== BLOCK: %31 (merge — OpPhi + store) =====
// OpLabel %31
let _w = make_op(2.0, 248.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 31.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %34 = OpPhi(245) %4 %32 %29 %33 %30
// word count = 3 + 2*2 = 7
let _w = make_op(7.0, 245.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 4.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// value from true branch (%32) via %29
push(buf, 32.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 29.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
// value from false branch (%33) via %30
push(buf, 33.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 30.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// %24 = OpAccessChain %17 %13 %16 %20  (output[gid] pointer)
let _w = make_op(6.0, 65.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 17.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 24.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 13.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 16.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 20.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpStore %24 %34
let _w = make_op(3.0, 62.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))
push(buf, 24.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 34.0)
push(buf, 0.0)
push(buf, 0.0)
push(buf, 0.0)

// OpReturn
let _w = make_op(1.0, 253.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))

// OpFunctionEnd
let _w = make_op(1.0, 56.0)
push(buf, wb0(_w))
push(buf, wb1(_w))
push(buf, wb2(_w))
push(buf, wb3(_w))

// ===================== WRITE =====================
let byte_count = len(buf)
let word_count = byte_count / 4.0
print("SPIR-V [branch+phi] emitted: {word_count} words ({byte_count} bytes)")
write_bytes(out_path, buf)
print("Written to {out_path}")
