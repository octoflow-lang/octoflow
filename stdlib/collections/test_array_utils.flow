// test_array_utils.flow — Tests for stdlib/collections/array_utils.flow
use "array_utils"

fn check(name, cond)
    if cond
        print("PASS: {name}")
    else
        print("FAIL: {name}")
        assert(0.0 == 1.0, name)
    end
    return 0.0
end

// ── Unique ──────────────────────────────────────────────────────

fn test_unique()
    let mut arr = [1.0, 2.0, 2.0, 3.0, 1.0, 4.0, 3.0]
    let mut u = array_unique(arr)
    check("unique count", len(u) == 4.0)
    check("unique order", u[0] == 1.0 && u[1] == 2.0 && u[2] == 3.0 && u[3] == 4.0)
    return 0.0
end

fn test_unique_already()
    let mut arr = [1.0, 2.0, 3.0]
    let mut u = array_unique(arr)
    check("unique no-op", len(u) == 3.0)
    return 0.0
end

// ── Zip / Unzip ─────────────────────────────────────────────────

fn test_zip()
    let mut a = [1.0, 2.0, 3.0]
    let mut b = [10.0, 20.0, 30.0]
    let mut z = array_zip(a, b)
    check("zip length", len(z) == 6.0)
    check("zip values", z[0] == 1.0 && z[1] == 10.0 && z[2] == 2.0 && z[3] == 20.0)
    return 0.0
end

fn test_zip_unequal()
    let mut a = [1.0, 2.0]
    let mut b = [10.0, 20.0, 30.0]
    let mut z = array_zip(a, b)
    check("zip unequal", len(z) == 4.0)
    return 0.0
end

fn test_unzip()
    let mut arr = [1.0, 10.0, 2.0, 20.0, 3.0, 30.0]
    let mut first = array_unzip_first(arr)
    let mut second = array_unzip_second(arr)
    check("unzip first", first[0] == 1.0 && first[1] == 2.0 && first[2] == 3.0)
    check("unzip second", second[0] == 10.0 && second[1] == 20.0 && second[2] == 30.0)
    return 0.0
end

// ── Chunking ────────────────────────────────────────────────────

fn test_chunk()
    let mut arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    check("chunk count", array_chunk_count(arr, 2.0) == 3.0)
    let mut c0 = array_chunk_get(arr, 2.0, 0.0)
    let mut c1 = array_chunk_get(arr, 2.0, 1.0)
    let mut c2 = array_chunk_get(arr, 2.0, 2.0)
    check("chunk 0", c0[0] == 1.0 && c0[1] == 2.0 && len(c0) == 2.0)
    check("chunk 1", c1[0] == 3.0 && c1[1] == 4.0)
    check("chunk 2 (partial)", len(c2) == 1.0 && c2[0] == 5.0)
    return 0.0
end

// ── Take / Drop ─────────────────────────────────────────────────

fn test_take()
    let mut arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    let mut t = array_take(arr, 3.0)
    check("take 3", len(t) == 3.0 && t[2] == 3.0)
    return 0.0
end

fn test_drop()
    let mut arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    let mut d = array_drop(arr, 2.0)
    check("drop 2", len(d) == 3.0 && d[0] == 3.0)
    return 0.0
end

fn test_take_last()
    let mut arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    let mut t = array_take_last(arr, 2.0)
    check("take_last 2", len(t) == 2.0 && t[0] == 4.0 && t[1] == 5.0)
    return 0.0
end

// ── Rotation ────────────────────────────────────────────────────

fn test_rotate_left()
    let mut arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    let mut r = array_rotate_left(arr, 2.0)
    check("rotate_left 2", r[0] == 3.0 && r[1] == 4.0 && r[4] == 2.0)
    return 0.0
end

fn test_rotate_right()
    let mut arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    let mut r = array_rotate_right(arr, 2.0)
    check("rotate_right 2", r[0] == 4.0 && r[1] == 5.0 && r[4] == 3.0)
    return 0.0
end

// ── Insert / Remove ─────────────────────────────────────────────

fn test_insert_at()
    let mut arr = [1.0, 2.0, 4.0, 5.0]
    let mut r = array_insert_at(arr, 2.0, 3.0)
    check("insert_at", len(r) == 5.0 && r[2] == 3.0 && r[3] == 4.0)
    return 0.0
end

fn test_remove_at()
    let mut arr = [1.0, 2.0, 3.0, 4.0, 5.0]
    let mut r = array_remove_at(arr, 2.0)
    check("remove_at", len(r) == 4.0 && r[2] == 4.0)
    return 0.0
end

// ── Utilities ───────────────────────────────────────────────────

fn test_compact()
    let mut arr = [1.0, 0.0, 2.0, 0.0, 3.0]
    let mut c = array_compact(arr)
    check("compact", len(c) == 3.0 && c[0] == 1.0 && c[2] == 3.0)
    return 0.0
end

fn test_repeat_each()
    let mut arr = [1.0, 2.0, 3.0]
    let mut r = array_repeat_each(arr, 2.0)
    check("repeat_each", len(r) == 6.0 && r[0] == 1.0 && r[1] == 1.0 && r[2] == 2.0)
    return 0.0
end

fn test_cumsum()
    let mut arr = [1.0, 2.0, 3.0, 4.0]
    let mut cs = array_cumsum(arr)
    check("cumsum", cs[0] == 1.0 && cs[1] == 3.0 && cs[2] == 6.0 && cs[3] == 10.0)
    return 0.0
end

fn test_diff()
    let mut arr = [1.0, 3.0, 6.0, 10.0]
    let mut d = array_diff(arr)
    check("diff", len(d) == 3.0 && d[0] == 2.0 && d[1] == 3.0 && d[2] == 4.0)
    return 0.0
end

// ── Run all ─────────────────────────────────────────────────────

test_unique()
test_unique_already()
test_zip()
test_zip_unequal()
test_unzip()
test_chunk()
test_take()
test_drop()
test_take_last()
test_rotate_left()
test_rotate_right()
test_insert_at()
test_remove_at()
test_compact()
test_repeat_each()
test_cumsum()
test_diff()
print("")
print("All array_utils tests passed (17 tests)")
