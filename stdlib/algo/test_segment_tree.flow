// test_segment_tree.flow — Tests for stdlib/algo/segment_tree.flow
use "segment_tree"

fn check(name, cond)
    if cond
        print("PASS: {name}")
    else
        print("FAIL: {name}")
        assert(0.0 == 1.0, name)
    end
    return 0.0
end

// ── Range sum ─────────────────────────────────────────────

fn test_sum_basic()
    let mut arr = [1.0, 3.0, 5.0, 7.0, 9.0, 11.0]
    let st = seg_build_sum(arr)
    check("sum all", seg_query(st, 0.0, 5.0) == 36.0)
    check("sum 1-3", seg_query(st, 1.0, 3.0) == 15.0)
    check("sum single", seg_query(st, 2.0, 2.0) == 5.0)
    check("sum 0-0", seg_query(st, 0.0, 0.0) == 1.0)
    return 0.0
end

fn test_sum_update()
    let mut arr = [1.0, 3.0, 5.0, 7.0, 9.0, 11.0]
    let mut st = seg_build_sum(arr)
    seg_update(st, 2.0, 10.0)  // arr[2] = 10
    check("sum after update", seg_query(st, 1.0, 3.0) == 20.0)  // 3+10+7
    check("sum full after", seg_query(st, 0.0, 5.0) == 41.0)  // 36-5+10
    return 0.0
end

// ── Range min ─────────────────────────────────────────────

fn test_min()
    let mut arr = [5.0, 2.0, 8.0, 1.0, 9.0, 3.0]
    let st = seg_build_min(arr)
    check("min all", seg_query(st, 0.0, 5.0) == 1.0)
    check("min 0-2", seg_query(st, 0.0, 2.0) == 2.0)
    check("min 3-5", seg_query(st, 3.0, 5.0) == 1.0)
    check("min single", seg_query(st, 4.0, 4.0) == 9.0)
    return 0.0
end

fn test_min_update()
    let mut arr = [5.0, 2.0, 8.0, 1.0, 9.0, 3.0]
    let mut st = seg_build_min(arr)
    seg_update(st, 3.0, 10.0)  // arr[3] = 10 (was min)
    check("min after update", seg_query(st, 0.0, 5.0) == 2.0)
    return 0.0
end

// ── Range max ─────────────────────────────────────────────

fn test_max()
    let mut arr = [5.0, 2.0, 8.0, 1.0, 9.0, 3.0]
    let st = seg_build_max(arr)
    check("max all", seg_query(st, 0.0, 5.0) == 9.0)
    check("max 0-2", seg_query(st, 0.0, 2.0) == 8.0)
    check("max 4-5", seg_query(st, 4.0, 5.0) == 9.0)
    return 0.0
end

// ── Size ──────────────────────────────────────────────────

fn test_size()
    let mut arr = [1.0, 2.0, 3.0]
    let st = seg_build_sum(arr)
    check("size", seg_size(st) == 3.0)
    return 0.0
end

// ── Edge cases ────────────────────────────────────────────

fn test_single_element()
    let mut arr = [42.0]
    let st = seg_build_sum(arr)
    check("single sum", seg_query(st, 0.0, 0.0) == 42.0)
    let mut stm = seg_build_min(arr)
    check("single min", seg_query(stm, 0.0, 0.0) == 42.0)
    return 0.0
end

fn test_two_elements()
    let mut arr = [10.0, 20.0]
    let st = seg_build_sum(arr)
    check("two sum", seg_query(st, 0.0, 1.0) == 30.0)
    check("two first", seg_query(st, 0.0, 0.0) == 10.0)
    check("two second", seg_query(st, 1.0, 1.0) == 20.0)
    return 0.0
end

// ── Run all ───────────────────────────────────────────────

test_sum_basic()
test_sum_update()
test_min()
test_min_update()
test_max()
test_size()
test_single_element()
test_two_elements()
print("")
print("All segment_tree tests passed (8 tests)")
