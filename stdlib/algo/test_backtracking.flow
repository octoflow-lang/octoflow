// test_backtracking.flow — Tests for stdlib/algo/backtracking.flow
use "backtracking"

fn check(name, cond)
    if cond
        print("PASS: {name}")
    else
        print("FAIL: {name}")
        assert(0.0 == 1.0, name)
    end
    return 0.0
end

// ── N-Queens ────────────────────────────────────────────────

fn test_nqueens_4()
    let sol = bt_n_queens(4.0)
    check("4queens found", len(sol) == 4.0)
    // Verify no queens attack each other
    let mut valid = 1.0
    let mut i = 0.0
    while i < 4.0
        let mut j = i + 1.0
        while j < 4.0
            if sol[i] == sol[j]
                valid = 0.0
            end
            if abs(sol[i] - sol[j]) == abs(i - j)
                valid = 0.0
            end
            j = j + 1.0
        end
        i = i + 1.0
    end
    check("4queens valid", valid == 1.0)
    return 0.0
end

fn test_nqueens_count()
    check("4queens count", bt_n_queens_count(4.0) == 2.0)
    check("5queens count", bt_n_queens_count(5.0) == 10.0)
    return 0.0
end

fn test_nqueens_impossible()
    let sol = bt_n_queens(3.0)
    check("3queens impossible", len(sol) == 0.0)
    return 0.0
end

// ── Sudoku ──────────────────────────────────────────────────

fn test_sudoku_validation()
    // Create a partially filled board
    let mut board = []
    let mut i = 0.0
    while i < 81.0
        push(board, 0.0)
        i = i + 1.0
    end
    board[0] = 5.0  // row 0, col 0
    check("valid place", bt_is_valid_sudoku(board, 0.0, 1.0, 3.0) == 1.0)
    check("invalid row", bt_is_valid_sudoku(board, 0.0, 1.0, 5.0) == 0.0)
    return 0.0
end

fn test_sudoku_solve()
    // Simple puzzle with known solution
    let mut board = [
        5.0, 3.0, 0.0, 0.0, 7.0, 0.0, 0.0, 0.0, 0.0,
        6.0, 0.0, 0.0, 1.0, 9.0, 5.0, 0.0, 0.0, 0.0,
        0.0, 9.0, 8.0, 0.0, 0.0, 0.0, 0.0, 6.0, 0.0,
        8.0, 0.0, 0.0, 0.0, 6.0, 0.0, 0.0, 0.0, 3.0,
        4.0, 0.0, 0.0, 8.0, 0.0, 3.0, 0.0, 0.0, 1.0,
        7.0, 0.0, 0.0, 0.0, 2.0, 0.0, 0.0, 0.0, 6.0,
        0.0, 6.0, 0.0, 0.0, 0.0, 0.0, 2.0, 8.0, 0.0,
        0.0, 0.0, 0.0, 4.0, 1.0, 9.0, 0.0, 0.0, 5.0,
        0.0, 0.0, 0.0, 0.0, 8.0, 0.0, 0.0, 7.0, 9.0
    ]
    let solved = bt_sudoku_solve(board)
    check("sudoku solved", solved == 1.0)
    // Check no zeros remain
    let mut all_filled = 1.0
    let mut i = 0.0
    while i < 81.0
        if board[i] == 0.0
            all_filled = 0.0
        end
        i = i + 1.0
    end
    check("sudoku complete", all_filled == 1.0)
    // Check specific known values
    check("sudoku [0,2]", board[2] == 4.0)
    return 0.0
end

// ── Subsets count ───────────────────────────────────────────

fn test_subsets_count()
    check("2^0", bt_generate_subsets_count(0.0) == 1.0)
    check("2^3", bt_generate_subsets_count(3.0) == 8.0)
    check("2^5", bt_generate_subsets_count(5.0) == 32.0)
    return 0.0
end

// ── Generate parentheses ────────────────────────────────────

fn test_parentheses()
    let p1 = bt_generate_parentheses(1.0)
    check("parens 1", len(p1) == 1.0)

    let p2 = bt_generate_parentheses(2.0)
    check("parens 2", len(p2) == 2.0)

    let p3 = bt_generate_parentheses(3.0)
    check("parens 3", len(p3) == 5.0)
    // Catalan(3) = 5
    return 0.0
end

fn test_parentheses_valid()
    let p = bt_generate_parentheses(2.0)
    // Each string should be valid parentheses
    let mut all_valid = 1.0
    let mut i = 0.0
    while i < len(p)
        let s = p[i]
        let mut depth = 0.0
        let mut j = 0.0
        while j < len(s)
            if char_at(s, j) == "("
                depth = depth + 1.0
            else
                depth = depth - 1.0
            end
            if depth < 0.0
                all_valid = 0.0
            end
            j = j + 1.0
        end
        if depth != 0.0
            all_valid = 0.0
        end
        i = i + 1.0
    end
    check("parens valid", all_valid == 1.0)
    return 0.0
end

// ── Run all ─────────────────────────────────────────────────

test_nqueens_4()
test_nqueens_count()
test_nqueens_impossible()
test_sudoku_validation()
test_sudoku_solve()
test_subsets_count()
test_parentheses()
test_parentheses_valid()
print("")
print("All backtracking tests passed (8 tests)")
