// OctoBrain Text Preprocessing Tests
// Tests for lib/text.flow — uses PASS/FAIL print pattern.

use "../lib/text"
use "../lib/vecmath"

// ── Helper: approximate equality ──────────────────────────────
fn approx_eq(a, b, tol)
  let mut diff = a - b
  if diff < 0.0
    diff = diff * -1.0
  end
  if diff < tol
    return 1.0
  end
  return 0.0
end

// ══════════════════════════════════════════════════════════════
// Test 1: text_to_codes single char
// ══════════════════════════════════════════════════════════════

let codes1 = text_to_codes("A")
let c1_len = len(codes1)
let c1_val = codes1[0]
// ord("A") = 65, 65/128 = 0.507813
if approx_eq(c1_len, 1.0, 0.001) > 0.5 && approx_eq(c1_val, 0.507813, 0.001) > 0.5
  print("PASS test1: text_to_codes(A) = [0.5078]")
else
  print("FAIL test1: expected len=1 val=0.5078, got len={c1_len} val={c1_val}")
end

// ══════════════════════════════════════════════════════════════
// Test 2: text_to_codes space
// ══════════════════════════════════════════════════════════════

let codes2 = text_to_codes(" ")
let c2_val = codes2[0]
// ord(" ") = 32, 32/128 = 0.25
if approx_eq(c2_val, 0.25, 0.001) > 0.5
  print("PASS test2: text_to_codes(space) = [0.25]")
else
  print("FAIL test2: expected 0.25, got {c2_val}")
end

// ══════════════════════════════════════════════════════════════
// Test 3: text_ngram basic extraction
// ══════════════════════════════════════════════════════════════

let codes3 = text_to_codes("ABCD")
let gram3 = text_ngram(codes3, 1.0, 2.0)
let g3_len = len(gram3)
let g3_0 = gram3[0]
let g3_1 = gram3[1]
// B=66/128=0.515625, C=67/128=0.523438
if approx_eq(g3_len, 2.0, 0.001) > 0.5 && approx_eq(g3_0, 0.515625, 0.001) > 0.5 && approx_eq(g3_1, 0.523438, 0.001) > 0.5
  print("PASS test3: text_ngram extracts correct window [B,C]")
else
  print("FAIL test3: expected [0.5156, 0.5234], got [{g3_0}, {g3_1}]")
end

// ══════════════════════════════════════════════════════════════
// Test 4: text_ngram padding past end
// ══════════════════════════════════════════════════════════════

let codes4 = text_to_codes("AB")
let gram4 = text_ngram(codes4, 1.0, 3.0)
let g4_len = len(gram4)
let g4_2 = gram4[2]
if approx_eq(g4_len, 3.0, 0.001) > 0.5 && approx_eq(g4_2, 0.0, 0.001) > 0.5
  print("PASS test4: text_ngram pads past end with 0.0")
else
  print("FAIL test4: expected len=3 with padding, got len={g4_len} pad={g4_2}")
end

// ══════════════════════════════════════════════════════════════
// Test 5: codes_to_text round-trip "Hi"
// ══════════════════════════════════════════════════════════════

let codes5 = text_to_codes("Hi")
let rt5 = codes_to_text(codes5)
if rt5 == "Hi"
  print("PASS test5: codes_to_text round-trips Hi")
else
  print("FAIL test5: expected Hi, got {rt5}")
end

// ══════════════════════════════════════════════════════════════
// Test 6: codes_to_text round-trip "Hello"
// ══════════════════════════════════════════════════════════════

let codes6 = text_to_codes("Hello")
let rt6 = codes_to_text(codes6)
if rt6 == "Hello"
  print("PASS test6: codes_to_text round-trips Hello")
else
  print("FAIL test6: expected Hello, got {rt6}")
end

// ══════════════════════════════════════════════════════════════
// Test 7: text_to_codes preserves length
// ══════════════════════════════════════════════════════════════

let codes7 = text_to_codes("test string")
let c7_len = len(codes7)
if approx_eq(c7_len, 11.0, 0.001) > 0.5
  print("PASS test7: text_to_codes preserves length (11 chars)")
else
  print("FAIL test7: expected 11, got {c7_len}")
end

// ══════════════════════════════════════════════════════════════
// Test 8: decode_proto approximate decode
// ══════════════════════════════════════════════════════════════

let codes8 = text_to_codes("the")
let norm8 = normalize(codes8, 3.0)
let dec8 = decode_proto(norm8, 3.0)
print("test8 (diagnostic): decode_proto of normalized 'the' = '{dec8}'")
if dec8 == "the"
  print("PASS test8: decode_proto recovers 'the' exactly")
else
  print("NOTE test8: approximate decode produced '{dec8}' (expected — normalization loses magnitude)")
end

print("--- text tests complete ---")
