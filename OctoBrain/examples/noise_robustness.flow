// OctoBrain Noise Robustness Demo
// Injects 20% amplitude noise into sine wave data and tests whether
// brain topology (prototypes, edges, transitions) survives.
//
// Expected behavior: Brain still captures the underlying manifold
// despite noise — proto count may vary but structure persists.

use "../lib/octobrain"

// ── Create brain with 2 actions ──────────────────────────────────
let mut brain = octobrain_new(2.0)

// Proto arrays
let mut p_state = proto_new()
let mut p_embs = []
let mut p_mc = []

// Embed arrays
let mut e_state = embed_new()
let mut W_embed = []
let mut obs_buffer = []

// Edge arrays
let mut edge_state = edges_new()
let mut en = []
let mut ea = []
let mut eo = []
let mut ep = []
let mut ew = []
let mut eact = []

// Context window
let mut window = []

// Action weights
let mut W_score = []

print("=== OctoBrain Noise Robustness Demo ===")
print("Feeding 1000 points of [sin(t)+noise, cos(t)+noise, sin(2t)+noise]...")
print("Noise: 20% amplitude (uniform in [-0.2, 0.2])")
print("")

// ── Generate and feed noisy sine wave data ──────────────────────
let mut t = 0.0
let mut step = 0.0
while step < 1000.0
  // Generate noise in [-0.2, 0.2] for each component
  let n1 = random() * 0.4 - 0.2
  let n2 = random() * 0.4 - 0.2
  let n3 = random() * 0.4 - 0.2

  let x1 = sin(t) + n1
  let x2 = cos(t) + n2
  let x3 = sin(2.0 * t) + n3
  let data = [x1, x2, x3]
  let dummy = octobrain_observe(brain, p_state, p_embs, p_mc, e_state, W_embed, obs_buffer, edge_state, en, ea, eo, ep, ew, eact, window, W_score, data)

  // Print stats at milestones
  if step == 99.0 || step == 249.0 || step == 499.0 || step == 749.0 || step == 999.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    let oc = map_get(stats, "obs_count")
    let report_step = step + 1.0
    print("Step {report_step}: protos={pc}, edges={ec}, transitions={tc}, obs={oc}")
  end

  t = t + 0.1
  step = step + 1.0
end

print("")

// ── Final analysis ───────────────────────────────────────────────
let final_stats = octobrain_stats(brain, p_state, edge_state)
let final_pc = map_get(final_stats, "proto_count")
let final_ec = map_get(final_stats, "edge_count")
let final_tc = map_get(final_stats, "transition_count")

print("=== Final Results ===")
print("Prototypes discovered: {final_pc}")
print("Edges learned: {final_ec}")
print("Transitions detected: {final_tc}")

// Analysis — compare noisy results against clean baseline (10 protos)
if final_pc >= 2.0 && final_pc <= 30.0
  print("PASS: Manifold captured despite noise ({final_pc} protos, clean=10)")
else
  print("NOTE: {final_pc} protos (unusual — noise may have overwhelmed structure)")
end

if final_tc > 0.0
  print("PASS: Phase detection robust — {final_tc} transitions detected")
else
  print("NOTE: No transitions — noise may mask phase changes")
end

if final_ec > 0.0
  print("PASS: Topology preserved — {final_ec} edges learned")
else
  print("NOTE: No edges — structure may be too noisy")
end

print("")
print("--- noise robustness demo complete ---")
