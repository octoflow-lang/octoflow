// OctoBrain Regime Change Benchmark
// Tests abrupt signal switching between 3 regimes, cycled twice (1200 total observations).
//
// Regime A (steps 0-199, 600-799):   [sin(t), cos(t), 0.0, 0.0]       — rotation in dims 1-2
// Regime B (steps 200-399, 800-999): [0.0, 0.0, sin(3t), cos(3t)]     — rotation in dims 3-4, triple freq
// Regime C (steps 400-599, 1000-1199): [sin(t), sin(t), sin(t), sin(t)] — all dims correlated
//
// At each regime boundary, we record proto_count before and after to see if the brain
// detects the switch and whether it reuses protos on revisit.
//
// Run: powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\OctoFlow\run_test.ps1" run --bin octoflow -- run "C:\OctoFlow\OctoBrain\examples\regime_change.flow"

use "../lib/octobrain"

// ── Create brain with 2 actions ──────────────────────────────────
let mut brain = octobrain_new(2.0)

// Proto arrays
let mut p_state = proto_new()
let mut p_embs = []
let mut p_mc = []

// Embed arrays
let mut e_state = embed_new()
let mut W_embed = []
let mut obs_buffer = []

// Edge arrays
let mut edge_state = edges_new()
let mut en = []
let mut ea = []
let mut eo = []
let mut ep = []
let mut ew = []
let mut eact = []

// Context window
let mut window = []

// Action weights
let mut W_score = []

print("=== OctoBrain Regime Change Benchmark ===")
print("Three regimes (A: xy-rotation, B: zw-rotation, C: degenerate), cycled twice")
print("")

// ── Tracking variables for analysis ──────────────────────────────
let mut pc_at_200 = 0.0
let mut pc_at_600 = 0.0
let mut pc_at_800 = 0.0
let mut tc_at_199 = 0.0
let mut tc_at_200 = 0.0
let mut tc_at_399 = 0.0
let mut tc_at_400 = 0.0

// ── Main loop: 1200 observations ─────────────────────────────────
let mut step = 0.0
let mut t = 0.0
while step < 1200.0
  let mut x1 = 0.0
  let mut x2 = 0.0
  let mut x3 = 0.0
  let mut x4 = 0.0

  // Determine regime based on phase within 600-step cycle
  let phase = step - floor(step / 600.0) * 600.0
  if phase < 200.0
    // Regime A: rotation in dims 1-2
    x1 = sin(t)
    x2 = cos(t)
  elif phase < 400.0
    // Regime B: rotation in dims 3-4, triple frequency
    x3 = sin(3.0 * t)
    x4 = cos(3.0 * t)
  else
    // Regime C: all dims correlated (degenerate)
    x1 = sin(t)
    x2 = sin(t)
    x3 = sin(t)
    x4 = sin(t)
  end

  let mut data = []
  push(data, x1)
  push(data, x2)
  push(data, x3)
  push(data, x4)

  let dummy = octobrain_observe(brain, p_state, p_embs, p_mc, e_state, W_embed, obs_buffer, edge_state, en, ea, eo, ep, ew, eact, window, W_score, data)

  // Print at boundary milestones and record tracking values
  if step == 199.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    pc_at_200 = pc
    tc_at_199 = tc
    print("Step 200 (end Regime A):     protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 200.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    tc_at_200 = tc
    print("Step 201 (start Regime B):   protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 399.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    tc_at_399 = tc
    print("Step 400 (end Regime B):     protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 400.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    tc_at_400 = tc
    print("Step 401 (start Regime C):   protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 599.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    pc_at_600 = pc
    print("Step 600 (end Regime C):     protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 600.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    print("Step 601 (start Regime A'):  protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 799.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    pc_at_800 = pc
    print("Step 800 (end Regime A'):    protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 800.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    print("Step 801 (start Regime B'):  protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 999.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    print("Step 1000 (end Regime B'):   protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 1000.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    print("Step 1001 (start Regime C'): protos={pc}, edges={ec}, transitions={tc}")
  end
  if step == 1199.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    print("Step 1200 (end Regime C'):   protos={pc}, edges={ec}, transitions={tc}")
  end

  t = t + 0.1
  step = step + 1.0
end

print("")

// ── Final analysis ───────────────────────────────────────────────
let final_stats = octobrain_stats(brain, p_state, edge_state)
let final_pc = map_get(final_stats, "proto_count")
let final_ec = map_get(final_stats, "edge_count")
let final_tc = map_get(final_stats, "transition_count")

print("=== Analysis ===")

// Check 1: Proto count manageable (< 40 at end)
if final_pc < 40.0
  print("PASS: proto count manageable ({final_pc} < 40)")
else
  print("FAIL: proto count too high ({final_pc} >= 40)")
end

// Check 2: Regime transitions detected (transition_count grows across boundaries)
let tc_grew_ab = tc_at_200 - tc_at_199
let tc_grew_bc = tc_at_400 - tc_at_399
if final_tc > 10.0
  print("PASS: regime transitions detected ({final_tc} total, A->B delta={tc_grew_ab}, B->C delta={tc_grew_bc})")
else
  print("FAIL: too few transitions ({final_tc}, expected > 10)")
end

// Check 3: Proto reuse on regime A revisit
// pc_at_800 is proto count at end of second Regime A (step 799)
// pc_at_600 is proto count at end of first cycle (step 599)
// If brain reuses protos, not many new ones should appear for revisited regime
let new_protos_on_revisit = pc_at_800 - pc_at_600
if new_protos_on_revisit < 5.0
  print("PASS: proto reuse on revisit (new protos={new_protos_on_revisit}, pc@600={pc_at_600}, pc@800={pc_at_800})")
else
  print("FAIL: no proto reuse on revisit (new protos={new_protos_on_revisit}, pc@600={pc_at_600}, pc@800={pc_at_800})")
end

print("--- regime change benchmark complete ---")
