// OctoBrain Multi-Cycle Demo
// Disentanglement test: feeds two unrelated oscillators simultaneously.
// Signal: [sin(t), cos(t), sin(t*2.7), cos(t*2.7)]
// Periods: ~62.8 steps and ~23.3 steps (incommensurate)
//
// Expected behavior: Brain discovers rich prototype and edge structure
// reflecting the compound signal's topology.

use "../lib/octobrain"

// ── Create brain with 2 actions ──────────────────────────────────
let mut brain = octobrain_new(2.0)

// Proto arrays
let mut p_state = proto_new()
let mut p_embs = []
let mut p_mc = []

// Embed arrays
let mut e_state = embed_new()
let mut W_embed = []
let mut obs_buffer = []

// Edge arrays
let mut edge_state = edges_new()
let mut en = []
let mut ea = []
let mut eo = []
let mut ep = []
let mut ew = []
let mut eact = []

// Context window
let mut window = []

// Action weights
let mut W_score = []

print("=== OctoBrain Multi-Cycle Demo ===")
print("Feeding 1000 points of [sin(t), cos(t), sin(t*2.7), cos(t*2.7)]")
print("Two oscillators at incommensurate frequencies (periods ~62.8 and ~23.3 steps)...")
print("")

// ── Generate and feed compound oscillator data ──────────────────
let mut t = 0.0
let mut step = 0.0
while step < 1000.0
  let mut data = []
  push(data, sin(t))
  push(data, cos(t))
  push(data, sin(t * 2.7))
  push(data, cos(t * 2.7))
  let dummy = octobrain_observe(brain, p_state, p_embs, p_mc, e_state, W_embed, obs_buffer, edge_state, en, ea, eo, ep, ew, eact, window, W_score, data)

  // Print stats at milestones
  if step == 99.0 || step == 249.0 || step == 499.0 || step == 749.0 || step == 999.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    let oc = map_get(stats, "obs_count")
    let report_step = step + 1.0
    print("Step {report_step}: protos={pc}, edges={ec}, transitions={tc}, obs={oc}")
  end

  t = t + 0.1
  step = step + 1.0
end

print("")

// ── Final analysis ───────────────────────────────────────────────
let final_stats = octobrain_stats(brain, p_state, edge_state)
let final_pc = map_get(final_stats, "proto_count")
let final_ec = map_get(final_stats, "edge_count")
let final_tc = map_get(final_stats, "transition_count")

print("=== Final Results ===")
print("Prototypes discovered: {final_pc}")
print("Edges learned: {final_ec}")
print("Transitions detected: {final_tc}")
print("")

print("=== Disentanglement Analysis ===")
print("Two oscillators at incommensurate frequencies fed as 4D signal")
if final_pc > 5.0
  print("PASS: Brain discovered {final_pc} prototypes for compound signal")
  print("  → More structure than single oscillator suggests partial disentanglement")
else
  print("NOTE: Only {final_pc} protos — signals may be mixed into single representation")
end

if final_ec > 5.0
  print("PASS: Rich edge structure ({final_ec} edges) — complex topology learned")
else
  print("NOTE: Simple edge structure ({final_ec} edges)")
end

print("")
print("--- multi-cycle demo complete ---")
