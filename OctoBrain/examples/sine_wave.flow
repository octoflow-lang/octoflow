// OctoBrain Sine Wave Demo
// Feeds sine wave data into the brain and shows that it discovers
// prototypes corresponding to different phases of the wave.
//
// Expected behavior: Brain discovers 2-4 prototypes (phases of the sine wave)
// and detects transitions at zero-crossings.

use "../lib/octobrain"

// ── Create brain with 2 actions ──────────────────────────────────
let mut brain = octobrain_new(2.0)

// Proto arrays
let mut p_state = proto_new()
let mut p_embs = []
let mut p_mc = []

// Embed arrays
let mut e_state = embed_new()
let mut W_embed = []
let mut obs_buffer = []

// Edge arrays
let mut edge_state = edges_new()
let mut en = []
let mut ea = []
let mut eo = []
let mut ep = []
let mut ew = []
let mut eact = []

// Context window
let mut window = []

// Action weights
let mut W_score = []

print("=== OctoBrain Sine Wave Demo ===")
print("Feeding 1000 points of [sin(t), cos(t), sin(2t)]...")
print("")

// ── Generate and feed sine wave data ─────────────────────────────
let mut t = 0.0
let mut step = 0.0
while step < 1000.0
  let x1 = sin(t)
  let x2 = cos(t)
  let x3 = sin(2.0 * t)
  let data = [x1, x2, x3]
  let dummy = octobrain_observe(brain, p_state, p_embs, p_mc, e_state, W_embed, obs_buffer, edge_state, en, ea, eo, ep, ew, eact, window, W_score, data)

  // Print stats at milestones
  if step == 99.0 || step == 249.0 || step == 499.0 || step == 749.0 || step == 999.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    let oc = map_get(stats, "obs_count")
    let report_step = step + 1.0
    print("Step {report_step}: protos={pc}, edges={ec}, transitions={tc}, obs={oc}")
  end

  t = t + 0.1
  step = step + 1.0
end

print("")

// ── Final analysis ───────────────────────────────────────────────
let final_stats = octobrain_stats(brain, p_state, edge_state)
let final_pc = map_get(final_stats, "proto_count")
let final_ec = map_get(final_stats, "edge_count")
let final_tc = map_get(final_stats, "transition_count")

print("=== Final Results ===")
print("Prototypes discovered: {final_pc}")
print("Edges learned: {final_ec}")
print("Transitions detected: {final_tc}")

if final_pc >= 2.0 && final_pc <= 15.0
  print("PASS: Brain discovered {final_pc} prototypes (3D sine carves multiple phase regions)")
else
  print("NOTE: Brain discovered {final_pc} prototypes (unusual for this signal)")
end

if final_tc > 0.0
  print("PASS: Brain detected {final_tc} transitions at phase changes")
else
  print("NOTE: No transitions detected (may need parameter tuning)")
end

if final_ec > 0.0
  print("PASS: Brain learned {final_ec} edges connecting prototypes")
else
  print("NOTE: No edges learned yet")
end

print("")
print("--- sine wave demo complete ---")
