// OctoBrain GPU Benchmark
// Performance comparison: CPU vs GPU prototype matching at scales up to 5000.
// Measures average time per iteration for both paths.
//
// Run: powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\OctoFlow\run_test.ps1" run --bin octoflow -- run examples/gpu_benchmark.flow --allow-ffi --allow-read

use "../lib/gpu_match"
use "../lib/vecmath"

// ── Helper: generate deterministic normalized vector ──────────────
// Creates an embed_dim-length vector with a deterministic pattern
// based on seed, then normalizes to unit length.
fn make_unit_vec(seed, embed_dim)
  let mut raw = []
  let mut j = 0.0
  while j < embed_dim
    let val = sin((seed + 1.0) * (j + 1.0) * 0.7)
    push(raw, val)
    j = j + 1.0
  end
  let result = normalize(raw, embed_dim)
  return result
end

// ── CPU benchmark: manual cosine_sim loop ─────────────────────────
fn bench_cpu_match(protos_flat, query, embed_dim, proto_count)
  let mut best_sim = -2.0
  let mut best_id = -1.0
  let mut p = 0.0
  while p < proto_count
    let pv = vec_extract(protos_flat, p, embed_dim)
    let sim = cosine_sim(query, pv, embed_dim)
    if sim > best_sim
      best_sim = sim
      best_id = p
    end
    p = p + 1.0
  end
  return best_sim
end

// ── Generate flat prototype array ─────────────────────────────────
// Returns flat array [proto_count x embed_dim] of normalized vectors.
fn gen_protos(proto_count, embed_dim)
  let mut protos = []
  let mut i = 0.0
  while i < proto_count
    let uv = make_unit_vec(i, embed_dim)
    let mut j = 0.0
    while j < embed_dim
      push(protos, uv[j])
      j = j + 1.0
    end
    i = i + 1.0
  end
  return protos
end

// ══════════════════════════════════════════════════════════════════
// Initialize GPU
// ══════════════════════════════════════════════════════════════════

print("=== OctoBrain GPU Benchmark ===")
print("Comparing CPU vs GPU prototype matching")
print("")

let _init = gpu_match_init()
let embed_dim = 8.0

// ── Query vector (fixed for all benchmarks) ───────────────────────
let query = make_unit_vec(777.0, embed_dim)

// ══════════════════════════════════════════════════════════════════
// Benchmark at each scale
// Scales: 64, 256, 1000, 5000
// Iterations: 10 for scales <= 1000, 1 for 5000 (CPU path is slow at scale)
// ══════════════════════════════════════════════════════════════════

let scales = [64.0, 256.0, 1000.0, 5000.0]
let iters = [10.0, 10.0, 10.0, 1.0]

let mut si = 0.0
while si < 4.0
  let pc = scales[si]
  let num_iters = iters[si]
  let pc_int = int(pc)
  let ni_int = int(num_iters)

  print("--- protos={pc_int}, iters={ni_int} ---")

  // Generate prototypes for this scale
  let protos = gen_protos(pc, embed_dim)

  // CPU benchmark
  let t_cpu_start = time()
  let mut ci = 0.0
  while ci < num_iters
    let _cpu_result = bench_cpu_match(protos, query, embed_dim, pc)
    ci = ci + 1.0
  end
  let t_cpu_end = time()
  let cpu_total = t_cpu_end - t_cpu_start
  let cpu_per = cpu_total / num_iters

  // GPU benchmark
  let t_gpu_start = time()
  let mut gi = 0.0
  while gi < num_iters
    let _gpu_result = gpu_score_all(protos, query, embed_dim, pc)
    gi = gi + 1.0
  end
  let t_gpu_end = time()
  let gpu_total = t_gpu_end - t_gpu_start
  let gpu_per = gpu_total / num_iters

  print("protos={pc_int}: CPU={cpu_per:.4}s/iter  GPU={gpu_per:.4}s/iter")
  print("")

  si = si + 1.0
end

// ══════════════════════════════════════════════════════════════════
// Final 5K gate test
// Create 5000 protos, run gpu_match_best, verify valid best_id.
// ══════════════════════════════════════════════════════════════════

print("--- 5K gate test ---")

let protos_5k = gen_protos(5000.0, embed_dim)
let gate_query = make_unit_vec(2500.0, embed_dim)
let gate_result = gpu_match_best(protos_5k, gate_query, embed_dim, 5000.0)
let gate_id = gate_result[0]
let gate_sim = gate_result[1]

if gate_id >= 0.0 && gate_id < 5000.0 && gate_sim > -1.01 && gate_sim <= 1.01
  let gid_int = int(gate_id)
  print("PASS: 5K prototype matching completed successfully (best_id={gid_int}, sim={gate_sim:.4})")
else
  print("FAIL: 5K gate — invalid result (best_id={gate_id}, sim={gate_sim})")
end

// ══════════════════════════════════════════════════════════════════
// Cleanup
// ══════════════════════════════════════════════════════════════════

let _cleanup = gpu_match_cleanup()

print("")
print("--- benchmark complete ---")
