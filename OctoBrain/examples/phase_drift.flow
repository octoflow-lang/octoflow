// OctoBrain Phase Drift Demo
// Plasticity test: feeds sine wave where frequency slowly increases.
// The frequency drifts from 1.0 to ~1.6 over 2000 points.
//
// Expected behavior: Brain discovers more prototypes than a clean sine wave
// as new phase regions emerge for the drifting frequency.

use "../lib/octobrain"

// ── Create brain with 2 actions ──────────────────────────────────
let mut brain = octobrain_new(2.0)

// Proto arrays
let mut p_state = proto_new()
let mut p_embs = []
let mut p_mc = []

// Embed arrays
let mut e_state = embed_new()
let mut W_embed = []
let mut obs_buffer = []

// Edge arrays
let mut edge_state = edges_new()
let mut en = []
let mut ea = []
let mut eo = []
let mut ep = []
let mut ew = []
let mut eact = []

// Context window
let mut window = []

// Action weights
let mut W_score = []

print("=== OctoBrain Phase Drift Demo ===")
print("Feeding 2000 points of [sin(t*freq), cos(t*freq), sin(2*t*freq)]")
print("where freq drifts from 1.0 to ~1.6...")
print("")

// ── Generate and feed drifting sine wave data ───────────────────
let mut t = 0.0
let mut step = 0.0
while step < 2000.0
  // Frequency drifts: 1.0 + t * 0.0003
  let freq = 1.0 + t * 0.0003
  let x1 = sin(t * freq)
  let x2 = cos(t * freq)
  let x3 = sin(2.0 * t * freq)
  let data = [x1, x2, x3]
  let dummy = octobrain_observe(brain, p_state, p_embs, p_mc, e_state, W_embed, obs_buffer, edge_state, en, ea, eo, ep, ew, eact, window, W_score, data)

  // Print stats at milestones
  if step == 199.0 || step == 499.0 || step == 999.0 || step == 1499.0 || step == 1999.0
    let stats = octobrain_stats(brain, p_state, edge_state)
    let pc = map_get(stats, "proto_count")
    let ec = map_get(stats, "edge_count")
    let tc = map_get(stats, "transition_count")
    let oc = map_get(stats, "obs_count")
    let report_step = step + 1.0
    let current_freq = 1.0 + t * 0.0003
    print("Step {report_step} (freq={current_freq:.3}): protos={pc}, edges={ec}, transitions={tc}, obs={oc}")
  end

  t = t + 0.1
  step = step + 1.0
end

print("")

// ── Final analysis ───────────────────────────────────────────────
let final_stats = octobrain_stats(brain, p_state, edge_state)
let final_pc = map_get(final_stats, "proto_count")
let final_ec = map_get(final_stats, "edge_count")
let final_tc = map_get(final_stats, "transition_count")

print("=== Final Results ===")
print("Prototypes discovered: {final_pc}")
print("Edges learned: {final_ec}")
print("Transitions detected: {final_tc}")
print("")

print("=== Plasticity Analysis ===")
if final_pc > 10.0
  print("PASS: Brain adapted — discovered {final_pc} protos (more than clean sine's 10)")
  print("  → Plasticity is working: new phase regions emerged for drifting frequency")
else
  print("NOTE: {final_pc} protos — brain may be absorbing drift via EMA")
end

if final_tc > 100.0
  print("PASS: Active phase transitions ({final_tc}) — brain tracking frequency changes")
else
  print("NOTE: Low transitions ({final_tc}) — drift may be too gradual to detect")
end

print("")
print("--- phase drift demo complete ---")
