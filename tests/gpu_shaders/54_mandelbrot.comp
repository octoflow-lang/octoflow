#version 450
// mandelbrot â€” Compute Mandelbrot set iteration counts on GPU
//
// Each thread computes one pixel's iteration count.
// Input: complex plane coordinates (cx[], cy[])
// Output: iteration counts (float[])
//
// 3 bindings, 1 push constant (max_iter)
layout(local_size_x = 256) in;

layout(set=0, binding=0) buffer CX       { float data[]; } cx;
layout(set=0, binding=1) buffer CY       { float data[]; } cy;
layout(set=0, binding=2) buffer IterOut  { float data[]; } iter_out;
layout(push_constant) uniform PC { float max_iterations; } pc;

void main() {
    uint gid = gl_GlobalInvocationID.x;

    float px = cx.data[gid];
    float py = cy.data[gid];

    float zx = 0.0;
    float zy = 0.0;
    float iter = 0.0;
    uint max_iter = uint(pc.max_iterations);

    for (uint i = 0u; i < max_iter; i++) {
        float zx2 = zx * zx;
        float zy2 = zy * zy;

        if (zx2 + zy2 > 4.0) {
            break;
        }

        float new_zx = zx2 - zy2 + px;
        float new_zy = 2.0 * zx * zy + py;

        zx = new_zx;
        zy = new_zy;
        iter = iter + 1.0;
    }

    iter_out.data[gid] = iter;
}
