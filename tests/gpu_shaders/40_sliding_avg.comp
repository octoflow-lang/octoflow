#version 450
// sliding_avg â€” Compute sliding window average (moving average)
//
// For each element i: out[i] = sum(inp[max(0, i-W+1) .. i]) / actual_window_size
// where actual_window_size = min(W, i+1) for leading edge elements.
//
// 2 bindings (input, output), 2 push constants (N, W) = 8 bytes
layout(local_size_x = 256) in;

layout(set=0, binding=0) buffer Input  { float data[]; } inp;
layout(set=0, binding=1) buffer Output { float data[]; } out_;
layout(push_constant) uniform PC {
    float n_elements;
    float window_size;
} pc;

void main() {
    uint gid = gl_GlobalInvocationID.x;
    uint N = uint(pc.n_elements);
    uint W = uint(pc.window_size);

    if (gid >= N) return;

    uint start = (gid >= W - 1u) ? (gid - W + 1u) : 0u;
    float sum = 0.0;
    for (uint j = start; j <= gid; j++) {
        sum += inp.data[j];
    }

    // Actual window size (smaller at the leading edge)
    float count = float(gid - start + 1u);
    out_.data[gid] = sum / count;
}
