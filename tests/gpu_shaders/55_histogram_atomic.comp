#version 450
// histogram_atomic — GPU histogram using OpAtomicIAdd (proper implementation)
//
// Each thread bins one element, atomically increments the bin counter.
// Output is uint[] — use 35_uint_to_float.comp to convert.
//
// 2 bindings (input float[], output uint[]), 4 push constants (16 bytes)
layout(local_size_x = 256) in;

layout(set=0, binding=0) buffer Input  { float data[]; } inp;
layout(set=0, binding=1) buffer Output { uint  bins[]; } out_;
layout(push_constant) uniform PC {
    float n_elements;
    float num_bins;
    float min_val;
    float bin_width;
} pc;

void main() {
    uint gid = gl_GlobalInvocationID.x;
    uint N = uint(pc.n_elements);
    uint nbins = uint(pc.num_bins);

    if (gid >= N) return;

    float val = inp.data[gid];
    int bin = int(floor((val - pc.min_val) / pc.bin_width));

    // Clamp to valid range
    if (bin < 0) bin = 0;
    if (bin >= int(nbins)) bin = int(nbins) - 1;

    // Atomic increment
    atomicAdd(out_.bins[uint(bin)], 1u);
}
