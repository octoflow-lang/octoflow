#version 450
// scan_add_offset — Add per-block prefix to scanned blocks (multi-pass fixup)
//
// After scanning blocks independently and scanning block totals,
// this kernel adds the scanned block total to every element in each block.
//
// Block 0: no change (offset = 0)
// Block k: element[i] += scanned_totals[k-1]
//
// 2 bindings (data array, scanned_totals), 1 push constant (n_elements)
layout(local_size_x = 256) in;

layout(set=0, binding=0) buffer Data    { float data[]; } arr;
layout(set=0, binding=1) buffer Offsets { float data[]; } offsets;
layout(push_constant) uniform PC { float n_elements; } pc;

void main() {
    uint gid = gl_GlobalInvocationID.x;
    uint N = uint(pc.n_elements);

    if (gid >= N) return;

    // Scan blocks are 512 elements (256 threads × 2 elements each).
    // Fixup WGs are 256 threads, so gl_WorkGroupID doesn't match scan blocks.
    // Compute scan block index from global ID instead.
    uint scan_block = gid / 512u;
    if (scan_block == 0u) return;  // First scan block needs no offset

    float block_offset = offsets.data[scan_block - 1u];
    arr.data[gid] += block_offset;
}
