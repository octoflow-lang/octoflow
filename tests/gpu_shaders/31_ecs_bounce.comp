#version 450
// ecs_bounce â€” ECS floor collision system (GPU)
//
// Checks if entity Y position is below floor. If so, clamp and reverse velocity.
// Sets grounded flag for entities at rest.
//
// 4 bindings, 2 push constants (floor_y, restitution)
layout(local_size_x = 256) in;

layout(set=0, binding=0) buffer PosY     { float data[]; } pos_y;
layout(set=0, binding=1) buffer VelY     { float data[]; } vel_y;
layout(set=0, binding=2) buffer Active   { float data[]; } alive;
layout(set=0, binding=3) buffer Grounded { float data[]; } grounded;
layout(push_constant) uniform PC {
    float floor_y;
    float restitution;
} pc;

void main() {
    uint i = gl_GlobalInvocationID.x;
    if (alive.data[i] != 1.0) return;

    if (pos_y.data[i] < pc.floor_y) {
        pos_y.data[i] = pc.floor_y;
        vel_y.data[i] = abs(vel_y.data[i]) * pc.restitution;

        // If velocity is very small, mark as grounded
        if (abs(vel_y.data[i]) < 0.01) {
            vel_y.data[i] = 0.0;
            grounded.data[i] = 1.0;
        }
    }
}
