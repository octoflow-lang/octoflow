// test_benchmarks.flow — GPU Performance Benchmark Suite (Phase B6)
// Run: octoflow run tests/audit/test_benchmarks.flow
//
// Benchmarks keystone GPU operations at increasing sizes.
// Uses now_ms() for sub-millisecond timing precision.
// Reports per-operation timings (wall clock, includes upload+dispatch+download).

print("=== GPU PERFORMANCE BENCHMARKS ===")
print(" ")

// ── 1. gpu_fill ────────────────────────────────────────────────
print("--- gpu_fill (allocation + init) ---")

let t0 = now_ms()
let mut i = 0.0
while i < 100.0
  let r = gpu_fill(1.0, 1000.0)
  i = i + 1.0
end
let d = (now_ms() - t0) / 100.0
print("  1K   x100: {d} ms/op")

let t0 = now_ms()
let mut i = 0.0
while i < 50.0
  let r = gpu_fill(1.0, 10000.0)
  i = i + 1.0
end
let d = (now_ms() - t0) / 50.0
print("  10K  x50:  {d} ms/op")

let t0 = now_ms()
let mut i = 0.0
while i < 20.0
  let r = gpu_fill(1.0, 100000.0)
  i = i + 1.0
end
let d = (now_ms() - t0) / 20.0
print("  100K x20:  {d} ms/op")

let t0 = now_ms()
let mut i = 0.0
while i < 5.0
  let r = gpu_fill(1.0, 1000000.0)
  i = i + 1.0
end
let d = (now_ms() - t0) / 5.0
print("  1M   x5:   {d} ms/op")

// ── 2. gpu_add (element-wise binary) ───────────────────────────
print("--- gpu_add (element-wise) ---")

let mut aa = gpu_fill(1.0, 1000.0)
let mut ab = gpu_fill(2.0, 1000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 100.0
  let r = gpu_add(aa, ab)
  i = i + 1.0
end
let d = (now_ms() - t0) / 100.0
print("  1K   x100: {d} ms/op")

let mut aa = gpu_fill(1.0, 100000.0)
let mut ab = gpu_fill(2.0, 100000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 20.0
  let r = gpu_add(aa, ab)
  i = i + 1.0
end
let d = (now_ms() - t0) / 20.0
print("  100K x20:  {d} ms/op")

let mut aa = gpu_fill(1.0, 1000000.0)
let mut ab = gpu_fill(2.0, 1000000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 5.0
  let r = gpu_add(aa, ab)
  i = i + 1.0
end
let d = (now_ms() - t0) / 5.0
print("  1M   x5:   {d} ms/op")

// ── 3. gpu_mul (element-wise binary) ───────────────────────────
print("--- gpu_mul (element-wise) ---")

let mut ma = gpu_fill(3.0, 100000.0)
let mut mb = gpu_fill(4.0, 100000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 20.0
  let r = gpu_mul(ma, mb)
  i = i + 1.0
end
let d = (now_ms() - t0) / 20.0
print("  100K x20:  {d} ms/op")

let mut ma = gpu_fill(3.0, 1000000.0)
let mut mb = gpu_fill(4.0, 1000000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 5.0
  let r = gpu_mul(ma, mb)
  i = i + 1.0
end
let d = (now_ms() - t0) / 5.0
print("  1M   x5:   {d} ms/op")

// ── 4. gpu_abs (unary map) ─────────────────────────────────────
print("--- gpu_abs (unary map) ---")

let mut ua = gpu_fill(-5.0, 100000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 20.0
  let r = gpu_abs(ua)
  i = i + 1.0
end
let d = (now_ms() - t0) / 20.0
print("  100K x20:  {d} ms/op")

let mut ua = gpu_fill(-5.0, 1000000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 5.0
  let r = gpu_abs(ua)
  i = i + 1.0
end
let d = (now_ms() - t0) / 5.0
print("  1M   x5:   {d} ms/op")

// ── 5. gpu_exp (transcendental) ────────────────────────────────
print("--- gpu_exp (transcendental map) ---")

let mut ea = gpu_fill(1.0, 100000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 20.0
  let r = gpu_exp(ea)
  i = i + 1.0
end
let d = (now_ms() - t0) / 20.0
print("  100K x20:  {d} ms/op")

let mut ea = gpu_fill(1.0, 1000000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 5.0
  let r = gpu_exp(ea)
  i = i + 1.0
end
let d = (now_ms() - t0) / 5.0
print("  1M   x5:   {d} ms/op")

// ── 6. gpu_sum (reduction) ─────────────────────────────────────
print("--- gpu_sum (reduction) ---")

let mut sa = gpu_fill(1.0, 1000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 100.0
  let s = gpu_sum(sa)
  i = i + 1.0
end
let d = (now_ms() - t0) / 100.0
print("  1K   x100: {d} ms/op")

let mut sa = gpu_fill(1.0, 100000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 20.0
  let s = gpu_sum(sa)
  i = i + 1.0
end
let d = (now_ms() - t0) / 20.0
print("  100K x20:  {d} ms/op")

let mut sa = gpu_fill(1.0, 1000000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 5.0
  let s = gpu_sum(sa)
  i = i + 1.0
end
let d = (now_ms() - t0) / 5.0
print("  1M   x5:   {d} ms/op")

// ── 7. gpu_cumsum (prefix scan) ────────────────────────────────
print("--- gpu_cumsum (prefix scan) ---")

let mut ca = gpu_fill(1.0, 1000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 50.0
  let r = gpu_cumsum(ca)
  i = i + 1.0
end
let d = (now_ms() - t0) / 50.0
print("  1K   x50:  {d} ms/op")

let mut ca = gpu_fill(1.0, 100000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 10.0
  let r = gpu_cumsum(ca)
  i = i + 1.0
end
let d = (now_ms() - t0) / 10.0
print("  100K x10:  {d} ms/op")

// ── 8. gpu_matmul (N×N dense) ──────────────────────────────────
print("--- gpu_matmul (N×N dense) ---")

let mut xa = gpu_fill(1.0, 1024.0)
let mut xb = gpu_fill(1.0, 1024.0)
let t0 = now_ms()
let mut i = 0.0
while i < 50.0
  let r = gpu_matmul(xa, xb, 32.0, 32.0, 32.0)
  i = i + 1.0
end
let d = (now_ms() - t0) / 50.0
print("  32x32  x50:  {d} ms/op")

let mut xa = gpu_fill(1.0, 16384.0)
let mut xb = gpu_fill(1.0, 16384.0)
let t0 = now_ms()
let mut i = 0.0
while i < 10.0
  let r = gpu_matmul(xa, xb, 128.0, 128.0, 128.0)
  i = i + 1.0
end
let d = (now_ms() - t0) / 10.0
print("  128x128 x10: {d} ms/op")

let mut xa = gpu_fill(1.0, 65536.0)
let mut xb = gpu_fill(1.0, 65536.0)
let t0 = now_ms()
let mut i = 0.0
while i < 3.0
  let r = gpu_matmul(xa, xb, 256.0, 256.0, 256.0)
  i = i + 1.0
end
let d = (now_ms() - t0) / 3.0
print("  256x256 x3:  {d} ms/op")

// ── 9. Dispatch overhead (minimal work) ────────────────────────
print("--- Dispatch overhead (1-element fill) ---")

let t0 = now_ms()
let mut i = 0.0
while i < 200.0
  let r = gpu_fill(0.0, 1.0)
  i = i + 1.0
end
let d = (now_ms() - t0) / 200.0
print("  1-elem x200: {d} ms/dispatch")

// ── 10. Memory throughput estimate ─────────────────────────────
print("--- Memory throughput (gpu_add 1M) ---")
// gpu_add reads 2 arrays + writes 1 = 3M floats = 12 MB
let mut ta = gpu_fill(1.0, 1000000.0)
let mut tb = gpu_fill(2.0, 1000000.0)
let t0 = now_ms()
let mut i = 0.0
while i < 10.0
  let r = gpu_add(ta, tb)
  i = i + 1.0
end
let total_ms = now_ms() - t0
let ms_per = total_ms / 10.0
// 12 MB per op, convert to GB/s
let gb_per_s = 12.0 / ms_per
print("  {ms_per} ms/op, ~{gb_per_s} GB/s effective")

print(" ")
print("=== BENCHMARK COMPLETE ===")
print("Timings = wall clock (upload + Vulkan dispatch + download).")
print("Pipeline compilation cached after first call per op type.")
